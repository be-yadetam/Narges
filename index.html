<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² + Ù¾ÛŒØ§Ù…â€ŒØ±Ø³Ø§Ù†ÛŒ + Ù¾Ù†Ù„ Ù…Ø´Ø§ÙˆØ± (ØªÚ©â€ŒÙØ§ÛŒÙ„) + Ú¯Ø²Ø§Ø±Ø´ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    /* ===============================
       Ù‚Ø³Ù…Øª 1: ØªÙ…ØŒ Ø±ÛŒØ´Ù‡ØŒ Ø±ÛŒØ³Øª
    =============================== */
    :root{
      --bg0:#070b14;
      --bg1:#0b1220;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.11);
      --text:#eaf0ff;
      --muted: rgba(234,240,255,.72);
      --muted2: rgba(234,240,255,.55);
      --shadow: 0 14px 48px rgba(0,0,0,.40);
      --r: 18px;
      --a1:#7c3aed;
      --a2:#06b6d4;
      --a3:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --focus: 0 0 0 4px rgba(6,182,212,.18);
      --grid: rgba(255,255,255,.10);
    }
    [data-theme="light"]{
      --bg0:#f6f8ff;
      --bg1:#eef2ff;
      --card: rgba(0,0,0,.04);
      --stroke: rgba(0,0,0,.09);
      --text:#0b1220;
      --muted: rgba(11,18,32,.72);
      --muted2: rgba(11,18,32,.56);
      --shadow: 0 18px 56px rgba(0,0,0,.12);
      --focus: 0 0 0 4px rgba(124,58,237,.16);
      --grid: rgba(0,0,0,.10);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Vazirmatn", system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(980px 660px at 10% 0%, rgba(124,58,237,.22), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(6,182,212,.18), transparent 55%),
        radial-gradient(800px 560px at 50% 100%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    h1{margin:0; font-size:16px; font-weight:900;}
    label{display:block; font-weight:900; font-size:12px; color:var(--muted2);}

    /* ===============================
       Ù‚Ø³Ù…Øª 2: Ú†ÛŒØ¯Ù…Ø§Ù† Ú©Ù„ÛŒ
    =============================== */
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:16px;
      padding:18px;
      max-width: 1650px;
      margin:0 auto;
    }
    .side,.main{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      backdrop-filter: blur(14px);
      border-radius: calc(var(--r) + 12px);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: 0;
      display:flex;
      flex-direction:column;
    }
    .sideTop,.mainTop{
      padding:14px 14px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sideBody{
      padding: 12px 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:auto;
      min-height: 0;
    }
    .mainBody{
      padding: 14px 16px;
      overflow:auto;
      min-height: 0;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    /* ===============================
       Ù‚Ø³Ù…Øª 3: Drawer Ù…ÙˆØ¨Ø§ÛŒÙ„ (Ú©Ø´ÙˆÛŒÛŒ Ø§Ø² Ø±Ø§Ø³Øª)
    =============================== */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.45);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index: 998;
    }
    body.drawer-open .overlay{
      opacity:1;
      pointer-events:auto;
    }

    .drawerOnly{ display:none; }

    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; padding: 12px; }

      .side{
        position: fixed;
        top: 12px;
        bottom: 12px;
        right: 12px;
        width: min(92vw, 420px);
        transform: translateX(110%);
        transition: transform .22s ease;
        z-index: 999;
      }
      body.drawer-open .side{ transform: translateX(0); }

      .drawerOnly{ display:inline-flex; }
    }

    /* ===============================
       Ù‚Ø³Ù…Øª 4: Ú©Ø§Ù…Ù¾ÙˆÙ†Ù†Øªâ€ŒÙ‡Ø§
    =============================== */
    .brand{display:flex; align-items:center; gap:10px; min-width:0;}
    .logo{
      width:42px; height:42px; border-radius:16px;
      background:
        radial-gradient(16px 16px at 30% 25%, rgba(255,255,255,.35), transparent 60%),
        linear-gradient(135deg, var(--a1), var(--a2));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 14px 26px rgba(6,182,212,.12);
      flex: 0 0 auto;
    }
    .brandText b{display:block;font-weight:900;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .brandText span{display:block;font-size:11px;color:var(--muted2);margin-top:2px}

    .nav{ display:flex; flex-direction:column; gap:8px; }
    .navBtn{
      width:100%;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color: var(--text);
      border-radius: 16px;
      padding: 10px 12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight: 900;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }
    .navBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.18); }
    .navBtn.active{
      background: rgba(6,182,212,.10);
      border-color: rgba(6,182,212,.35);
      box-shadow: 0 0 0 4px rgba(6,182,212,.10), inset 0 1px 0 rgba(255,255,255,.05);
    }
    .navBtn small{ color: var(--muted2); font-weight: 800; }

    .pill,.box{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      border-radius: 18px;
      padding: 12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }
    .boxTitle{
      margin:0 0 10px;
      font-weight: 900;
      font-size: 13px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .row{ display:flex; gap:10px; align-items:center; }
    .grid{ display:grid; gap:14px; }
    .two{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    .three{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:14px; }
    .muted{ color: var(--muted); font-size: 12px; line-height: 1.7; }
    .small{ font-size: 12px; color: var(--muted2); }
    .sep{ height:1px; background: var(--stroke); margin: 6px 0; }

    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:900;
      font-size: 13px;
      user-select:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.18); }
    .btn:active{ transform: translateY(0px) scale(.99); }
    .btn:focus{ outline:none; box-shadow: var(--focus); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(124,58,237,.92), rgba(6,182,212,.86));
      border-color: rgba(255,255,255,.20);
      box-shadow: 0 14px 30px rgba(6,182,212,.14);
    }
    .btn.danger{ background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.30); }
    .btn.ghost{ background: transparent; }

    input[type="week"], input[type="search"], input[type="text"], input[type="number"], textarea, select{
      width:100%;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.12);
      color:var(--text);
      border-radius: 14px;
      padding:10px 12px;
      outline:none;
      transition: box-shadow .12s ease, border-color .12s ease, background .12s ease;
      font-family: inherit;
      font-size: 13px;
    }
    select{ cursor:pointer; }
    [data-theme="light"] input[type="week"],
    [data-theme="light"] input[type="search"],
    [data-theme="light"] input[type="text"],
    [data-theme="light"] input[type="number"],
    [data-theme="light"] textarea,
    [data-theme="light"] select{ background: rgba(255,255,255,.75); }
    input:focus, textarea:focus, select:focus{ box-shadow: var(--focus); border-color: rgba(6,182,212,.35); }
    textarea{ min-height: 130px; resize: vertical; line-height: 1.85; }
    @media (max-width:980px){
      textarea{ min-height: 170px; }
    }

    .badge{
      font-size: 11px;
      color: var(--muted2);
      border:1px solid var(--stroke);
      padding:6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      white-space:nowrap;
      font-weight: 900;
    }

    .clock{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      border-radius: 18px;
      padding: 10px 12px;
    }
    .clockTime{ font-size: 20px; font-weight: 900; letter-spacing: .3px; }
    .clockDate{ margin-top: 4px; color: var(--muted2); font-size: 12px; }

    .weeksList{ display:flex; flex-direction:column; gap:10px; }
    .weekItem{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      padding: 12px 12px;
      border-radius: 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }
    .weekItem:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.18); }
    .weekItem.active{
      border-color: rgba(124,58,237,.42);
      background: rgba(124,58,237,.10);
      box-shadow: 0 0 0 4px rgba(124,58,237,.10), inset 0 1px 0 rgba(255,255,255,.05);
    }
    .weekItem b{ font-size: 13px; font-weight: 900; }
    .weekItem small{ color: var(--muted2); font-weight: 800; }

    .dayTabs{
      display:flex;
      gap:8px;
      padding: 6px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      flex-wrap:wrap;
    }
    .dayBtn{
      border:0;
      cursor:pointer;
      background: transparent;
      color: var(--muted2);
      font-family: inherit;
      font-weight: 900;
      font-size: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      transition: background .12s ease, color .12s ease;
      min-width: 96px;
    }
    .dayBtn.active{
      color: var(--text);
      background: rgba(255,255,255,.08);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
    }
    .dayBtn:focus{ outline:none; box-shadow: var(--focus); }

    /* ===============================
       Ù‚Ø³Ù…Øª 5: ÙØ±Ù… Ù…Ø±ØªØ¨ (Label Ø¨Ø§Ù„Ø§)
    =============================== */
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 0;
    }
    .formGrid{
      display:grid;
      grid-template-columns: 1.2fr 1fr .55fr .55fr .65fr;
      gap:12px;
      align-items:end;
    }
    @media (max-width: 980px){
      .two{ grid-template-columns: 1fr; }
      .three{ grid-template-columns: 1fr; }
      .formGrid{ grid-template-columns: 1fr 1fr; }
    }

    /* ===============================
       Ù‚Ø³Ù…Øª 6: Ù„ÛŒØ³Øª Ø¯Ø±Ø³/Ú©Ø§Ø± (TaskCard Ù…Ø±ØªØ¨)
    =============================== */
    .tasks{ display:flex; flex-direction:column; gap:10px; }
    .taskCard{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      border-radius: 18px;
      overflow:hidden;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }
    .taskTop{ padding: 12px; display:flex; flex-direction:column; gap:12px; }
    .taskRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .taskLeft{ display:flex; align-items:center; gap:10px; flex:1; min-width: 260px; }
    .taskLeft input[type="checkbox"]{ width:18px;height:18px; accent-color: var(--a2); cursor:pointer; }
    .taskTitle{ flex:1; min-width: 240px; }
    .taskTitle input[type="text"]{ font-weight: 900; }

    .controlsGrid{
      display:grid;
      grid-template-columns: 1fr .6fr .6fr .7fr auto;
      gap:12px;
      align-items:end;
    }
    @media (max-width: 980px){
      .taskLeft{ min-width:0; width:100%; }
      .taskTitle{ min-width:0; }
      .controlsGrid{ grid-template-columns: 1fr 1fr; }
    }

    .actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      align-items:center;
      min-width: 92px;
    }

    .taskDetails{ display:none; padding: 12px; border-top: 1px solid var(--stroke); background: rgba(255,255,255,.03); }
    .taskCard.open .taskDetails{ display:block; }
    .taskCard.done .taskTitle input{ text-decoration: line-through; opacity: .85; }

    .iconBtn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      width:40px; height:40px;
      border-radius: 14px;
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      transition: transform .12s ease, background .12s ease;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
      font-weight: 900;
    }
    .iconBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); }
    .iconBtn:active{ transform: translateY(0px) scale(.99); }
    .iconBtn:focus{ outline:none; box-shadow: var(--focus); }

    /* ===============================
       Ù‚Ø³Ù…Øª 7: Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§
    =============================== */
    .chartBox{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 10px;
      height: 320px;
    }
    .chartBox.sm{ height: 260px; }
    .chartBox.lg{ height: 380px; }
    .chartBox.xl{ height: 430px; }

    /* ===============================
       Ù‚Ø³Ù…Øª 7.1: Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…/ÙˆØ±ÙˆØ¯
    =============================== */
    .authOverlay{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 2000;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(14px);
    }
    body.auth-open{ overflow:hidden; }
    body.auth-open .authOverlay{ display:flex; }

    .authCard{
      width: min(96vw, 560px);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border-radius: calc(var(--r) + 14px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .authTop{
      padding: 14px 16px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .authBody{
      padding: 14px 16px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .roleGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 540px){
      .roleGrid{ grid-template-columns: 1fr; }
    }
    .roleBtn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      padding: 12px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:6px;
      font-weight: 900;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }
    .roleBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.18); }
    .roleBtn.active{
      background: rgba(6,182,212,.12);
      border-color: rgba(6,182,212,.35);
      box-shadow: 0 0 0 4px rgba(6,182,212,.10), inset 0 1px 0 rgba(255,255,255,.05);
    }
    .roleBtn small{ color: var(--muted2); font-weight: 800; }

    .toast{
      position: fixed;
      left: 16px;
      bottom: 16px;
      max-width: 520px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      transform: translateY(10px);
      opacity: 0;
      transition: opacity .2s ease, transform .2s ease;
      pointer-events:none;
      z-index: 2100;
      font-size: 13px;
      color: var(--text);
      font-weight: 800;
    }
    [data-theme="light"] .toast{ background: rgba(255,255,255,.88); }
    .toast.show{ opacity: 1; transform: translateY(0px); }

    /* ===============================
       Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯: Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ + Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§
    =============================== */
    .chatWrap{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 12px;
      max-height: 520px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .msg{
      max-width: 92%;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 10px 12px;
      line-height: 1.9;
    }
    .msg.me{
      margin-right:auto;
      background: rgba(6,182,212,.10);
      border-color: rgba(6,182,212,.28);
    }
    .msg.them{
      margin-left:auto;
      background: rgba(124,58,237,.10);
      border-color: rgba(124,58,237,.26);
    }
    .msgMeta{
      margin-top:6px;
      font-size:11px;
      color: var(--muted2);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .fileChip{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      font-size: 11px;
      font-weight: 900;
      color: var(--text);
      text-decoration:none;
    }
    .fileChip:hover{ background: rgba(255,255,255,.08); }
    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <!-- ===============================
       Ù‚Ø³Ù…Øª 0: ÙˆØ±ÙˆØ¯/Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (Ù…Ø´Ø§ÙˆØ±/Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²)
  =============================== -->
  <div class="authOverlay" id="authOverlay">
    <div class="authCard">
      <div class="authTop">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div class="brandText">
            <b>ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</b>
            <span>Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ØŒ Ø¯ÙØ¹Ø§Øª Ø¨Ø¹Ø¯ ÙˆØ±ÙˆØ¯</span>
          </div>
        </div>
        <span class="badge" id="authHint">LocalStorage</span>
      </div>

      <div class="authBody">
        <div class="dayTabs" style="justify-content:space-between;">
          <button class="dayBtn active" id="authModeLogin" type="button">ÙˆØ±ÙˆØ¯</button>
          <button class="dayBtn" id="authModeSignup" type="button">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
        </div>

        <div class="field">
          <label for="authName">Ù†Ø§Ù… (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
          <input id="authName" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¹Ù„ÛŒ / Ù…Ø­Ù…Ø¯ / ..." />
        </div>

        <div class="field">
          <label for="authUsername">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
          <input id="authUsername" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: ali_12" />
        </div>

        <div class="two">
          <div class="field">
            <label for="authPassword">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
            <input id="authPassword" type="text" placeholder="Ø±Ù…Ø²..." />
          </div>
          <div class="field" id="authPassword2Field" style="display:none;">
            <label for="authPassword2">ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø²</label>
            <input id="authPassword2" type="text" placeholder="ØªÚ©Ø±Ø§Ø±..." />
          </div>
        </div>

        <div class="field">
          <label>Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù‚Ø´</label>
          <div class="roleGrid">
            <button class="roleBtn active" id="roleStudent" type="button">
              ğŸ“ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
              <small>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ + Ø«Ø¨Øª Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ + Ù¾ÛŒØ§Ù… Ø¨Ø§ Ù…Ø´Ø§ÙˆØ±</small>
            </button>
            <button class="roleBtn" id="roleCounselor" type="button">
              ğŸ§‘â€ğŸ« Ù…Ø´Ø§ÙˆØ±
              <small>Ù¾Ù†Ù„ Ù…Ø´Ø§ÙˆØ± + Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…/PDF</small>
            </button>
          </div>
        </div>

        <div class="field" id="authMentorCodeField">
          <label for="authMentorCode">Ú©Ø¯ Ù…Ø´Ø§ÙˆØ± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ - Ù…Ø®ØµÙˆØµ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²)</label>
          <input id="authMentorCode" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: CNS-ABC123" />
          <div class="small">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ù‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ù‡Ù… Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ù‡Ù…ÛŒÙ† Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†Ù†Ø¯.</div>
        </div>

        <div class="row" style="justify-content:flex-end; flex-wrap:wrap;">
          <button class="btn primary" id="authContinueBtn" type="button">Ø§Ø¯Ø§Ù…Ù‡</button>
        </div>

        <div class="small" id="authMsg">âš ï¸ Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ ØªÚ©â€ŒÙØ§ÛŒÙ„ Ø§Ø³Øª Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± Ù‡Ù…ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
      </div>
    </div>
  </div>

  <div class="app" id="app" data-theme="dark">

    <!-- Sidebar (Drawer on Mobile) -->
    <aside class="side" id="drawer">
      <div class="sideTop">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div class="brandText">
            <b>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªØ¹Ø§Ù…Ù„ÛŒ</b>
            <span>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²/Ù…Ø´Ø§ÙˆØ± (ØªÚ©â€ŒÙØ§ÛŒÙ„) âœ…</span>
          </div>
        </div>

        <div class="row" style="gap:8px;">
          <button class="btn ghost" id="themeBtn" title="ØªØºÛŒÛŒØ± ØªÙ…">ğŸŒ“</button>
          <button class="btn ghost drawerOnly" id="drawerCloseBtn" title="Ø¨Ø³ØªÙ†">âœ•</button>
        </div>
      </div>

      <div class="sideBody">
        <div class="clock">
          <div class="clockTime" id="clockTime">--:--:--</div>
          <div class="clockDate" id="clockDate">â€”</div>
        </div>

        <div class="nav">
          <button class="navBtn active" id="navDashboard"><span>ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span><small>ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§</small></button>
          <button class="navBtn" id="navWeekly"><span>ğŸ“ Ø¨Ø®Ø´ Ù‡ÙØªÚ¯ÛŒ</span><small>Ú¯Ø²Ø§Ø±Ø´ Ù‡ÙØªÙ‡</small></button>
          <button class="navBtn" id="navDaily"><span>ğŸ“… Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡</span><small>Ø«Ø¨Øª Ø¯Ø±Ø³/Ú©Ø§Ø±</small></button>
          <button class="navBtn" id="navTags"><span>ğŸ·ï¸ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§</span><small>Ø¨Ø§Ù†Ú© Ø¨Ø±Ú†Ø³Ø¨</small></button>

          <!-- Ø¬Ø¯ÛŒØ¯ -->
          <button class="navBtn" id="navMessages"><span>ğŸ’¬ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</span><small>Ù…Ø´Ø§ÙˆØ± â†” Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</small></button>
          <button class="navBtn" id="navCounselor" style="display:none;"><span>ğŸ§‘â€ğŸ« Ù¾Ù†Ù„ Ù…Ø´Ø§ÙˆØ±</span><small>Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</small></button>
        </div>

        <div class="pill" id="weekPill">
          <label for="weekPicker">Ù‡ÙØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡</label>
          <div class="row">
            <input id="weekPicker" type="week" />
            <button class="btn primary" id="newWeekBtn" type="button">â•</button>
          </div>
          <div class="small" style="margin-top:8px;">Ø¨Ø§ Â«+Â» Ù‡ÙØªÙ‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø³Ø§Ø².</div>
        </div>

        <div class="pill" id="searchPill">
          <label for="searchBox">Ø¬Ø³ØªØ¬Ùˆ</label>
          <input id="searchBox" type="search" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø±ÛŒØ§Ø¶ÛŒØŒ ÙÛŒØ²ÛŒÚ©ØŒ Ø¢Ø²Ù…ÙˆÙ†â€¦" />
        </div>

        <!-- Ù¾Ø±ÙˆÙØ§ÛŒÙ„ + Ú©Ø¯ Ù…Ø´Ø§ÙˆØ± -->
        <div class="pill" id="profilePill">
          <div class="boxTitle">
            <span>ğŸ‘¤ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</span>
            <span class="badge" id="profileRoleBadge">â€”</span>
          </div>

          <div class="row" style="justify-content:space-between; flex-wrap:wrap;">
            <span class="badge" id="profileUserBadge">â€”</span>
            <span class="badge" id="profileNameBadge">â€”</span>
          </div>

          <div class="sep"></div>

          <!-- Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² -->
          <div class="field" id="mentorCodeField">
            <label for="mentorCodeInput">Ú©Ø¯ Ù…Ø´Ø§ÙˆØ± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
            <div class="row" style="flex-wrap:wrap;">
              <input id="mentorCodeInput" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: CNS-ABC123" />
              <button class="btn primary" id="mentorCodeSaveBtn" type="button">Ø°Ø®ÛŒØ±Ù‡</button>
              <button class="btn danger" id="mentorCodeClearBtn" type="button" title="Ø®Ø±ÙˆØ¬ Ø§Ø² Ù…Ø´Ø§ÙˆØ±Ù‡">âœ•</button>
            </div>
            <div class="small">Ø¨Ø§ âœ• Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§Ø² Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ø§ÛŒÙ† Ù…Ø´Ø§ÙˆØ±Ù‡ Ø®Ø§Ø±Ø¬ Ø¨Ø´ÛŒ.</div>
          </div>

          <!-- Ù…Ø´Ø§ÙˆØ± -->
          <div class="field hidden" id="counselorCodeField">
            <label>Ú©Ø¯ Ù…Ø´Ø§ÙˆØ±Ù‡ Ø´Ù…Ø§</label>
            <div class="row" style="flex-wrap:wrap;">
              <input id="counselorCodeInput" type="text" readonly />
              <button class="btn" id="copyCounselorCodeBtn" type="button">Ú©Ù¾ÛŒ</button>
            </div>
          </div>

          <div class="sep"></div>
          <button class="btn danger" id="logoutBtn" type="button">Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨</button>
        </div>

        <div class="sep" id="studentSep"></div>
        <div class="weeksList" id="weeksList"></div>

        <div class="row" style="justify-content:space-between; margin-top:6px;" id="studentSideActions1">
          <button class="btn" id="exportBtn" type="button">â¬‡ï¸ Ø®Ø±ÙˆØ¬ÛŒ</button>
          <label class="btn" for="importFile">â¬†ï¸ ÙˆØ±ÙˆØ¯</label>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
        </div>

        <div class="row" style="justify-content:space-between;" id="studentSideActions2">
          <button class="btn ghost" id="printBtn" type="button">ğŸ–¨ï¸ Ù¾Ø±ÛŒÙ†Øª / Ú¯Ø²Ø§Ø±Ø´ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</button>
          <button class="btn danger" id="resetBtn" type="button">ğŸ—‘ï¸ Ø±ÛŒØ³Øª</button>
        </div>

        <div class="small" id="studentStorageHint">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±ÙˆÛŒ Ù‡Ù…ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (LocalStorage).</div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="mainTop">
        <div class="row" style="gap:10px;">
          <button class="btn ghost drawerOnly" id="menuBtn" type="button" title="Ù…Ù†Ùˆ">â˜°</button>
          <h1 id="mainTitle">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</h1>
        </div>
        <div class="row" style="gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <span class="badge" id="currentWeekBadge">â€”</span>
          <span class="badge" id="saveBadge">Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯</span>
        </div>
      </div>

      <div class="mainBody">

        <!-- DASHBOARD -->
        <section id="viewDashboard" class="grid">
          <div class="three">
            <div class="box">
              <div class="boxTitle">
                <span>Ø®Ù„Ø§ØµÙ‡ Ù‡ÙØªÙ‡</span>
                <span class="badge" id="kpiWeek">â€”</span>
              </div>
              <div class="muted" id="kpiSummary">ÛŒÚ© Ù‡ÙØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ØªØ§ ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø¨Ø´Ù‡.</div>
              <div class="sep"></div>
              <div class="row" style="justify-content:space-between; flex-wrap:wrap;">
                <span class="badge" id="kpiStudy">ğŸ“š Ù…Ø·Ø§Ù„Ø¹Ù‡: â€”</span>
                <span class="badge" id="kpiTests">ğŸ§ª ØªØ³Øª: â€”</span>
                <span class="badge" id="kpiTags">ğŸ·ï¸ Ø¨Ø±Ú†Ø³Ø¨: â€”</span>
              </div>
            </div>

            <div class="box">
              <div class="boxTitle">
                <span>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span>
                <span class="badge">LIVE</span>
              </div>
              <div class="two">
                <div class="grid" style="gap:10px;">
                  <label class="small" style="font-weight:900;">Top N Ø¨Ø±Ú†Ø³Ø¨</label>
                  <select id="topTagsN">
                    <option value="5">5</option>
                    <option value="8" selected>8</option>
                    <option value="12">12</option>
                  </select>
                </div>
                <div class="grid" style="gap:10px;">
                  <label class="small" style="font-weight:900;">Ù‡Ø¯Ù Ù…Ø·Ø§Ù„Ø¹Ù‡ (Ø³Ø§Ø¹Øª)</label>
                  <input id="goalStudyHours" type="number" min="0" step="1" placeholder="Ù…Ø«Ù„Ø§Ù‹ 25" />
                  <label class="small" style="font-weight:900;">Ù‡Ø¯Ù ØªØ³Øª</label>
                  <input id="goalTests" type="number" min="0" step="1" placeholder="Ù…Ø«Ù„Ø§Ù‹ 300" />
                </div>
              </div>

              <div class="sep"></div>
              <div class="row" style="justify-content:flex-end; flex-wrap:wrap;">
                <button class="btn primary" id="trendModeStudy" type="button">ğŸ“š Ø±ÙˆÙ†Ø¯ Ù…Ø·Ø§Ù„Ø¹Ù‡</button>
                <button class="btn" id="trendModeTests" type="button">ğŸ§ª Ø±ÙˆÙ†Ø¯ ØªØ³Øª</button>
                <button class="btn" id="rebuildChartsBtn" type="button">ğŸ”„ Ø±ÙØ±Ø´ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§</button>
              </div>
              <div class="small" style="margin-top:8px;">Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„: Ù…Ù†Ùˆ Ú©Ø´ÙˆÛŒÛŒ Ø§Ø² Ø±Ø§Ø³Øª âœ…</div>
            </div>

            <div class="box">
              <div class="boxTitle">
                <span>Ù¾ÛŒØ´Ø±ÙØª Ù†Ø³Ø¨Øª Ø¨Ù‡ Ù‡Ø¯Ù</span>
                <span class="badge" id="progressBadge">â€”</span>
              </div>
              <div class="two">
                <div class="chartBox sm"><canvas id="goalStudyDonut"></canvas></div>
                <div class="chartBox sm"><canvas id="goalTestsDonut"></canvas></div>
              </div>
            </div>
          </div>

          <div class="box">
            <div class="boxTitle">
              <span>ğŸ›ï¸ ØªØ±Ú©ÛŒØ¨ÛŒ: Ù…Ø·Ø§Ù„Ø¹Ù‡ (Ø³ØªÙˆÙ†ÛŒ) + ØªØ³Øª (Ø®Ø·ÛŒ)</span>
              <span class="badge" id="comboKpi">â€”</span>
            </div>
            <div class="chartBox xl"><canvas id="comboDailyChart"></canvas></div>
          </div>

          <div class="two">
            <div class="box">
              <div class="boxTitle"><span>ğŸ“ˆ Ø±ÙˆÙ†Ø¯ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡</span><span class="badge" id="dailyStudyKpi">â€”</span></div>
              <div class="chartBox lg"><canvas id="dailyStudyChart"></canvas></div>
            </div>
            <div class="box">
              <div class="boxTitle"><span>ğŸ§ª Ø±ÙˆÙ†Ø¯ ØªØ³Øª Ø±ÙˆØ²Ø§Ù†Ù‡</span><span class="badge" id="dailyTestsKpi">â€”</span></div>
              <div class="chartBox lg"><canvas id="dailyTestsChart"></canvas></div>
            </div>
          </div>

          <div class="two">
            <div class="box">
              <div class="boxTitle"><span>ğŸ¥§ Ø³Ù‡Ù… Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§</span><span class="badge" id="tagPieKpi">â€”</span></div>
              <div class="chartBox sm"><canvas id="tagPieChart"></canvas></div>
            </div>
            <div class="box">
              <div class="boxTitle"><span>ğŸ© Ø³Ù‡Ù… ØªØ³Øª Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§</span><span class="badge" id="tagTestsDonutKpi">â€”</span></div>
              <div class="chartBox sm"><canvas id="tagTestsDonut"></canvas></div>
            </div>
          </div>

          <!-- âœ… ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ± -->
          <div class="two">
            <div class="box">
              <div class="boxTitle"><span>ğŸ—“ï¸ Ø³Ù‡Ù… Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù‡Ø± Ø±ÙˆØ² Ø§Ø² Ù‡ÙØªÙ‡</span><span class="badge">Donut</span></div>
              <div class="chartBox sm"><canvas id="dayShareStudyDonut"></canvas></div>
            </div>
            <div class="box">
              <div class="boxTitle"><span>ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø³/Ú©Ø§Ø± Ø¯Ø± Ù‡Ø± Ø±ÙˆØ²</span><span class="badge">Bar</span></div>
              <div class="chartBox sm"><canvas id="tasksPerDayBar"></canvas></div>
            </div>
          </div>

          <div class="two">
            <div class="box">
              <div class="boxTitle"><span>âœ… Ù†Ø±Ø® Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù† (Ùª) Ø¯Ø± Ù‡Ø± Ø±ÙˆØ²</span><span class="badge">Line</span></div>
              <div class="chartBox sm"><canvas id="doneRateLine"></canvas></div>
            </div>
            <div class="box">
              <div class="boxTitle"><span>â±ï¸ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¨Ù‡ Ø§Ø²Ø§ÛŒ Ù‡Ø± Ø¯Ø±Ø³/Ú©Ø§Ø±</span><span class="badge">Line</span></div>
              <div class="chartBox sm"><canvas id="avgMinPerTaskLine"></canvas></div>
            </div>
          </div>

          <div class="two">
            <div class="box">
              <div class="boxTitle"><span>ğŸ“ˆ Ù…Ø·Ø§Ù„Ø¹Ù‡ ØªØ¬Ù…Ø¹ÛŒ (Cumulative)</span><span class="badge">Area</span></div>
              <div class="chartBox sm"><canvas id="cumulativeStudyLine"></canvas></div>
            </div>
            <div class="box">
              <div class="boxTitle"><span>ğŸ“ˆ ØªØ³Øª ØªØ¬Ù…Ø¹ÛŒ (Cumulative)</span><span class="badge">Area</span></div>
              <div class="chartBox sm"><canvas id="cumulativeTestsLine"></canvas></div>
            </div>
          </div>

          <div class="two">
            <div class="box">
              <div class="boxTitle"><span>ğŸ¯ Ù¾Ø±Ø§Ú©Ù†Ø¯Ú¯ÛŒ: Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ vs ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øª</span><span class="badge">Scatter</span></div>
              <div class="chartBox sm"><canvas id="studyVsTestsScatter"></canvas></div>
            </div>
            <div class="box">
              <div class="boxTitle"><span>ğŸ§  ØªÙ†ÙˆØ¹ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ Ø¯Ø± Ù‡Ø± Ø±ÙˆØ²</span><span class="badge">Line</span></div>
              <div class="chartBox sm"><canvas id="tagDiversityLine"></canvas></div>
            </div>
          </div>

          <div class="two">
            <div class="box">
              <div class="boxTitle"><span>ğŸ“¦ ØªÙˆØ²ÛŒØ¹ Ù…Ø¯Øª Ù‡Ø± Ø¯Ø±Ø³/Ú©Ø§Ø±</span><span class="badge">Histogram</span></div>
              <div class="chartBox sm"><canvas id="durationHistogramBar"></canvas></div>
            </div>
            <div class="box">
              <div class="boxTitle"><span>âš¡ ØªØ³Øª Ø¨Ù‡ Ø§Ø²Ø§ÛŒ Ù‡Ø± Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ (Ù‡Ø± Ø±ÙˆØ²)</span><span class="badge">Bar</span></div>
              <div class="chartBox sm"><canvas id="testsPerHourBar"></canvas></div>
            </div>
          </div>

          <div class="box">
            <div class="boxTitle"><span>ğŸ·ï¸ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ Ø¯Ø± Ø·ÙˆÙ„ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡ (Stacked)</span><span class="badge">Stacked Bar</span></div>
            <div class="chartBox xl"><canvas id="stackedStudyByTag"></canvas></div>
          </div>

          <div class="box">
            <div class="boxTitle"><span>ğŸ§ª ØªØ³Øª Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ Ø¯Ø± Ø·ÙˆÙ„ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡ (Stacked)</span><span class="badge">Stacked Bar</span></div>
            <div class="chartBox xl"><canvas id="stackedTestsByTag"></canvas></div>
          </div>

          <div class="two">
            <div class="box">
              <div class="boxTitle"><span>ğŸ§­ Ø±Ø§Ø¯Ø§Ø± Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø±ÙˆØ²Ù‡Ø§</span><span class="badge">Radar</span></div>
              <div class="chartBox sm"><canvas id="radarStudyDays"></canvas></div>
            </div>
            <div class="box">
              <div class="boxTitle"><span>ğŸ§­ Ø±Ø§Ø¯Ø§Ø± ØªØ³Øª Ø±ÙˆØ²Ù‡Ø§</span><span class="badge">Radar</span></div>
              <div class="chartBox sm"><canvas id="radarTestsDays"></canvas></div>
            </div>
          </div>

        </section>

        <!-- WEEKLY -->
        <section id="viewWeekly" class="grid" style="display:none;">
          <div class="box">
            <div class="boxTitle"><span>ğŸ“ Ú¯Ø²Ø§Ø±Ø´ Ù‡ÙØªÚ¯ÛŒ</span><span class="badge" id="weeklyStatsBadge">â€”</span></div>

            <div class="two">
              <div class="grid" style="gap:10px;">
                <label class="small" style="font-weight:900;">Ø¹Ù†ÙˆØ§Ù† Ù‡ÙØªÙ‡</label>
                <input id="weekTitle" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù‡ÙØªÙ‡ Ø¢Ø²Ù…ÙˆÙ† + ØªÙ…Ø±Ú©Ø² Ø±ÛŒØ§Ø¶ÛŒ" />
              </div>
              <div class="grid" style="gap:10px;">
                <label class="small" style="font-weight:900;">ØªÚ¯â€ŒÙ‡Ø§ÛŒ Ù‡ÙØªÙ‡ (Ú©Ø§Ù…Ø§)</label>
                <input id="weekTags" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø±ÛŒØ§Ø¶ÛŒ, ÙÛŒØ²ÛŒÚ©, Ø²Ø¨Ø§Ù†" />
                <div class="small">ØªÚ¯â€ŒÙ‡Ø§ÛŒ Ù‡ÙØªÙ‡ Ø¨Ù‡ Ø¨Ø§Ù†Ú© Ø¨Ø±Ú†Ø³Ø¨ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´Ù†.</div>
              </div>
            </div>

            <div class="grid" style="gap:10px; margin-top:10px;">
              <label class="small" style="font-weight:900;">Ø®Ù„Ø§ØµÙ‡ Ù‡ÙØªÙ‡</label>
              <textarea id="weekSummary" placeholder="Ø¬Ù…Ø¹â€ŒØ¨Ù†Ø¯ÛŒ Ú©ÙˆØªØ§Ù‡ Ù‡ÙØªÙ‡..."></textarea>
            </div>

            <div class="two" style="margin-top:10px;">
              <div class="grid" style="gap:10px;">
                <label class="small" style="font-weight:900;">Ø¯Ø³ØªØ§ÙˆØ±Ø¯Ù‡Ø§</label>
                <textarea id="weekAchievements" placeholder="Ú†Ù‡ Ú†ÛŒØ²ÛŒ Ø¨Ù‡ØªØ± Ø´Ø¯ØŸ"></textarea>
              </div>
              <div class="grid" style="gap:10px;">
                <label class="small" style="font-weight:900;">Ú†Ø§Ù„Ø´â€ŒÙ‡Ø§</label>
                <textarea id="weekBlockers" placeholder="Ú†Ù‡ Ú†ÛŒØ²ÛŒ Ø³Ø®Øª Ø¨ÙˆØ¯ØŸ"></textarea>
              </div>
            </div>

            <div class="grid" style="gap:10px; margin-top:10px;">
              <label class="small" style="font-weight:900;">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÙ‡ Ø¨Ø¹Ø¯</label>
              <textarea id="weekNext" placeholder="Ù‡ÙØªÙ‡ Ø¨Ø¹Ø¯ Ø±ÙˆÛŒ Ú†ÛŒ ØªÙ…Ø±Ú©Ø² Ù…ÛŒâ€ŒÚ©Ù†ÛŒØŸ"></textarea>
            </div>
          </div>

          <div class="box">
            <div class="boxTitle">
              <span>âœ… ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ Ù‡ÙØªÚ¯ÛŒ</span>
              <button class="btn primary" id="addWeeklyTask" type="button">â• Ø§ÙØ²ÙˆØ¯Ù†</button>
            </div>
            <div class="small">Ø¯Ø§Ø®Ù„ Ù‡Ø± ØªØ³Ú©: Ø¨Ø±Ú†Ø³Ø¨ + Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ + ØªØ³Øª + ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</div>
            <div class="tasks" id="weeklyTasks"></div>
            <div class="row" style="justify-content:flex-end; flex-wrap:wrap; margin-top:10px;">
              <button class="btn danger" id="deleteWeekBtn" type="button">ğŸ—‘ï¸ Ø­Ø°Ù Ø§ÛŒÙ† Ù‡ÙØªÙ‡</button>
            </div>
          </div>
        </section>

        <!-- DAILY -->
        <section id="viewDaily" class="grid" style="display:none;">
          <div class="box">
            <div class="boxTitle">
              <span>ğŸ“… Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡ (Ø«Ø¨Øª Ù…Ø±ØªØ¨ Ø¯Ø±Ø³/Ú©Ø§Ø±)</span>
              <span class="badge" id="dailyWeekBadge">â€”</span>
            </div>

            <div class="dayTabs" id="dayTabs"></div>

            <div class="two" style="margin-top:10px;">
              <div class="grid" style="gap:10px;">
                <label class="small" style="font-weight:900;">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø±ÙˆØ²</label>
                <textarea id="dayNote" placeholder="Ø§Ù…Ø±ÙˆØ² Ú†ÛŒ Ø´Ø¯ØŸ Ù†Ú©ØªÙ‡â€ŒÙ‡Ø§â€¦"></textarea>
              </div>
              <div class="grid" style="gap:10px;">
                <label class="small" style="font-weight:900;">Ù‡Ø¯Ùâ€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù… Ø§Ù…Ø±ÙˆØ² (Û³ Ù…ÙˆØ±Ø¯)</label>
                <textarea id="dayFocus" placeholder="1) ...&#10;2) ...&#10;3) ..."></textarea>
                <div class="row" style="justify-content:flex-end; flex-wrap:wrap;">
                  <span class="badge" id="dayAutoKpi">ğŸ“š â€” | ğŸ§ª â€” | ğŸ·ï¸ â€”</span>
                </div>
              </div>
            </div>
          </div>

          <!-- ADD LESSON/WORK -->
          <div class="box">
            <div class="boxTitle">
              <span>â• Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø±Ø³/Ú©Ø§Ø± Ø§Ù…Ø±ÙˆØ²</span>
              <button class="btn primary" id="addLessonBtn" type="button">Ø§ÙØ²ÙˆØ¯Ù†</button>
            </div>

            <div class="formGrid">
              <div class="field">
                <label for="lessonTitle">Ø¹Ù†ÙˆØ§Ù† Ø¯Ø±Ø³/Ú©Ø§Ø±</label>
                <input id="lessonTitle" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø±ÛŒØ§Ø¶ÛŒ - Ù…Ø¨Ø­Ø« Ù…Ø¹Ø§Ø¯Ù„Ù‡" />
              </div>

              <div class="field">
                <label for="lessonTag">Ø¨Ø±Ú†Ø³Ø¨</label>
                <select id="lessonTag" data-role="tag-select"></select>
              </div>

              <div class="field">
                <label for="lessonHours">Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡</label>
                <input id="lessonHours" type="number" min="0" step="1" placeholder="0" />
              </div>

              <div class="field">
                <label for="lessonMinutes">Ø¯Ù‚ÛŒÙ‚Ù‡</label>
                <input id="lessonMinutes" type="number" min="0" max="59" step="1" placeholder="0" />
              </div>

              <div class="field">
                <label for="lessonTests">ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øª</label>
                <input id="lessonTests" type="number" min="0" step="1" placeholder="0" />
              </div>
            </div>

            <div class="field" style="margin-top:10px;">
              <label for="lessonNotes">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª/ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
              <textarea id="lessonNotes" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù†Ú©Ø§Øª Ù…Ù‡Ù…ØŒ Ø§Ø´ØªØ¨Ø§Ù‡Ø§ØªØŒ Ú†ÛŒØ²ÛŒ Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ù…Ø±ÙˆØ± Ú©Ù†Ù…â€¦"></textarea>
            </div>

            <div class="small" style="margin-top:8px;">
              Ù†Ú©ØªÙ‡: ÙÙ‚Ø· Ú©Ø§ÙÛŒÙ‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒ Ùˆ Â«Ø§ÙØ²ÙˆØ¯Ù†Â» Ø¨Ø²Ù†ÛŒ âœ…
            </div>
          </div>

          <!-- LIST -->
          <div class="box">
            <div class="boxTitle">
              <span>ğŸ“Œ Ù„ÛŒØ³Øª Ø¯Ø±Ø³/Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</span>
              <span class="badge" id="todayListBadge">â€”</span>
            </div>
            <div class="tasks" id="dailyTasks"></div>
          </div>
        </section>

        <!-- TAGS -->
        <section id="viewTags" class="grid" style="display:none;">
          <div class="box">
            <div class="boxTitle"><span>ğŸ·ï¸ Ø¨Ø§Ù†Ú© Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§</span><span class="badge" id="tagCount">â€”</span></div>

            <div class="row" style="flex-wrap:wrap;">
              <input id="tagBankInput" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø±ÛŒØ§Ø¶ÛŒ, ÙÛŒØ²ÛŒÚ©, Ø²Ø¨Ø§Ù† (Ø¨Ø§ Ú©Ø§Ù…Ø§ Ú†Ù†Ø¯ØªØ§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†)" />
              <button class="btn" id="tagBankAddBtn" type="button">â• Ø§ÙØ²ÙˆØ¯Ù†</button>
              <button class="btn danger" id="tagBankClearBtn" type="button">ğŸ§¹ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ</button>
            </div>

            <div id="tagChips" class="row" style="flex-wrap:wrap; gap:8px; margin-top:10px;"></div>
            <div class="muted">Ø§ÛŒÙ† Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ Ø¯Ø± Dropdown Â«Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø±Ø³/Ú©Ø§Ø±Â» Ùˆ Ø¯Ø§Ø®Ù„ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</div>
          </div>
        </section>

        <!-- MESSAGES (Student) -->
        <section id="viewMessages" class="grid" style="display:none;">
          <div class="box">
            <div class="boxTitle"><span>ğŸ’¬ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</span><span class="badge" id="msgThreadBadge">â€”</span></div>
            <div class="muted" id="msgHint">Ø§Ú¯Ø± Ú©Ø¯ Ù…Ø´Ø§ÙˆØ± Ù†Ø¯Ø§Ø±ÛŒØŒ Ø§Ø² Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± ÙˆØ§Ø±Ø¯ Ú©Ù† ØªØ§ Ú¯ÙØªÚ¯Ùˆ ÙØ¹Ø§Ù„ Ø¨Ø´Ù‡.</div>
            <div class="sep"></div>

            <div class="chatWrap" id="msgList"></div>

            <div class="sep"></div>
            <div class="row" style="gap:10px; flex-wrap:wrap;">
              <input id="msgText" type="text" placeholder="Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ù…Ø´Ø§ÙˆØ±..." />
              <button class="btn primary" id="msgSendBtn" type="button">Ø§Ø±Ø³Ø§Ù„</button>
            </div>
            <div class="small">PDF Ù‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ÛŒ Ù…Ø´Ø§ÙˆØ± Ø¯Ø§Ø®Ù„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
          </div>
        </section>

        <!-- COUNSELOR PANEL -->
        <section id="viewCounselor" class="grid" style="display:none;">
          <div class="two">
            <div class="box">
              <div class="boxTitle"><span>ğŸ§‘â€ğŸ« Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ù…Ù†</span><span class="badge" id="cCodeBadge">Ú©Ø¯: â€”</span></div>
              <div class="muted">Ù‡Ø± Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨Ø§ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Â«Ú©Ø¯ Ù…Ø´Ø§ÙˆØ±Ù‡ Ø´Ù…Ø§Â» Ø¨Ù‡ Ø§ÛŒÙ† Ù„ÛŒØ³Øª Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
              <div class="sep"></div>
              <div class="weeksList" id="cStudentList"></div>
            </div>

            <div class="box">
              <div class="boxTitle"><span>ğŸ’¬ Ú¯ÙØªÚ¯Ùˆ</span><span class="badge" id="cSelectedStudent">â€”</span></div>

              <div class="chatWrap" id="cMsgList"></div>

              <div class="sep"></div>
              <div class="row" style="gap:10px; flex-wrap:wrap;">
                <input id="cMsgText" type="text" placeholder="Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²..." />
                <label class="btn" for="cPdfFile">ğŸ“ PDF</label>
                <input id="cPdfFile" type="file" accept="application/pdf" style="display:none" />
                <button class="btn primary" id="cSendBtn" type="button">Ø§Ø±Ø³Ø§Ù„</button>
              </div>

              <div class="small" id="cPdfHint">ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</div>
            </div>
          </div>
        </section>

      </div>
    </main>

  </div>

  <!-- overlay for drawer -->
  <div class="overlay" id="drawerOverlay"></div>

  <div class="toast" id="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    /* ===============================
       Ù‚Ø³Ù…Øª 8: Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ Ùˆ Ø«Ø§Ø¨Øªâ€ŒÙ‡Ø§
    =============================== */
    let STORAGE_KEY = "student.analytics.drawer.v1"; // per-user ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    const $ = (id) => document.getElementById(id);

    const DAY_ORDER = [
      { key:"sat", name:"Ø´Ù†Ø¨Ù‡" },
      { key:"sun", name:"ÛŒÚ©Ø´Ù†Ø¨Ù‡" },
      { key:"mon", name:"Ø¯ÙˆØ´Ù†Ø¨Ù‡" },
      { key:"tue", name:"Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡" },
      { key:"wed", name:"Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡" },
      { key:"thu", name:"Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡" },
      { key:"fri", name:"Ø¬Ù…Ø¹Ù‡" },
    ];

    const palette = ["#06b6d4","#7c3aed","#22c55e","#f59e0b","#ef4444","#3b82f6","#ec4899","#10b981","#a855f7","#14b8a6","#f97316","#84cc16"];

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 2200);
    }
    function nowISO(){ return new Date().toISOString(); }
    function safeUUID(){
      try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch{}
      return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }
    function clampInt(v, min, max){
      const n = parseInt(v ?? 0, 10);
      if (Number.isNaN(n)) return min;
      return Math.max(min, Math.min(max, n));
    }
    function formatHours(mins){
      const total = Math.max(0, mins|0);
      const h = Math.floor(total / 60);
      const m = total % 60;
      if (h === 0) return `${m} Ø¯Ù‚ÛŒÙ‚Ù‡`;
      if (m === 0) return `${h} Ø³Ø§Ø¹Øª`;
      return `${h}Ø³Ø§Ø¹Øª ${m}Ø¯Ù‚ÛŒÙ‚Ù‡`;
    }
    function normalizeTags(str){
      return (str || "").split(",").map(s => s.trim()).filter(Boolean).slice(0, 200);
    }
    function weekLabel(weekKey){ return weekKey.replace("-W", " / Ù‡ÙØªÙ‡ "); }
    function sortWeeksDesc(keys){ return keys.sort((a,b) => b.localeCompare(a)); }
    function isoWeekKey(date){
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      const ww = String(weekNo).padStart(2,"0");
      return `${d.getUTCFullYear()}-W${ww}`;
    }
    function getDefaultWeek(){ return isoWeekKey(new Date()); }
    function isMobile(){ return window.matchMedia("(max-width: 980px)").matches; }

    /* ===============================
       AUTH + MULTI USER + CHAT (V2)
    =============================== */
    const APP_USERS_KEY   = "student.analytics.users.v1";
    const APP_SESSION_KEY = "student.analytics.session.v1";
    const APP_THREADS_KEY = "student.analytics.threads.v1";

    function readJSON(key, fallback){
      try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }catch{ return fallback; }
    }
    function writeJSON(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
    function normUsername(u){ return String(u||"").trim().toLowerCase(); }

    function genCounselorCode(){
      return "CNS-" + Math.random().toString(36).slice(2,8).toUpperCase();
    }

    function weakHash(str){
      let h = 5381;
      for(let i=0;i<str.length;i++) h = ((h<<5)+h) ^ str.charCodeAt(i);
      return "wh_" + (h>>>0).toString(16);
    }
    async function hashPassword(pw){
      const s = String(pw||"");
      try{
        if(window.crypto && crypto.subtle){
          const enc = new TextEncoder().encode(s);
          const buf = await crypto.subtle.digest("SHA-256", enc);
          const bytes = Array.from(new Uint8Array(buf));
          const b64 = btoa(String.fromCharCode(...bytes));
          return "sha256_" + b64;
        }
      }catch{}
      return weakHash(s);
    }

    function loadUsers(){ return readJSON(APP_USERS_KEY, []); }
    function saveUsers(users){ writeJSON(APP_USERS_KEY, users); }
    function findUser(username){
      const u = normUsername(username);
      return loadUsers().find(x => normUsername(x.username) === u) || null;
    }

    function saveSession(username){ writeJSON(APP_SESSION_KEY, { username: normUsername(username), at: nowISO() }); }
    function loadSession(){ return readJSON(APP_SESSION_KEY, null); }
    function clearSession(){ localStorage.removeItem(APP_SESSION_KEY); }

    function userStateKey(username){
      return "student.analytics.state.v2::" + normUsername(username);
    }

    let threads = readJSON(APP_THREADS_KEY, {});
    function saveThreads(){ writeJSON(APP_THREADS_KEY, threads); }

    function threadKey(counselorCode, studentUsername){
      return "t::" + String(counselorCode||"").trim().toUpperCase() + "::" + normUsername(studentUsername);
    }
    function ensureThread(counselorCode, studentUsername){
      const k = threadKey(counselorCode, studentUsername);
      if(!threads[k]){
        threads[k] = { counselorCode: String(counselorCode||"").trim().toUpperCase(), studentUsername: normUsername(studentUsername), messages: [] };
        saveThreads();
      }
      return threads[k];
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    let activeUser = null; // {username, role, name, mentorCode?, counselorCode?}
    let counselorSelectedStudent = null; // username
    let counselorPendingPdf = null; // {name, dataUrl}

    function openAuth(){ document.body.classList.add("auth-open"); }
    function closeAuth(){ document.body.classList.remove("auth-open"); }

    function applyRoleUI(){
      const role = activeUser?.role || "";
      const isCounselor = role === "counselor";

      $("navCounselor").style.display = isCounselor ? "" : "none";

      // Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒâ€ŒÙ‡Ø§
      $("navDashboard").style.display = isCounselor ? "none" : "";
      $("navWeekly").style.display    = isCounselor ? "none" : "";
      $("navDaily").style.display     = isCounselor ? "none" : "";
      $("navTags").style.display      = isCounselor ? "none" : "";
      $("navMessages").style.display  = isCounselor ? "none" : "";

      // Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØµÙˆØµ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
      $("weekPill").style.display = isCounselor ? "none" : "";
      $("searchPill").style.display = isCounselor ? "none" : "";
      $("weeksList").style.display = isCounselor ? "none" : "";
      $("studentSep").style.display = isCounselor ? "none" : "";
      $("studentSideActions1").style.display = isCounselor ? "none" : "";
      $("studentSideActions2").style.display = isCounselor ? "none" : "";
      $("studentStorageHint").style.display = isCounselor ? "none" : "";

      // Ø¨Ø§Ø¬ Ù‡ÙØªÙ‡ Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§ÙˆØ± Ù…Ø®ÙÛŒ
      $("currentWeekBadge").style.display = isCounselor ? "none" : "";
      $("saveBadge").style.display = isCounselor ? "none" : "";

      // ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
      $("mentorCodeField").classList.toggle("hidden", isCounselor);
      $("counselorCodeField").classList.toggle("hidden", !isCounselor);

      $("profileRoleBadge").textContent = isCounselor ? "Ù…Ø´Ø§ÙˆØ±" : "Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²";
      $("profileUserBadge").textContent = activeUser ? ("@" + activeUser.username) : "â€”";
      $("profileNameBadge").textContent = activeUser?.name ? activeUser.name : "â€”";

      if(isCounselor){
        $("counselorCodeInput").value = activeUser?.counselorCode || "â€”";
        $("cCodeBadge").textContent = "Ú©Ø¯: " + (activeUser?.counselorCode || "â€”");
      }else{
        $("mentorCodeInput").value = activeUser?.mentorCode || "";
      }
    }

    function postMessage({counselorCode, studentUsername, fromRole, fromUser, text, attachments=[]}){
      const th = ensureThread(counselorCode, studentUsername);
      th.messages.push({
        id: safeUUID(),
        fromRole,
        fromUser,
        text: String(text||"").trim(),
        attachments,
        createdAt: nowISO()
      });
      saveThreads();
    }

    function renderStudentMessages(){
      $("msgList").innerHTML = "";
      if(!activeUser || activeUser.role!=="student"){
        $("msgThreadBadge").textContent = "â€”";
        $("msgHint").textContent = "ÙÙ‚Ø· Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø±Ø§ Ø¨Ø¨ÛŒÙ†Ø¯.";
        return;
      }

      const mentorCode = (activeUser?.mentorCode || "").trim().toUpperCase();
      if(!mentorCode){
        $("msgThreadBadge").textContent = "Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙˆØ±";
        $("msgHint").textContent = "Ú©Ø¯ Ù…Ø´Ø§ÙˆØ± Ø±Ø§ Ø§Ø² Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± ÙˆØ§Ø±Ø¯ Ú©Ù† ØªØ§ Ú¯ÙØªÚ¯Ùˆ ÙØ¹Ø§Ù„ Ø´ÙˆØ¯.";
        $("msgList").innerHTML = `<div class="muted">Ù‡Ù†ÙˆØ² Ú¯ÙØªÚ¯Ùˆ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª.</div>`;
        return;
      }

      $("msgThreadBadge").textContent = "Ú©Ø¯: " + mentorCode;
      $("msgHint").textContent = "Ú¯ÙØªÚ¯Ùˆ ÙØ¹Ø§Ù„ Ø§Ø³Øª.";

      const th = ensureThread(mentorCode, activeUser.username);
      if(th.messages.length === 0){
        $("msgList").innerHTML = `<div class="muted">Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ù…ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.</div>`;
        return;
      }

      for(const m of th.messages){
        const who = (m.fromRole === "student") ? "me" : "them";
        const div = document.createElement("div");
        div.className = "msg " + who;

        let filesHtml = "";
        if(Array.isArray(m.attachments) && m.attachments.length){
          filesHtml = `<div class="msgMeta">` + m.attachments.map(a=>{
            const nm = escapeHtml(a.name || "file.pdf");
            return `<a class="fileChip" download="${nm}" href="${a.dataUrl}">ğŸ“ ${nm}</a>`;
          }).join(" ") + `</div>`;
        }

        div.innerHTML = `
          <div>${escapeHtml(m.text || "")}</div>
          ${filesHtml}
          <div class="msgMeta">
            <span>${escapeHtml(m.fromRole === "student" ? "Ø´Ù…Ø§" : "Ù…Ø´Ø§ÙˆØ±")}</span>
            <span>${new Date(m.createdAt).toLocaleString("fa-IR")}</span>
          </div>
        `;
        $("msgList").appendChild(div);
      }

      $("msgList").scrollTop = $("msgList").scrollHeight;
    }

    function renderCounselorChat(){
      $("cMsgList").innerHTML = "";
      const code = (activeUser?.counselorCode || "").trim().toUpperCase();

      if(!counselorSelectedStudent){
        $("cSelectedStudent").textContent = "Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡";
        $("cMsgList").innerHTML = `<div class="muted">ÛŒÚ© Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.</div>`;
        return;
      }

      $("cSelectedStudent").textContent = "@" + counselorSelectedStudent;
      const th = ensureThread(code, counselorSelectedStudent);

      if(th.messages.length===0){
        $("cMsgList").innerHTML = `<div class="muted">Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ù…ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>`;
        return;
      }

      for(const m of th.messages){
        const who = (m.fromRole === "counselor") ? "me" : "them";
        const div = document.createElement("div");
        div.className = "msg " + who;

        let filesHtml = "";
        if(Array.isArray(m.attachments) && m.attachments.length){
          filesHtml = `<div class="msgMeta">` + m.attachments.map(a=>{
            const nm = escapeHtml(a.name || "file.pdf");
            return `<a class="fileChip" download="${nm}" href="${a.dataUrl}">ğŸ“ ${nm}</a>`;
          }).join(" ") + `</div>`;
        }

        div.innerHTML = `
          <div>${escapeHtml(m.text || "")}</div>
          ${filesHtml}
          <div class="msgMeta">
            <span>${escapeHtml(m.fromRole === "counselor" ? "Ø´Ù…Ø§ (Ù…Ø´Ø§ÙˆØ±)" : "Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²")}</span>
            <span>${new Date(m.createdAt).toLocaleString("fa-IR")}</span>
          </div>
        `;
        $("cMsgList").appendChild(div);
      }

      $("cMsgList").scrollTop = $("cMsgList").scrollHeight;
    }

    function renderCounselorStudents(){
      $("cStudentList").innerHTML = "";
      counselorSelectedStudent = counselorSelectedStudent ? normUsername(counselorSelectedStudent) : null;

      if(!activeUser || activeUser.role!=="counselor"){
        $("cStudentList").innerHTML = `<div class="muted">ÙÙ‚Ø· Ù…Ø´Ø§ÙˆØ± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø±Ø§ Ø¨Ø¨ÛŒÙ†Ø¯.</div>`;
        $("cMsgList").innerHTML = `<div class="muted">â€”</div>`;
        return;
      }

      const code = (activeUser?.counselorCode || "").trim().toUpperCase();
      $("cCodeBadge").textContent = "Ú©Ø¯: " + (code || "â€”");

      const users = loadUsers();
      const myStudents = users.filter(u => (u.role==="student") && String(u.mentorCode||"").trim().toUpperCase() === code);

      if(myStudents.length===0){
        $("cStudentList").innerHTML = `<div class="muted">Ù‡Ù†ÙˆØ² Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ Ø¨Ø§ Ú©Ø¯ Ø´Ù…Ø§ ÙˆØµÙ„ Ù†Ø´Ø¯Ù‡.</div>`;
        $("cMsgList").innerHTML = `<div class="muted">ÛŒÚ© Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.</div>`;
        $("cSelectedStudent").textContent = "Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡";
        return;
      }

      for(const st of myStudents){
        const uName = normUsername(st.username);
        const el = document.createElement("div");
        el.className = "weekItem" + (counselorSelectedStudent===uName ? " active" : "");
        const displayName = (st.name||"").trim() || ("@" + uName);
        el.innerHTML = `
          <div style="display:flex; flex-direction:column; gap:2px; min-width:0;">
            <b>${escapeHtml(displayName)}</b>
            <small>@${escapeHtml(uName)}</small>
          </div>
          <span class="badge">ğŸ’¬</span>
        `;
        el.onclick = () => {
          counselorSelectedStudent = uName;
          renderCounselorStudents();
          renderCounselorChat();
        };
        $("cStudentList").appendChild(el);
      }

      if(!counselorSelectedStudent){
        counselorSelectedStudent = normUsername(myStudents[0].username);
      }
      renderCounselorChat();
    }

    /* ===============================
       Ù‚Ø³Ù…Øª 9: Drawer Ú©Ù†ØªØ±Ù„
    =============================== */
    function openDrawer(){ document.body.classList.add("drawer-open"); }
    function closeDrawer(){ document.body.classList.remove("drawer-open"); }
    function closeDrawerIfMobile(){ if(isMobile()) closeDrawer(); }

    /* ===============================
       Ù‚Ø³Ù…Øª 10: Ù…Ø¯Ù„ Ø¯Ø§Ø¯Ù‡ Ù¾Ø§ÛŒØ¯Ø§Ø±
    =============================== */
    function normalizeTaskInPlace(t){
      if(!t || typeof t !== "object") return null;
      if(!t.id) t.id = safeUUID();
      if(t.text == null) t.text = "";
      t.done = !!t.done;
      if(t.tag == null) t.tag = "";
      t.hours   = clampInt(t.hours ?? 0, 0, 9999);
      t.minutes = clampInt(t.minutes ?? 0, 0, 59);
      t.tests   = clampInt(t.tests ?? 0, 0, 999999);
      if(t.notes == null) t.notes = "";
      if(!t.createdAt) t.createdAt = nowISO();
      t.updatedAt = nowISO();
      return t;
    }
    function taskMinutes(t){ return clampInt(t.hours,0,9999)*60 + clampInt(t.minutes,0,59); }

    function normalizeRecordInPlace(r){
      if(!r || typeof r !== "object") return null;
      if(!r.id) r.id = safeUUID();
      if(r.tag == null) r.tag = "";
      r.studyMin = clampInt(r.studyMin ?? 0, 0, 999999);
      r.tests    = clampInt(r.tests ?? 0, 0, 999999);
      if(r.note == null) r.note = "";
      if(!r.createdAt) r.createdAt = nowISO();
      r.updatedAt = nowISO();
      return r;
    }

    function ensureWeekInPlace(state, weekKey){
      if(!state.weeks) state.weeks = {};
      if(!state.weeks[weekKey]){
        state.weeks[weekKey] = {
          week: weekKey,
          title: "",
          tags: [],
          summary: "",
          achievements: "",
          blockers: "",
          next: "",
          weeklyTasks: [],
          days: {},
          createdAt: nowISO(),
          updatedAt: nowISO(),
        };
      }
      const w = state.weeks[weekKey];

      if(!Array.isArray(w.tags)) w.tags = [];
      if(!Array.isArray(w.weeklyTasks)) w.weeklyTasks = [];
      for(let i=0;i<w.weeklyTasks.length;i++){
        if(!w.weeklyTasks[i] || typeof w.weeklyTasks[i] !== "object"){ w.weeklyTasks[i] = { id: safeUUID() }; }
        normalizeTaskInPlace(w.weeklyTasks[i]);
      }

      if(!w.days || typeof w.days !== "object") w.days = {};
      for(const d of DAY_ORDER){
        if(!w.days[d.key]) w.days[d.key] = { note:"", focus:"", tagRecords:[], tasks:[] };
        const day = w.days[d.key];
        if(!Array.isArray(day.tasks)) day.tasks = [];
        for(let i=0;i<day.tasks.length;i++){
          if(!day.tasks[i] || typeof day.tasks[i] !== "object"){ day.tasks[i] = { id: safeUUID() }; }
          normalizeTaskInPlace(day.tasks[i]);
        }

        if(!Array.isArray(day.tagRecords)) day.tagRecords = [];
        if(day.tagRecords.length > 0){
          for(const r0 of day.tagRecords){
            if(!r0 || typeof r0 !== "object") continue;
            normalizeRecordInPlace(r0);
            const h = Math.floor((r0.studyMin||0)/60);
            const m = (r0.studyMin||0)%60;
            const t = {
              id: safeUUID(),
              text: (r0.tag ? `Ø¯Ø±Ø³/Ú©Ø§Ø±: ${r0.tag}` : "Ø¯Ø±Ø³/Ú©Ø§Ø±"),
              done: false,
              tag: r0.tag || "",
              hours: h,
              minutes: m,
              tests: r0.tests || 0,
              notes: r0.note || "",
              createdAt: r0.createdAt || nowISO(),
              updatedAt: nowISO(),
            };
            normalizeTaskInPlace(t);
            day.tasks.push(t);
          }
          day.tagRecords = [];
        }

        if(day.note == null) day.note = "";
        if(day.focus == null) day.focus = "";
      }
      return w;
    }

    function normalizeAllStateInPlace(s){
      if(!s || typeof s !== "object") s = {};
      if(!s.theme) s.theme = "dark";
      if(!Array.isArray(s.tagBank)) s.tagBank = [];
      if(!s.settings) s.settings = { topTagsN: 8, goalStudyMin: 0, goalTests: 0 };
      if(!("topTagsN" in s.settings)) s.settings.topTagsN = 8;
      if(!("goalStudyMin" in s.settings)) s.settings.goalStudyMin = 0;
      if(!("goalTests" in s.settings)) s.settings.goalTests = 0;
      if(!s.weeklyTrendMode) s.weeklyTrendMode = "study";
      if(!s.profile) s.profile = null;
      if(!s.weeks) s.weeks = {};
      for(const wk of Object.keys(s.weeks)){
        ensureWeekInPlace(s, wk);
      }
      return s;
    }

    /* ===============================
       Ù‚Ø³Ù…Øª 11: Ø°Ø®ÛŒØ±Ù‡/Ù„ÙˆØ¯ (Ù¾Ø±-Ú©Ø§Ø±Ø¨Ø±)
    =============================== */
    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return normalizeAllStateInPlace({ theme:"dark", weeks:{}, tagBank:[], weeklyTrendMode:"study", settings:{ topTagsN:8, goalStudyMin:0, goalTests:0 }, profile:null });
        return normalizeAllStateInPlace(JSON.parse(raw));
      }catch{
        return normalizeAllStateInPlace({ theme:"dark", weeks:{}, tagBank:[], weeklyTrendMode:"study", settings:{ topTagsN:8, goalStudyMin:0, goalTests:0 }, profile:null });
      }
    }
    function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function setDirty(on){
      const sb = $("saveBadge");
      sb.textContent = on ? "Ø°Ø®ÛŒØ±Ù‡..." : "Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯";
      sb.style.borderColor = on ? "rgba(245,158,11,.35)" : "";
    }

    // state Ø§ÙˆÙ„ÛŒÙ‡
    let state = normalizeAllStateInPlace({ theme:"dark", weeks:{}, tagBank:[], weeklyTrendMode:"study", settings:{ topTagsN:8, goalStudyMin:0, goalTests:0 }, profile:null });
    let currentWeek = "";
    let currentDayKey = "sat";

    // âœ… Ø¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´: Ø¢Ø®Ø±ÛŒÙ† ØªØ¨ ÙØ¹Ø§Ù„
    let activeNav = "dashboard";

    /* ===============================
       Ù‚Ø³Ù…Øª 12: Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§
    =============================== */
    function addTagsToBank(tags){
      const arr = Array.isArray(tags) ? tags : normalizeTags(tags);
      let changed = false;
      for(const t of arr){
        const v = (t||"").trim();
        if(!v) continue;
        if(!state.tagBank.some(x => x.toLowerCase() === v.toLowerCase())){
          state.tagBank.push(v);
          changed = true;
        }
      }
      if(changed) persist();
      return changed;
    }
    function populateTagSelect(selectEl, current){
      const v = current || "";
      selectEl.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "ğŸ·ï¸ Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø±Ú†Ø³Ø¨...";
      selectEl.appendChild(opt0);
      for(const tag of state.tagBank){
        const o = document.createElement("option");
        o.value = tag;
        o.textContent = "ğŸ·ï¸ " + tag;
        selectEl.appendChild(o);
      }
      selectEl.value = v;
    }
    function refreshAllTagSelects(){
      document.querySelectorAll("select[data-role='tag-select']").forEach(sel => {
        const cur = sel.value;
        populateTagSelect(sel, cur);
      });
    }

    /* ===============================
       Ù‚Ø³Ù…Øª 13: Ù…Ø­Ø§Ø³Ø¨Ø§Øª
    =============================== */
    function computeDayTotals(w, dayKey){
      const d = w.days[dayKey];
      let studyMin = 0, tests = 0;
      const tagsSet = new Set();
      for(const t of d.tasks){
        studyMin += taskMinutes(t);
        tests += clampInt(t.tests,0,999999);
        if(t.tag) tagsSet.add(t.tag.toLowerCase());
      }
      return { studyMin, tests, tags: tagsSet.size };
    }
    function computeWeekTotals(w){
      let studyMin = 0, tests = 0;
      const tags = new Set();
      for(const d of DAY_ORDER){
        const dt = computeDayTotals(w, d.key);
        studyMin += dt.studyMin; tests += dt.tests;
        for(const t of w.days[d.key].tasks){ if(t.tag) tags.add(t.tag.toLowerCase()); }
      }
      for(const t of w.weeklyTasks){
        studyMin += taskMinutes(t);
        tests += clampInt(t.tests,0,999999);
        if(t.tag) tags.add(t.tag.toLowerCase());
      }
      return { studyMin, tests, tags: tags.size };
    }

    function computeTagAggregatesForWeek(w){
      const byTagStudy = new Map();
      const byTagTests = new Map();
      const add = (tag, mins, tests)=>{
        const t = (tag||"").trim() || "Ø¨Ø¯ÙˆÙ† Ø¨Ø±Ú†Ø³Ø¨";
        byTagStudy.set(t, (byTagStudy.get(t)||0) + (mins||0));
        byTagTests.set(t, (byTagTests.get(t)||0) + (tests||0));
      };
      for(const d of DAY_ORDER){
        const day=w.days[d.key];
        for(const t of day.tasks) add(t.tag, taskMinutes(t), clampInt(t.tests,0,999999));
      }
      for(const t of w.weeklyTasks) add(t.tag, taskMinutes(t), clampInt(t.tests,0,999999));

      const entriesStudy = Array.from(byTagStudy.entries()).sort((a,b)=>b[1]-a[1]);
      const entriesTests = Array.from(byTagTests.entries()).sort((a,b)=>b[1]-a[1]);
      const totalStudy = entriesStudy.reduce((a,[,v])=>a+v,0);
      const totalTests = entriesTests.reduce((a,[,v])=>a+v,0);
      return { entriesStudy, entriesTests, totalStudy, totalTests };
    }

    /* ===============================
       Ù‚Ø³Ù…Øª 14: Flush Ù‚Ø·Ø¹ÛŒ
    =============================== */
    function flushAll(){
      if(!currentWeek || !state.weeks[currentWeek]) return;

      const w = state.weeks[currentWeek];
      const day = w.days[currentDayKey];

      day.note = $("dayNote").value || "";
      day.focus = $("dayFocus").value || "";

      w.title = $("weekTitle").value || "";
      w.tags = normalizeTags($("weekTags").value || "");
      w.summary = $("weekSummary").value || "";
      w.achievements = $("weekAchievements").value || "";
      w.blockers = $("weekBlockers").value || "";
      w.next = $("weekNext").value || "";
      w.updatedAt = nowISO();

      addTagsToBank(w.tags);
      persist();
      setDirty(false);
    }

    /* ===============================
       Ù‚Ø³Ù…Øª 15: Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ù‡ÙØªÙ‡â€ŒÙ‡Ø§
    =============================== */
    function renderWeeksList(filterText=""){
      const keys = sortWeeksDesc(Object.keys(state.weeks||{}));
      const list = $("weeksList");
      list.innerHTML = "";
      const q = (filterText||"").trim().toLowerCase();

      const filtered = keys.filter(k=>{
        if(!q) return true;
        const w = state.weeks[k];
        const hay = [
          k, w.title, (w.tags||[]).join(","), w.summary,
          (w.weeklyTasks||[]).map(t=>`${t.text} ${t.tag} ${t.notes}`).join(" "),
          ...DAY_ORDER.map(d=>w.days[d.key].tasks.map(t=>`${t.text} ${t.tag} ${t.notes}`).join(" ")),
        ].join(" ").toLowerCase();
        return hay.includes(q);
      });

      if(filtered.length===0){
        list.innerHTML = `<div class="muted">${q ? "Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯." : "Ù‡Ù†ÙˆØ² Ú¯Ø²Ø§Ø±Ø´ÛŒ Ù†Ø¯Ø§Ø±ÛŒ. Ø±ÙˆÛŒ + Ø¨Ø²Ù†."}</div>`;
        return;
      }

      for(const k of filtered){
        const w = state.weeks[k];
        const totals = computeWeekTotals(w);
        const el = document.createElement("div");
        el.className = "weekItem" + (k===currentWeek ? " active" : "");
        el.onclick = () => selectWeek(k);

        const title = (w.title||"").trim() || "Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†";
        el.innerHTML = `
          <div style="display:flex; flex-direction:column; gap:2px; min-width:0;">
            <b>${escapeHtml(title)}</b>
            <small>${escapeHtml(weekLabel(k))}</small>
          </div>
          <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end;">
            <span class="badge">ğŸ“š ${escapeHtml(formatHours(totals.studyMin))}</span>
            <span class="badge">ğŸ§ª ${totals.tests}</span>
          </div>
        `;
        list.appendChild(el);
      }
    }

    /* ===============================
       Ù‚Ø³Ù…Øª 16: Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡
    =============================== */
    function renderDayTabs(){
      const tabs = $("dayTabs");
      tabs.innerHTML = "";
      for(const d of DAY_ORDER){
        const b = document.createElement("button");
        b.type = "button";
        b.className = "dayBtn" + (d.key===currentDayKey ? " active" : "");
        b.textContent = d.name;
        b.onclick = () => {
          flushAll();
          currentDayKey = d.key;
          renderDayTabs();
          loadDayToUI(d.key);
          toast("Ø±ÙˆØ² ØªØºÛŒÛŒØ± Ú©Ø±Ø¯ Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…");
        };
        tabs.appendChild(b);
      }
    }

    /* ===============================
       Ù‚Ø³Ù…Øª 17: Ø³Ø§Ø®Øª TaskCard Ù…Ø±ØªØ¨
    =============================== */
    function makeField(labelText, inputEl){
      const wrap = document.createElement("div");
      wrap.className = "field";
      const lab = document.createElement("label");
      lab.textContent = labelText;
      wrap.appendChild(lab);
      wrap.appendChild(inputEl);
      return wrap;
    }

    function createTaskCard(task, onAnyChange, onDelete){
      const card = document.createElement("div");
      card.className = "taskCard" + (task.done ? " done" : "");

      const top = document.createElement("div");
      top.className = "taskTop";

      const row1 = document.createElement("div");
      row1.className = "taskRow";

      const left = document.createElement("div");
      left.className = "taskLeft";

      const cb = document.createElement("input");
      cb.type="checkbox";
      cb.checked = !!task.done;
      cb.onchange = () => { task.done = cb.checked; task.updatedAt = nowISO(); card.classList.toggle("done", task.done); onAnyChange(); };

      const titleBox = document.createElement("div");
      titleBox.className = "taskTitle";
      const ti = document.createElement("input");
      ti.type="text";
      ti.value = task.text || "";
      ti.placeholder = "Ø¹Ù†ÙˆØ§Ù† Ø¯Ø±Ø³/Ú©Ø§Ø±â€¦";
      ti.oninput = () => { task.text = ti.value; task.updatedAt = nowISO(); onAnyChange(); };
      titleBox.appendChild(ti);

      left.appendChild(cb);
      left.appendChild(titleBox);
      row1.appendChild(left);

      const controls = document.createElement("div");
      controls.className = "controlsGrid";

      const tagSelect = document.createElement("select");
      tagSelect.dataset.role="tag-select";
      populateTagSelect(tagSelect, task.tag);
      tagSelect.onchange = () => { task.tag = tagSelect.value; task.updatedAt = nowISO(); onAnyChange(); };

      const hIn = document.createElement("input");
      hIn.type="number"; hIn.min="0"; hIn.step="1";
      hIn.value = String(task.hours ?? 0);
      hIn.oninput = () => { task.hours = clampInt(hIn.value,0,9999); task.updatedAt = nowISO(); onAnyChange(); };

      const mIn = document.createElement("input");
      mIn.type="number"; mIn.min="0"; mIn.max="59"; mIn.step="1";
      mIn.value = String(task.minutes ?? 0);
      mIn.oninput = () => { task.minutes = clampInt(mIn.value,0,59); task.updatedAt = nowISO(); onAnyChange(); };

      const tIn = document.createElement("input");
      tIn.type="number"; tIn.min="0"; tIn.step="1";
      tIn.value = String(task.tests ?? 0);
      tIn.oninput = () => { task.tests = clampInt(tIn.value,0,999999); task.updatedAt = nowISO(); onAnyChange(); };

      const actions = document.createElement("div");
      actions.className="actions";

      const toggle = document.createElement("button");
      toggle.type="button";
      toggle.className="iconBtn";
      toggle.title="ÛŒØ§Ø¯Ø¯Ø§Ø´Øª";
      toggle.textContent="ğŸ“";
      toggle.onclick = () => { card.classList.toggle("open"); onAnyChange(); };

      const del = document.createElement("button");
      del.type="button";
      del.className="iconBtn";
      del.title="Ø­Ø°Ù";
      del.textContent="âœ–ï¸";
      del.onclick = () => {
        if(!confirm("Ø§ÛŒÙ† Ø¢ÛŒØªÙ… Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) return;
        onDelete();
        card.remove();
        onAnyChange();
      };

      actions.appendChild(toggle);
      actions.appendChild(del);

      controls.appendChild(makeField("Ø¨Ø±Ú†Ø³Ø¨", tagSelect));
      controls.appendChild(makeField("Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡", hIn));
      controls.appendChild(makeField("Ø¯Ù‚ÛŒÙ‚Ù‡", mIn));
      controls.appendChild(makeField("ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øª", tIn));
      controls.appendChild(actions);

      const details = document.createElement("div");
      details.className="taskDetails";
      const ta = document.createElement("textarea");
      ta.placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øª/ØªÙˆØ¶ÛŒØ­Ø§Øªâ€¦";
      ta.value = task.notes || "";
      ta.oninput = () => { task.notes = ta.value; task.updatedAt = nowISO(); onAnyChange(); };
      details.appendChild(ta);

      top.appendChild(row1);
      top.appendChild(controls);

      card.appendChild(top);
      card.appendChild(details);

      return card;
    }

    /* ===============================
       Ù‚Ø³Ù…Øª 18: Ø±Ù†Ø¯Ø± ØªØ³Ú©â€ŒÙ‡Ø§
    =============================== */
    function renderWeeklyTasks(){
      const w = state.weeks[currentWeek];
      const wrap = $("weeklyTasks");
      wrap.innerHTML = "";

      if(w.weeklyTasks.length===0){
        wrap.innerHTML = `<div class="muted">ØªØ³Ú© Ù‡ÙØªÚ¯ÛŒ Ù†Ø¯Ø§Ø±ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒÙ‡).</div>`;
        return;
      }
      for(const t of w.weeklyTasks){
        const card = createTaskCard(
          t,
          () => {
            setDirty(true);
            w.updatedAt = nowISO();
            persist();
            updateEverything(true);
            setDirty(false);
          },
          () => { w.weeklyTasks = w.weeklyTasks.filter(x => x.id !== t.id); w.updatedAt=nowISO(); persist(); }
        );
        wrap.appendChild(card);
      }
      refreshAllTagSelects();
    }

    function renderDailyTasks(){
      const w = state.weeks[currentWeek];
      const d = w.days[currentDayKey];
      const wrap = $("dailyTasks");
      wrap.innerHTML = "";

      const dt = computeDayTotals(w, currentDayKey);
      $("todayListBadge").textContent = `ğŸ“š ${formatHours(dt.studyMin)} â€¢ ğŸ§ª ${dt.tests}`;

      if(d.tasks.length===0){
        wrap.innerHTML = `<div class="muted">Ù‡Ù†ÙˆØ² Ú†ÛŒØ²ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯ÛŒ. Ø§Ø² Ø¨Ø®Ø´ Â«Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø±Ø³/Ú©Ø§Ø± Ø§Ù…Ø±ÙˆØ²Â» Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù† âœ…</div>`;
        return;
      }
      for(const t of d.tasks){
        const card = createTaskCard(
          t,
          () => {
            setDirty(true);
            w.updatedAt = nowISO();
            persist();
            updateEverything(true);
            setDirty(false);
          },
          () => { d.tasks = d.tasks.filter(x => x.id !== t.id); w.updatedAt=nowISO(); persist(); }
        );
        wrap.appendChild(card);
      }
      refreshAllTagSelects();
    }

    /* ===============================
       Ù‚Ø³Ù…Øª 19: Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ UI
    =============================== */
    function renderTagBank(){
      const chips = $("tagChips");
      chips.innerHTML = "";
      $("tagCount").textContent = `ØªØ¹Ø¯Ø§Ø¯: ${state.tagBank.length}`;

      if(state.tagBank.length===0){
        chips.innerHTML = `<span class="muted">Ù‡Ù†ÙˆØ² Ø¨Ø±Ú†Ø³Ø¨ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯ÛŒ.</span>`;
        return;
      }

      for(const t of state.tagBank){
        const chip = document.createElement("span");
        chip.className="badge";
        chip.style.display="inline-flex";
        chip.style.alignItems="center";
        chip.style.gap="8px";
        chip.innerHTML = `ğŸ·ï¸ ${escapeHtml(t)} <span style="cursor:pointer;border:1px solid var(--stroke);padding:2px 8px;border-radius:999px;">Ã—</span>`;
        chip.querySelector("span").onclick = () => {
          if(!confirm("Ø§ÛŒÙ† Ø¨Ø±Ú†Ø³Ø¨ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) return;
          state.tagBank = state.tagBank.filter(x => x.toLowerCase() !== t.toLowerCase());
          for(const wk of Object.keys(state.weeks)){
            const w = state.weeks[wk];
            for(const tt of w.weeklyTasks){ if((tt.tag||"").toLowerCase()===t.toLowerCase()) tt.tag=""; }
            for(const d of DAY_ORDER){
              for(const ts of w.days[d.key].tasks){ if((ts.tag||"").toLowerCase()===t.toLowerCase()) ts.tag=""; }
            }
          }
          persist();
          renderTagBank();
          refreshAllTagSelects();
          updateEverything(true);
          toast("Ø¨Ø±Ú†Ø³Ø¨ Ø­Ø°Ù Ø´Ø¯");
        };
        chips.appendChild(chip);
      }
    }

    /* ===============================
       Ù‚Ø³Ù…Øª 20: KPI Ù‡Ø§
    =============================== */
    function updateDayAutoKpi(){
      if(!currentWeek || !state.weeks[currentWeek]){
        $("dayAutoKpi").textContent = "ğŸ“š â€” | ğŸ§ª â€” | ğŸ·ï¸ â€”";
        return;
      }
      const w = state.weeks[currentWeek];
      const dt = computeDayTotals(w, currentDayKey);
      $("dayAutoKpi").textContent = `ğŸ“š ${formatHours(dt.studyMin)} | ğŸ§ª ${dt.tests} | ğŸ·ï¸ ${dt.tags}`;
    }

    function updateKpis(){
      if(!currentWeek || !state.weeks[currentWeek]){
        $("kpiWeek").textContent = "â€”";
        $("kpiSummary").textContent = "ÛŒÚ© Ù‡ÙØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ØªØ§ ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø¨Ø´Ù‡.";
        $("kpiStudy").textContent = "ğŸ“š Ù…Ø·Ø§Ù„Ø¹Ù‡: â€”";
        $("kpiTests").textContent = "ğŸ§ª ØªØ³Øª: â€”";
        $("kpiTags").textContent = "ğŸ·ï¸ Ø¨Ø±Ú†Ø³Ø¨: â€”";
        $("weeklyStatsBadge").textContent = "â€”";
        $("progressBadge").textContent = "â€”";
        return;
      }
      const w = state.weeks[currentWeek];
      const totals = computeWeekTotals(w);

      $("kpiWeek").textContent = weekLabel(w.week);
      $("kpiSummary").textContent = (w.summary||"").trim() ? w.summary.trim() : "Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù‡ÙØªÙ‡ Ø®Ù„Ø§ØµÙ‡â€ŒØ§ÛŒ Ù†Ù†ÙˆØ´ØªÛŒ.";
      $("kpiStudy").textContent = `ğŸ“š Ù…Ø·Ø§Ù„Ø¹Ù‡: ${formatHours(totals.studyMin)}`;
      $("kpiTests").textContent = `ğŸ§ª ØªØ³Øª: ${totals.tests}`;
      $("kpiTags").textContent = `ğŸ·ï¸ Ø¨Ø±Ú†Ø³Ø¨: ${totals.tags}`;
      $("weeklyStatsBadge").textContent = `ğŸ“š ${formatHours(totals.studyMin)} â€¢ ğŸ§ª ${totals.tests} â€¢ ğŸ·ï¸ ${totals.tags}`;

      const gs = clampInt(state.settings.goalStudyMin,0,9999999);
      const gt = clampInt(state.settings.goalTests,0,999999999);
      if(gs || gt){
        const ps = gs ? Math.min(100, Math.round((totals.studyMin/gs)*100)) : 0;
        const pt = gt ? Math.min(100, Math.round((totals.tests/gt)*100)) : 0;
        $("progressBadge").textContent = `Ù…Ø·Ø§Ù„Ø¹Ù‡: ${gs?ps:"â€”"}% â€¢ ØªØ³Øª: ${gt?pt:"â€”"}%`;
      }else{
        $("progressBadge").textContent = "Ù‡Ø¯Ù ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡";
      }
    }

    function updateEverything(updateChartsAlso=false){
      updateKpis();
      updateDayAutoKpi();
      if(updateChartsAlso) updateCharts();
    }

    /* ===============================
       Ù‚Ø³Ù…Øª 21: Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ (Ø¨Ø³ÛŒØ§Ø± Ø¨ÛŒØ´ØªØ±)
    =============================== */
    let charts = {
      goalStudy:null, goalTests:null, combo:null, dailyStudy:null, dailyTests:null, tagPie:null, tagTestsDonut:null,
      dayShareStudyDonut:null,
      tasksPerDayBar:null,
      doneRateLine:null,
      avgMinPerTaskLine:null,
      cumulativeStudyLine:null,
      cumulativeTestsLine:null,
      studyVsTestsScatter:null,
      tagDiversityLine:null,
      durationHistogramBar:null,
      testsPerHourBar:null,
      stackedStudyByTag:null,
      stackedTestsByTag:null,
      radarStudyDays:null,
      radarTestsDays:null
    };

    function destroyChart(c){ if(c && typeof c.destroy==="function") c.destroy(); }
    function destroyAllCharts(){ for(const k of Object.keys(charts)){ destroyChart(charts[k]); charts[k]=null; } }
    function setChartDefaults(){
      if(typeof Chart === "undefined") return;
      const isDark = (state.theme||"dark")==="dark";
      const text = isDark ? "#eaf0ff" : "#0b1220";
      const grid = isDark ? "rgba(255,255,255,.10)" : "rgba(0,0,0,.10)";
      Chart.defaults.color = text;
      Chart.defaults.borderColor = grid;
      Chart.defaults.plugins.legend.labels.color = text;
      Chart.defaults.scale.grid.color = grid;
      Chart.defaults.scale.ticks.color = text;
    }

    function getDailySeries(){
      if(!currentWeek || !state.weeks[currentWeek]) return null;
      const w = state.weeks[currentWeek];
      const labels = DAY_ORDER.map(d=>d.name);
      const studyHours=[], tests=[];
      for(const d of DAY_ORDER){
        const dt = computeDayTotals(w, d.key);
        studyHours.push(dt.studyMin/60);
        tests.push(dt.tests);
      }
      const totalStudyMin = Math.round(studyHours.reduce((a,b)=>a+b,0)*60);
      const totalTests = tests.reduce((a,b)=>a+b,0);
      return { labels, studyHours, tests, totalStudyMin, totalTests };
    }

    function getDailyAdvanced(){
      if(!currentWeek || !state.weeks[currentWeek]) return null;
      const w = state.weeks[currentWeek];

      const labels = DAY_ORDER.map(d=>d.name);
      const studyMin = [];
      const tests = [];
      const tasksCount = [];
      const doneRate = [];
      const avgMinPerTask = [];
      const tagDiversity = [];
      const testsPerHour = [];

      let cumStudy = 0;
      let cumTests = 0;
      const cumulativeStudy = [];
      const cumulativeTests = [];

      for(const d of DAY_ORDER){
        const day = w.days[d.key];
        const dt = computeDayTotals(w, d.key);

        const cnt = day.tasks.length;
        const done = day.tasks.filter(x=>!!x.done).length;
        const uniqTags = new Set(day.tasks.map(x=>(x.tag||"").trim().toLowerCase()).filter(Boolean));

        const hours = dt.studyMin / 60;

        studyMin.push(dt.studyMin);
        tests.push(dt.tests);
        tasksCount.push(cnt);
        doneRate.push(cnt ? Math.round((done/cnt)*100) : 0);
        avgMinPerTask.push(cnt ? Math.round(dt.studyMin/cnt) : 0);
        tagDiversity.push(uniqTags.size);
        testsPerHour.push(hours>0 ? Math.round(dt.tests / hours) : 0);

        cumStudy += dt.studyMin;
        cumTests += dt.tests;
        cumulativeStudy.push(cumStudy/60);
        cumulativeTests.push(cumTests);
      }

      const scatterPoints = DAY_ORDER.map((d, i)=>({
        x: Math.round((studyMin[i]/60)*10)/10,
        y: tests[i],
        r: Math.max(4, Math.min(10, tasksCount[i] || 0))
      }));

      const allTasks = [];
      for(const d of DAY_ORDER){
        allTasks.push(...w.days[d.key].tasks);
      }
      allTasks.push(...(w.weeklyTasks||[]));
      const bins = [
        { label:"0-30", min:0, max:30 },
        { label:"31-60", min:31, max:60 },
        { label:"61-90", min:61, max:90 },
        { label:"91-120", min:91, max:120 },
        { label:"121+", min:121, max:1e9 }
      ];
      const hist = bins.map(b=>0);
      for(const t of allTasks){
        const m = taskMinutes(t);
        for(let i=0;i<bins.length;i++){
          if(m>=bins[i].min && m<=bins[i].max){
            hist[i]++; break;
          }
        }
      }

      return {
        labels,
        studyHours: studyMin.map(x=>x/60),
        studyMin,
        tests,
        tasksCount,
        doneRate,
        avgMinPerTask,
        tagDiversity,
        testsPerHour,
        cumulativeStudy,
        cumulativeTests,
        scatterPoints,
        histLabels: bins.map(b=>b.label),
        histCounts: hist
      };
    }

    function buildStackedByTag(w, mode="study", topN=8){
      const agg = computeTagAggregatesForWeek(w);
      const entries = (mode==="tests" ? agg.entriesTests : agg.entriesStudy);
      const top = entries.slice(0, topN).map(([tag])=>tag);

      const dayMap = DAY_ORDER.map(d=>{
        const map = new Map();
        for(const t of w.days[d.key].tasks){
          const tag = (t.tag||"").trim() || "Ø¨Ø¯ÙˆÙ† Ø¨Ø±Ú†Ø³Ø¨";
          const val = mode==="tests" ? clampInt(t.tests,0,999999) : taskMinutes(t);
          map.set(tag, (map.get(tag)||0) + val);
        }
        return map;
      });

      const datasets = top.map((tag, idx)=>{
        const data = dayMap.map(m=>m.get(tag)||0);
        return {
          label: tag,
          data,
          backgroundColor: palette[idx % palette.length] + "AA",
          borderColor: palette[idx % palette.length],
          borderWidth: 1
        };
      });

      return {
        labels: DAY_ORDER.map(d=>d.name),
        datasets
      };
    }

    function updateCharts(forceRebuild=false){
      if(typeof Chart==="undefined") return;
      setChartDefaults();
      if(forceRebuild) destroyAllCharts();

      const daily = getDailySeries();
      if(daily){
        if(!charts.combo){
          charts.combo = new Chart(document.getElementById("comboDailyChart"), {
            data: {
              labels: daily.labels,
              datasets: [
                { type:"bar", label:"Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡", data: daily.studyHours, yAxisID:"y1",
                  backgroundColor:"rgba(124,58,237,.55)", borderColor:"rgba(124,58,237,.85)", borderWidth:1
                },
                { type:"line", label:"ØªØ³Øª", data: daily.tests, yAxisID:"y2",
                  tension:.35, fill:false, borderColor:"rgba(6,182,212,.95)", pointRadius:3
                }
              ]
            },
            options:{
              responsive:true, maintainAspectRatio:false,
              plugins:{ legend:{ position:"bottom" } },
              scales:{
                y1:{ beginAtZero:true, position:"right", title:{ display:true, text:"Ø³Ø§Ø¹Øª" } },
                y2:{ beginAtZero:true, position:"left", title:{ display:true, text:"ØªØ³Øª" }, grid:{ drawOnChartArea:false } },
              }
            }
          });
        }else{
          charts.combo.data.labels = daily.labels;
          charts.combo.data.datasets[0].data = daily.studyHours;
          charts.combo.data.datasets[1].data = daily.tests;
          charts.combo.update();
        }

        if(!charts.dailyStudy){
          charts.dailyStudy = new Chart(document.getElementById("dailyStudyChart"), {
            type:"line",
            data:{ labels: daily.labels, datasets:[{ label:"Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡", data: daily.studyHours, tension:.35, fill:true, borderWidth:2, pointRadius:3 }]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } } }
          });
        }else{
          charts.dailyStudy.data.labels = daily.labels;
          charts.dailyStudy.data.datasets[0].data = daily.studyHours;
          charts.dailyStudy.update();
        }

        if(!charts.dailyTests){
          charts.dailyTests = new Chart(document.getElementById("dailyTestsChart"), {
            type:"line",
            data:{ labels: daily.labels, datasets:[{ label:"ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øª", data: daily.tests, tension:.35, fill:true, borderWidth:2, pointRadius:3 }]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } } }
          });
        }else{
          charts.dailyTests.data.labels = daily.labels;
          charts.dailyTests.data.datasets[0].data = daily.tests;
          charts.dailyTests.update();
        }
      }

      if(currentWeek && state.weeks[currentWeek]){
        const w = state.weeks[currentWeek];
        const agg = computeTagAggregatesForWeek(w);
        const topN = clampInt(state.settings.topTagsN, 3, 20);

        const topStudy = agg.entriesStudy.slice(0, topN);
        const otherStudy = agg.entriesStudy.slice(topN).reduce((a,[,v])=>a+v,0);
        const labelsStudy = topStudy.map(([k])=>k).concat(otherStudy?["Ø³Ø§ÛŒØ±"]:[]);
        const valuesStudy = topStudy.map(([,v])=>v).concat(otherStudy?[otherStudy]:[]);
        const colorsStudy = labelsStudy.map((_,i)=>palette[i%palette.length]);

        if(!charts.tagPie){
          charts.tagPie = new Chart(document.getElementById("tagPieChart"), { type:"pie",
            data:{ labels: labelsStudy, datasets:[{ data: valuesStudy, backgroundColor: colorsStudy }]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } } }
          });
        }else{
          charts.tagPie.data.labels = labelsStudy;
          charts.tagPie.data.datasets[0].data = valuesStudy;
          charts.tagPie.data.datasets[0].backgroundColor = colorsStudy;
          charts.tagPie.update();
        }

        const topTests = agg.entriesTests.slice(0, topN);
        const otherTests = agg.entriesTests.slice(topN).reduce((a,[,v])=>a+v,0);
        const labelsTests = topTests.map(([k])=>k).concat(otherTests?["Ø³Ø§ÛŒØ±"]:[]);
        const valuesTests = topTests.map(([,v])=>v).concat(otherTests?[otherTests]:[]);
        const colorsTests = labelsTests.map((_,i)=>palette[(i+3)%palette.length]);

        if(!charts.tagTestsDonut){
          charts.tagTestsDonut = new Chart(document.getElementById("tagTestsDonut"), { type:"doughnut",
            data:{ labels: labelsTests, datasets:[{ data: valuesTests, backgroundColor: colorsTests }]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } } }
          });
        }else{
          charts.tagTestsDonut.data.labels = labelsTests;
          charts.tagTestsDonut.data.datasets[0].data = valuesTests;
          charts.tagTestsDonut.data.datasets[0].backgroundColor = colorsTests;
          charts.tagTestsDonut.update();
        }
      }

      if(currentWeek && state.weeks[currentWeek]){
        const w = state.weeks[currentWeek];
        const totals = computeWeekTotals(w);
        const gs = clampInt(state.settings.goalStudyMin,0,9999999);
        const gt = clampInt(state.settings.goalTests,0,999999999);

        const studyDone = totals.studyMin;
        const studyRem = Math.max(0, gs - studyDone);
        const testsDone = totals.tests;
        const testsRem = Math.max(0, gt - testsDone);

        if(!charts.goalStudy){
          charts.goalStudy = new Chart(document.getElementById("goalStudyDonut"), { type:"doughnut",
            data:{ labels:["Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡","Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡"], datasets:[{ data:[studyDone, studyRem], backgroundColor:["rgba(34,197,94,.75)","rgba(255,255,255,.12)"] }]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } } }
          });
        }else{
          charts.goalStudy.data.datasets[0].data = [studyDone, studyRem];
          charts.goalStudy.update();
        }

        if(!charts.goalTests){
          charts.goalTests = new Chart(document.getElementById("goalTestsDonut"), { type:"doughnut",
            data:{ labels:["Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡","Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡"], datasets:[{ data:[testsDone, testsRem], backgroundColor:["rgba(6,182,212,.80)","rgba(255,255,255,.12)"] }]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } } }
          });
        }else{
          charts.goalTests.data.datasets[0].data = [testsDone, testsRem];
          charts.goalTests.update();
        }
      }

      const adv = getDailyAdvanced();
      if(adv && currentWeek && state.weeks[currentWeek]){
        const w = state.weeks[currentWeek];

        if(!charts.dayShareStudyDonut){
          charts.dayShareStudyDonut = new Chart(document.getElementById("dayShareStudyDonut"), {
            type:"doughnut",
            data:{ labels: adv.labels, datasets:[{ data: adv.studyMin, backgroundColor: adv.labels.map((_,i)=>palette[i%palette.length]) }]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } } }
          });
        }else{
          charts.dayShareStudyDonut.data.labels = adv.labels;
          charts.dayShareStudyDonut.data.datasets[0].data = adv.studyMin;
          charts.dayShareStudyDonut.update();
        }

        if(!charts.tasksPerDayBar){
          charts.tasksPerDayBar = new Chart(document.getElementById("tasksPerDayBar"), {
            type:"bar",
            data:{ labels: adv.labels, datasets:[{ label:"ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø³/Ú©Ø§Ø±", data: adv.tasksCount }]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } }, scales:{ y:{ beginAtZero:true } } }
          });
        }else{
          charts.tasksPerDayBar.data.labels = adv.labels;
          charts.tasksPerDayBar.data.datasets[0].data = adv.tasksCount;
          charts.tasksPerDayBar.update();
        }

        if(!charts.doneRateLine){
          charts.doneRateLine = new Chart(document.getElementById("doneRateLine"), {
            type:"line",
            data:{ labels: adv.labels, datasets:[{ label:"Ùª Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡", data: adv.doneRate, tension:.35, fill:true, borderWidth:2, pointRadius:3 }]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } }, scales:{ y:{ beginAtZero:true, max:100 } } }
          });
        }else{
          charts.doneRateLine.data.labels = adv.labels;
          charts.doneRateLine.data.datasets[0].data = adv.doneRate;
          charts.doneRateLine.update();
        }

        if(!charts.avgMinPerTaskLine){
          charts.avgMinPerTaskLine = new Chart(document.getElementById("avgMinPerTaskLine"), {
            type:"line",
            data:{ labels: adv.labels, datasets:[{ label:"Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ù‚ÛŒÙ‚Ù‡", data: adv.avgMinPerTask, tension:.35, fill:true, borderWidth:2, pointRadius:3 }]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } }, scales:{ y:{ beginAtZero:true } } }
          });
        }else{
          charts.avgMinPerTaskLine.data.labels = adv.labels;
          charts.avgMinPerTaskLine.data.datasets[0].data = adv.avgMinPerTask;
          charts.avgMinPerTaskLine.update();
        }

        if(!charts.cumulativeStudyLine){
          charts.cumulativeStudyLine = new Chart(document.getElementById("cumulativeStudyLine"), {
            type:"line",
            data:{ labels: adv.labels, datasets:[{ label:"Ø³Ø§Ø¹Øª ØªØ¬Ù…Ø¹ÛŒ", data: adv.cumulativeStudy, tension:.35, fill:true, borderWidth:2, pointRadius:3 }]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } }, scales:{ y:{ beginAtZero:true } } }
          });
        }else{
          charts.cumulativeStudyLine.data.labels = adv.labels;
          charts.cumulativeStudyLine.data.datasets[0].data = adv.cumulativeStudy;
          charts.cumulativeStudyLine.update();
        }

        if(!charts.cumulativeTestsLine){
          charts.cumulativeTestsLine = new Chart(document.getElementById("cumulativeTestsLine"), {
            type:"line",
            data:{ labels: adv.labels, datasets:[{ label:"ØªØ³Øª ØªØ¬Ù…Ø¹ÛŒ", data: adv.cumulativeTests, tension:.35, fill:true, borderWidth:2, pointRadius:3 }]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } }, scales:{ y:{ beginAtZero:true } } }
          });
        }else{
          charts.cumulativeTestsLine.data.labels = adv.labels;
          charts.cumulativeTestsLine.data.datasets[0].data = adv.cumulativeTests;
          charts.cumulativeTestsLine.update();
        }

        if(!charts.studyVsTestsScatter){
          charts.studyVsTestsScatter = new Chart(document.getElementById("studyVsTestsScatter"), {
            type:"scatter",
            data:{ datasets:[{ label:"Ø±ÙˆØ²Ù‡Ø§", data: adv.scatterPoints, pointRadius:4 }]},
            options:{
              responsive:true, maintainAspectRatio:false,
              plugins:{ legend:{ position:"bottom" } },
              scales:{
                x:{ title:{ display:true, text:"Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡" }, beginAtZero:true },
                y:{ title:{ display:true, text:"ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øª" }, beginAtZero:true }
              }
            }
          });
        }else{
          charts.studyVsTestsScatter.data.datasets[0].data = adv.scatterPoints;
          charts.studyVsTestsScatter.update();
        }

        if(!charts.tagDiversityLine){
          charts.tagDiversityLine = new Chart(document.getElementById("tagDiversityLine"), {
            type:"line",
            data:{ labels: adv.labels, datasets:[{ label:"ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø±Ú†Ø³Ø¨ ÛŒÚ©ØªØ§", data: adv.tagDiversity, tension:.35, fill:true, borderWidth:2, pointRadius:3 }]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } }, scales:{ y:{ beginAtZero:true } } }
          });
        }else{
          charts.tagDiversityLine.data.labels = adv.labels;
          charts.tagDiversityLine.data.datasets[0].data = adv.tagDiversity;
          charts.tagDiversityLine.update();
        }

        if(!charts.durationHistogramBar){
          charts.durationHistogramBar = new Chart(document.getElementById("durationHistogramBar"), {
            type:"bar",
            data:{ labels: adv.histLabels, datasets:[{ label:"ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø³/Ú©Ø§Ø±", data: adv.histCounts }]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } }, scales:{ y:{ beginAtZero:true } } }
          });
        }else{
          charts.durationHistogramBar.data.labels = adv.histLabels;
          charts.durationHistogramBar.data.datasets[0].data = adv.histCounts;
          charts.durationHistogramBar.update();
        }

        if(!charts.testsPerHourBar){
          charts.testsPerHourBar = new Chart(document.getElementById("testsPerHourBar"), {
            type:"bar",
            data:{ labels: adv.labels, datasets:[{ label:"ØªØ³Øª/Ø³Ø§Ø¹Øª", data: adv.testsPerHour }]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } }, scales:{ y:{ beginAtZero:true } } }
          });
        }else{
          charts.testsPerHourBar.data.labels = adv.labels;
          charts.testsPerHourBar.data.datasets[0].data = adv.testsPerHour;
          charts.testsPerHourBar.update();
        }

        const stackedStudy = buildStackedByTag(w, "study", clampInt(state.settings.topTagsN,3,20));
        if(!charts.stackedStudyByTag){
          charts.stackedStudyByTag = new Chart(document.getElementById("stackedStudyByTag"), {
            type:"bar",
            data: stackedStudy,
            options:{
              responsive:true, maintainAspectRatio:false,
              plugins:{ legend:{ position:"bottom" } },
              scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true, title:{ display:true, text:"Ø¯Ù‚ÛŒÙ‚Ù‡" } } }
            }
          });
        }else{
          charts.stackedStudyByTag.data.labels = stackedStudy.labels;
          charts.stackedStudyByTag.data.datasets = stackedStudy.datasets;
          charts.stackedStudyByTag.update();
        }

        const stackedTests = buildStackedByTag(w, "tests", clampInt(state.settings.topTagsN,3,20));
        if(!charts.stackedTestsByTag){
          charts.stackedTestsByTag = new Chart(document.getElementById("stackedTestsByTag"), {
            type:"bar",
            data: stackedTests,
            options:{
              responsive:true, maintainAspectRatio:false,
              plugins:{ legend:{ position:"bottom" } },
              scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true, title:{ display:true, text:"ØªØ³Øª" } } }
            }
          });
        }else{
          charts.stackedTestsByTag.data.labels = stackedTests.labels;
          charts.stackedTestsByTag.data.datasets = stackedTests.datasets;
          charts.stackedTestsByTag.update();
        }

        if(!charts.radarStudyDays){
          charts.radarStudyDays = new Chart(document.getElementById("radarStudyDays"), {
            type:"radar",
            data:{ labels: adv.labels, datasets:[{ label:"Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡", data: adv.studyHours, borderWidth:2, pointRadius:3 }]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } } }
          });
        }else{
          charts.radarStudyDays.data.labels = adv.labels;
          charts.radarStudyDays.data.datasets[0].data = adv.studyHours;
          charts.radarStudyDays.update();
        }

        if(!charts.radarTestsDays){
          charts.radarTestsDays = new Chart(document.getElementById("radarTestsDays"), {
            type:"radar",
            data:{ labels: adv.labels, datasets:[{ label:"ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øª", data: adv.tests, borderWidth:2, pointRadius:3 }]},
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } } }
          });
        }else{
          charts.radarTestsDays.data.labels = adv.labels;
          charts.radarTestsDays.data.datasets[0].data = adv.tests;
          charts.radarTestsDays.update();
        }
      }
    }

    /* ===============================
       Ù‚Ø³Ù…Øª 22: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø±ÙˆØ²/Ù‡ÙØªÙ‡
    =============================== */
    function loadDayToUI(dayKey){
      const w = state.weeks[currentWeek];
      const day = w.days[dayKey];

      $("dayNote").value = day.note || "";
      $("dayFocus").value = day.focus || "";

      renderDailyTasks();
      updateDayAutoKpi();
      updateEverything(true);

      populateTagSelect($("lessonTag"), $("lessonTag").value || "");
    }

    function selectWeek(weekKey){
      flushAll();
      ensureWeekInPlace(state, weekKey);
      persist();

      currentWeek = weekKey;
      $("weekPicker").value = weekKey;
      $("currentWeekBadge").textContent = weekLabel(weekKey);
      $("dailyWeekBadge").textContent = weekLabel(weekKey);

      const w = state.weeks[weekKey];

      $("weekTitle").value = w.title || "";
      $("weekTags").value = (w.tags||[]).join(", ");
      $("weekSummary").value = w.summary || "";
      $("weekAchievements").value = w.achievements || "";
      $("weekBlockers").value = w.blockers || "";
      $("weekNext").value = w.next || "";

      addTagsToBank(w.tags || []);
      renderTagBank();

      $("topTagsN").value = String(state.settings.topTagsN || 8);
      $("goalStudyHours").value = state.settings.goalStudyMin ? String(Math.round(state.settings.goalStudyMin/60)) : "";
      $("goalTests").value = state.settings.goalTests ? String(state.settings.goalTests) : "";

      renderWeeksList($("searchBox").value);
      renderDayTabs();
      loadDayToUI(currentDayKey);
      renderWeeklyTasks();

      updateEverything(true);
      setDirty(false);

      closeDrawerIfMobile();
    }

    function createNewWeek(weekKey){
      ensureWeekInPlace(state, weekKey);
      persist();
      selectWeek(weekKey);
      toast("Ù‡ÙØªÙ‡ Ø¬Ø¯ÛŒØ¯ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯");
    }

    /* ===============================
       Ù‚Ø³Ù…Øª 23: Ù†Ø§ÙˆØ¨Ø±ÛŒ
    =============================== */
    function setNav(active){
      // âœ… Ø¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ
      activeNav = active;

      const btns = [
        [$("navDashboard"), "dashboard"],
        [$("navWeekly"), "weekly"],
        [$("navDaily"), "daily"],
        [$("navTags"), "tags"],
        [$("navMessages"), "messages"],
        [$("navCounselor"), "counselor"],
      ];
      for(const [b,k] of btns){
        if(!b) continue;
        b.classList.toggle("active", k===active);
      }

      $("viewDashboard").style.display = active==="dashboard" ? "" : "none";
      $("viewWeekly").style.display    = active==="weekly" ? "" : "none";
      $("viewDaily").style.display     = active==="daily" ? "" : "none";
      $("viewTags").style.display      = active==="tags" ? "" : "none";
      $("viewMessages").style.display  = active==="messages" ? "" : "none";
      $("viewCounselor").style.display = active==="counselor" ? "" : "none";

      $("mainTitle").textContent =
        active==="dashboard" ? "ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯" :
        active==="weekly"    ? "ğŸ“ Ø¨Ø®Ø´ Ù‡ÙØªÚ¯ÛŒ" :
        active==="daily"     ? "ğŸ“… Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡" :
        active==="tags"      ? "ğŸ·ï¸ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§" :
        active==="messages"  ? "ğŸ’¬ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§" :
        "ğŸ§‘â€ğŸ« Ù¾Ù†Ù„ Ù…Ø´Ø§ÙˆØ±";

      if(active==="dashboard"){
        requestAnimationFrame(()=>{ updateCharts(true); });
      }
      if(active==="messages") renderStudentMessages();
      if(active==="counselor") renderCounselorStudents();

      closeDrawerIfMobile();
    }

    /* ===============================
       Ù‚Ø³Ù…Øª 24: Ø®Ø±ÙˆØ¬ÛŒ/ÙˆØ±ÙˆØ¯ÛŒ/Ø±ÛŒØ³Øª
    =============================== */
    function exportJSON(){
      flushAll();

      const mode = prompt(
        "Ù†ÙˆØ¹ Ø®Ø±ÙˆØ¬ÛŒ:\n1) Ø¨Ú©Ø§Ù¾ Ú©Ø§Ù…Ù„ JSON\n2) Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ø§Ø²Ù‡â€ŒØ§ÛŒ JSON (Ù‡ÙØªÙ‡ ØªØ§ Ù‡ÙØªÙ‡)\n3) Ú¯Ø²Ø§Ø±Ø´ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ (Ù¾Ø±ÛŒÙ†Øª / PDF)\nØ¹Ø¯Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†:",
        "1"
      );

      if(mode === "3"){
        openReportWizard(false);
        return;
      }

      if(mode === "2"){
        const from = prompt("Ø§Ø² Ù‡ÙØªÙ‡ (YYYY-W##):", currentWeek || getDefaultWeek());
        const to   = prompt("ØªØ§ Ù‡ÙØªÙ‡ (YYYY-W##):", currentWeek || getDefaultWeek());
        if(!from || !to) return;

        const keysAsc = Object.keys(state.weeks||{}).sort((a,b)=>a.localeCompare(b));
        const f = from.trim();
        const t = to.trim();
        const selected = keysAsc.filter(k => k >= f && k <= t);

        const payload = {
          meta: { exportedAt: nowISO(), username: activeUser?.username || "", role: activeUser?.role || "", from: f, to: t },
          state: { ...state, weeks: Object.fromEntries(selected.map(k => [k, state.weeks[k]])) }
        };

        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `student-report-${f}-to-${t}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        toast("Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ø§Ø²Ù‡â€ŒØ§ÛŒ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯ âœ…");
        return;
      }

      const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "student-analytics-backup.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯");
    }

    function importJSON(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const incoming = JSON.parse(reader.result);
          // Ø§Ú¯Ø± Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ø§Ø²Ù‡â€ŒØ§ÛŒ Ø¨Ø§Ø´Ø¯ (payload.state)
          const s = incoming && incoming.state ? incoming.state : incoming;
          state = normalizeAllStateInPlace(s);
          persist();
          setTheme(state.theme || "dark");
          renderTagBank();
          renderWeeksList($("searchBox").value);

          const keys = sortWeeksDesc(Object.keys(state.weeks||{}));
          if(keys[0]) selectWeek(keys[0]);
          else createNewWeek(getDefaultWeek());
          toast("ÙˆØ±ÙˆØ¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯");
        }catch{
          alert("ÙØ§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.");
        }
      };
      reader.readAsText(file);
    }

    /* ===============================
       âœ… REPORT / PRINT (Professional)
    =============================== */

    const REPORT_CHARTS = {
      summary: [
        { id:"goalStudyDonut", title:"Ù¾ÛŒØ´Ø±ÙØª Ù‡Ø¯Ù Ù…Ø·Ø§Ù„Ø¹Ù‡" },
        { id:"goalTestsDonut", title:"Ù¾ÛŒØ´Ø±ÙØª Ù‡Ø¯Ù ØªØ³Øª" },
        { id:"comboDailyChart", title:"ØªØ±Ú©ÛŒØ¨ÛŒ: Ù…Ø·Ø§Ù„Ø¹Ù‡ (Ø³ØªÙˆÙ†ÛŒ) + ØªØ³Øª (Ø®Ø·ÛŒ)" },
        { id:"dailyStudyChart", title:"Ø±ÙˆÙ†Ø¯ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡" },
        { id:"dailyTestsChart", title:"Ø±ÙˆÙ†Ø¯ ØªØ³Øª Ø±ÙˆØ²Ø§Ù†Ù‡" },
        { id:"tagPieChart", title:"Ø³Ù‡Ù… Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§" },
        { id:"tagTestsDonut", title:"Ø³Ù‡Ù… ØªØ³Øª Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§" },
        { id:"tasksPerDayBar", title:"ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø³/Ú©Ø§Ø± Ø¯Ø± Ù‡Ø± Ø±ÙˆØ²" },
        { id:"doneRateLine", title:"Ù†Ø±Ø® Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù† (Ùª) Ø¯Ø± Ù‡Ø± Ø±ÙˆØ²" },
        { id:"testsPerHourBar", title:"ØªØ³Øª Ø¨Ù‡ Ø§Ø²Ø§ÛŒ Ù‡Ø± Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡" },
      ],
      full: [
        { id:"goalStudyDonut", title:"Ù¾ÛŒØ´Ø±ÙØª Ù‡Ø¯Ù Ù…Ø·Ø§Ù„Ø¹Ù‡" },
        { id:"goalTestsDonut", title:"Ù¾ÛŒØ´Ø±ÙØª Ù‡Ø¯Ù ØªØ³Øª" },
        { id:"comboDailyChart", title:"ØªØ±Ú©ÛŒØ¨ÛŒ: Ù…Ø·Ø§Ù„Ø¹Ù‡ (Ø³ØªÙˆÙ†ÛŒ) + ØªØ³Øª (Ø®Ø·ÛŒ)" },
        { id:"dailyStudyChart", title:"Ø±ÙˆÙ†Ø¯ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡" },
        { id:"dailyTestsChart", title:"Ø±ÙˆÙ†Ø¯ ØªØ³Øª Ø±ÙˆØ²Ø§Ù†Ù‡" },
        { id:"tagPieChart", title:"Ø³Ù‡Ù… Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§" },
        { id:"tagTestsDonut", title:"Ø³Ù‡Ù… ØªØ³Øª Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§" },
        { id:"dayShareStudyDonut", title:"Ø³Ù‡Ù… Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù‡Ø± Ø±ÙˆØ² Ø§Ø² Ù‡ÙØªÙ‡" },
        { id:"tasksPerDayBar", title:"ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø³/Ú©Ø§Ø± Ø¯Ø± Ù‡Ø± Ø±ÙˆØ²" },
        { id:"doneRateLine", title:"Ù†Ø±Ø® Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù† (Ùª) Ø¯Ø± Ù‡Ø± Ø±ÙˆØ²" },
        { id:"avgMinPerTaskLine", title:"Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¨Ù‡ Ø§Ø²Ø§ÛŒ Ù‡Ø± Ø¯Ø±Ø³/Ú©Ø§Ø±" },
        { id:"cumulativeStudyLine", title:"Ù…Ø·Ø§Ù„Ø¹Ù‡ ØªØ¬Ù…Ø¹ÛŒ" },
        { id:"cumulativeTestsLine", title:"ØªØ³Øª ØªØ¬Ù…Ø¹ÛŒ" },
        { id:"studyVsTestsScatter", title:"Ù¾Ø±Ø§Ú©Ù†Ø¯Ú¯ÛŒ: Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ vs ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øª" },
        { id:"tagDiversityLine", title:"ØªÙ†ÙˆØ¹ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ Ø¯Ø± Ù‡Ø± Ø±ÙˆØ²" },
        { id:"durationHistogramBar", title:"ØªÙˆØ²ÛŒØ¹ Ù…Ø¯Øª Ù‡Ø± Ø¯Ø±Ø³/Ú©Ø§Ø±" },
        { id:"testsPerHourBar", title:"ØªØ³Øª Ø¨Ù‡ Ø§Ø²Ø§ÛŒ Ù‡Ø± Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡" },
        { id:"stackedStudyByTag", title:"Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ Ø¯Ø± Ø·ÙˆÙ„ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡ (Stacked)" },
        { id:"stackedTestsByTag", title:"ØªØ³Øª Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ Ø¯Ø± Ø·ÙˆÙ„ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡ (Stacked)" },
        { id:"radarStudyDays", title:"Ø±Ø§Ø¯Ø§Ø± Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø±ÙˆØ²Ù‡Ø§" },
        { id:"radarTestsDays", title:"Ø±Ø§Ø¯Ø§Ø± ØªØ³Øª Ø±ÙˆØ²Ù‡Ø§" },
      ]
    };

    function fmtFa(n){
      const x = Number(n || 0);
      try{ return x.toLocaleString("fa-IR"); }catch{ return String(x); }
    }
    function fmtDT(iso){
      try{ return new Date(iso).toLocaleString("fa-IR"); }catch{ return String(iso||""); }
    }
    function nl2brSafe(s){
      return escapeHtml(String(s||"")).replaceAll("\n","<br>");
    }
    function pct(a,b){
      if(!b) return "â€”";
      return Math.min(100, Math.round((a/b)*100)) + "%";
    }
    function safeWeekTitle(w){
      const t = (w.title||"").trim();
      return t ? t : "Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†";
    }

    function waitFrames(n=2){
      return new Promise((resolve)=>{
        let i=0;
        const tick=()=>{ i++; if(i>=n) resolve(); else requestAnimationFrame(tick); };
        requestAnimationFrame(tick);
      });
    }

    async function ensureChartsForCapture(){
      if(typeof Chart === "undefined") return;

      const prev = activeNav || "dashboard";
      setNav("dashboard");

      const prevAnim = Chart.defaults.animation;
      Chart.defaults.animation = false;

      updateCharts(true);
      await waitFrames(3);

      Chart.defaults.animation = prevAnim;
      setNav(prev);
    }

    function captureCharts(level="summary"){
      const picked = REPORT_CHARTS[level] || REPORT_CHARTS.summary;
      const out = [];
      for(const ch of picked){
        const canvas = document.getElementById(ch.id);
        if(!canvas || !canvas.toDataURL) continue;
        let dataUrl = "";
        try{
          dataUrl = canvas.toDataURL("image/png", 1);
        }catch{
          dataUrl = "";
        }
        if(dataUrl) out.push({ title: ch.title, dataUrl });
      }
      return out;
    }

    function buildDailySummaryTable(w){
      const rows = DAY_ORDER.map(d=>{
        const day = w.days[d.key];
        const dt = computeDayTotals(w, d.key);
        const cnt = day.tasks.length;
        const done = day.tasks.filter(x=>!!x.done).length;
        const uniqTags = new Set(day.tasks.map(x=>(x.tag||"").trim().toLowerCase()).filter(Boolean));
        const doneRate = cnt ? Math.round((done/cnt)*100) : 0;
        return `
          <tr>
            <td>${escapeHtml(d.name)}</td>
            <td>${escapeHtml(formatHours(dt.studyMin))}</td>
            <td>${fmtFa(dt.tests)}</td>
            <td>${fmtFa(cnt)}</td>
            <td>${fmtFa(done)} / ${fmtFa(cnt)}</td>
            <td>${fmtFa(doneRate)}%</td>
            <td>${fmtFa(uniqTags.size)}</td>
          </tr>
        `;
      }).join("");

      return `
        <div class="section">
          <div class="h2">Ø¬Ø¯ÙˆÙ„ Ø®Ù„Ø§ØµÙ‡ Ø±ÙˆØ²Ø§Ù†Ù‡</div>
          <table class="tbl">
            <thead>
              <tr>
                <th>Ø±ÙˆØ²</th>
                <th>Ù…Ø·Ø§Ù„Ø¹Ù‡</th>
                <th>ØªØ³Øª</th>
                <th>ØªØ¹Ø¯Ø§Ø¯ Ø¢ÛŒØªÙ…</th>
                <th>Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</th>
                <th>Ù†Ø±Ø® Ø§Ù†Ø¬Ø§Ù…</th>
                <th>ØªÙ†ÙˆØ¹ Ø¨Ø±Ú†Ø³Ø¨</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    function buildTopTagsTable(w, topN=12){
      const agg = computeTagAggregatesForWeek(w);
      const totalStudy = agg.totalStudy || 0;
      const totalTests = agg.totalTests || 0;

      const rows = agg.entriesStudy.slice(0, topN).map(([tag, mins])=>{
        const tests = (agg.entriesTests.find(x=>x[0]===tag)?.[1]) || 0;
        return `
          <tr>
            <td>${escapeHtml(tag)}</td>
            <td>${escapeHtml(formatHours(mins))}</td>
            <td>${pct(mins, totalStudy)}</td>
            <td>${fmtFa(tests)}</td>
            <td>${pct(tests, totalTests)}</td>
          </tr>
        `;
      }).join("");

      return `
        <div class="section">
          <div class="h2">Top Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§</div>
          <table class="tbl">
            <thead>
              <tr>
                <th>Ø¨Ø±Ú†Ø³Ø¨</th>
                <th>Ù…Ø·Ø§Ù„Ø¹Ù‡</th>
                <th>Ø³Ù‡Ù… Ù…Ø·Ø§Ù„Ø¹Ù‡</th>
                <th>ØªØ³Øª</th>
                <th>Ø³Ù‡Ù… ØªØ³Øª</th>
              </tr>
            </thead>
            <tbody>${rows || `<tr><td colspan="5">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</td></tr>`}</tbody>
          </table>
        </div>
      `;
    }

    function buildTasksTables(w){
      const daySections = DAY_ORDER.map(d=>{
        const day = w.days[d.key];
        const rows = (day.tasks||[]).map(t=>{
          const mins = taskMinutes(t);
          return `
            <tr>
              <td>${t.done ? "âœ…" : "â¬œ"}</td>
              <td>${escapeHtml(t.text||"")}</td>
              <td>${escapeHtml((t.tag||"").trim() || "â€”")}</td>
              <td>${escapeHtml(formatHours(mins))}</td>
              <td>${fmtFa(t.tests||0)}</td>
              <td>${nl2brSafe(t.notes||"")}</td>
            </tr>
          `;
        }).join("");

        return `
          <div class="section">
            <div class="h2">Ø¬Ø²Ø¦ÛŒØ§Øª Ø±ÙˆØ²: ${escapeHtml(d.name)}</div>
            <div class="subNote">
              <b>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª:</b> ${nl2brSafe(day.note||"â€”")}
              <span class="dot"></span>
              <b>ÙÙˆÚ©ÙˆØ³:</b> ${nl2brSafe(day.focus||"â€”")}
            </div>
            <table class="tbl">
              <thead>
                <tr>
                  <th style="width:42px;">ÙˆØ¶Ø¹ÛŒØª</th>
                  <th>Ø¹Ù†ÙˆØ§Ù†</th>
                  <th style="width:140px;">Ø¨Ø±Ú†Ø³Ø¨</th>
                  <th style="width:120px;">Ù…Ø·Ø§Ù„Ø¹Ù‡</th>
                  <th style="width:90px;">ØªØ³Øª</th>
                  <th>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</th>
                </tr>
              </thead>
              <tbody>
                ${rows || `<tr><td colspan="6">Ø¢ÛŒØªÙ…ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</td></tr>`}
              </tbody>
            </table>
          </div>
        `;
      }).join("");

      const weeklyRows = (w.weeklyTasks||[]).map(t=>{
        const mins = taskMinutes(t);
        return `
          <tr>
            <td>${t.done ? "âœ…" : "â¬œ"}</td>
            <td>${escapeHtml(t.text||"")}</td>
            <td>${escapeHtml((t.tag||"").trim() || "â€”")}</td>
            <td>${escapeHtml(formatHours(mins))}</td>
            <td>${fmtFa(t.tests||0)}</td>
            <td>${nl2brSafe(t.notes||"")}</td>
          </tr>
        `;
      }).join("");

      const weeklySection = `
        <div class="section">
          <div class="h2">ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ Ù‡ÙØªÚ¯ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</div>
          <table class="tbl">
            <thead>
              <tr>
                <th style="width:42px;">ÙˆØ¶Ø¹ÛŒØª</th>
                <th>Ø¹Ù†ÙˆØ§Ù†</th>
                <th style="width:140px;">Ø¨Ø±Ú†Ø³Ø¨</th>
                <th style="width:120px;">Ù…Ø·Ø§Ù„Ø¹Ù‡</th>
                <th style="width:90px;">ØªØ³Øª</th>
                <th>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</th>
              </tr>
            </thead>
            <tbody>
              ${weeklyRows || `<tr><td colspan="6">ØªØ³Ú© Ù‡ÙØªÚ¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</td></tr>`}
            </tbody>
          </table>
        </div>
      `;

      return weeklySection + daySections;
    }

    function buildWeekNarratives(w){
      return `
        <div class="section">
          <div class="h2">Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ù‡ÙØªÙ‡</div>
          <div class="grid2">
            <div class="card">
              <div class="cardTitle">Ø®Ù„Ø§ØµÙ‡ Ù‡ÙØªÙ‡</div>
              <div class="cardBody">${nl2brSafe(w.summary||"â€”")}</div>
            </div>
            <div class="card">
              <div class="cardTitle">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÙ‡ Ø¨Ø¹Ø¯</div>
              <div class="cardBody">${nl2brSafe(w.next||"â€”")}</div>
            </div>
            <div class="card">
              <div class="cardTitle">Ø¯Ø³ØªØ§ÙˆØ±Ø¯Ù‡Ø§</div>
              <div class="cardBody">${nl2brSafe(w.achievements||"â€”")}</div>
            </div>
            <div class="card">
              <div class="cardTitle">Ú†Ø§Ù„Ø´â€ŒÙ‡Ø§</div>
              <div class="cardBody">${nl2brSafe(w.blockers||"â€”")}</div>
            </div>
          </div>
        </div>
      `;
    }

    function buildKpiHeader(w){
      const totals = computeWeekTotals(w);
      const gs = clampInt(state.settings.goalStudyMin,0,9999999);
      const gt = clampInt(state.settings.goalTests,0,999999999);

      const ps = gs ? Math.min(100, Math.round((totals.studyMin/gs)*100)) : null;
      const pt = gt ? Math.min(100, Math.round((totals.tests/gt)*100)) : null;

      return `
        <div class="kpis">
          <div class="kpi">
            <div class="kpiLabel">Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù‡ÙØªÙ‡</div>
            <div class="kpiVal">${escapeHtml(formatHours(totals.studyMin))}</div>
            <div class="kpiSub">Ù‡Ø¯Ù: ${gs ? escapeHtml(formatHours(gs)) : "â€”"} â€¢ Ù¾ÛŒØ´Ø±ÙØª: ${ps==null ? "â€”" : (fmtFa(ps)+"%")}</div>
          </div>
          <div class="kpi">
            <div class="kpiLabel">ØªØ³Øª Ù‡ÙØªÙ‡</div>
            <div class="kpiVal">${fmtFa(totals.tests)}</div>
            <div class="kpiSub">Ù‡Ø¯Ù: ${gt ? fmtFa(gt) : "â€”"} â€¢ Ù¾ÛŒØ´Ø±ÙØª: ${pt==null ? "â€”" : (fmtFa(pt)+"%")}</div>
          </div>
          <div class="kpi">
            <div class="kpiLabel">ØªÙ†ÙˆØ¹ Ø¨Ø±Ú†Ø³Ø¨</div>
            <div class="kpiVal">${fmtFa(totals.tags)}</div>
            <div class="kpiSub">Ø¨Ø±Ú†Ø³Ø¨ ÛŒÚ©ØªØ§ Ø¯Ø± Ø§ÛŒÙ† Ù‡ÙØªÙ‡</div>
          </div>
        </div>
      `;
    }

    function buildChartsSection(chartImgs){
      if(!chartImgs || !chartImgs.length){
        return `<div class="section"><div class="h2">Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§</div><div class="muted">Ù†Ù…ÙˆØ¯Ø§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.</div></div>`;
      }
      const items = chartImgs.map(c=>`
        <div class="chartItem">
          <div class="chartTitle">${escapeHtml(c.title)}</div>
          <img class="chartImg" src="${c.dataUrl}" alt="${escapeHtml(c.title)}" />
        </div>
      `).join("");

      return `
        <div class="section">
          <div class="h2">Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§</div>
          <div class="chartsGrid">${items}</div>
        </div>
      `;
    }

    function buildWeekSectionHTML(weekKey, chartLevel="summary"){
      const w = state.weeks[weekKey];
      if(!w) return "";

      const title = safeWeekTitle(w);
      const userLine = activeUser ? (`@${escapeHtml(activeUser.username)}${activeUser.name ? " â€¢ " + escapeHtml(activeUser.name) : ""}`) : "â€”";
      const exportedAt = fmtDT(nowISO());

      const charts = captureCharts(chartLevel);

      return `
        <div class="page">
          <div class="header">
            <div>
              <div class="h1">Ú¯Ø²Ø§Ø±Ø´ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</div>
              <div class="meta">
                <span><b>Ù‡ÙØªÙ‡:</b> ${escapeHtml(weekLabel(weekKey))}</span>
                <span class="dot"></span>
                <span><b>Ø¹Ù†ÙˆØ§Ù†:</b> ${escapeHtml(title)}</span>
              </div>
              <div class="meta">
                <span><b>Ú©Ø§Ø±Ø¨Ø±:</b> ${userLine}</span>
                <span class="dot"></span>
                <span><b>Ø®Ø±ÙˆØ¬ÛŒ Ø¯Ø±:</b> ${exportedAt}</span>
              </div>
            </div>
            <div class="badgeBox">
              <div class="badge">Local Report</div>
              <div class="badge">A4 Ready</div>
            </div>
          </div>

          ${buildKpiHeader(w)}
          ${buildDailySummaryTable(w)}
          ${buildTopTagsTable(w, 12)}
          ${buildWeekNarratives(w)}
          ${buildTasksTables(w)}
          ${buildChartsSection(charts)}

          <div class="footerNote">
            Ø§ÛŒÙ† Ú¯Ø²Ø§Ø±Ø´ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª.
          </div>
        </div>
      `;
    }

    function reportBaseCSS(){
      return `
        :root{
          --text:#111827;
          --muted:#6b7280;
          --line:#e5e7eb;
          --card:#f9fafb;
        }
        *{ box-sizing:border-box; }
        html,body{ margin:0; padding:0; }
        body{
          font-family: "Vazirmatn", system-ui, -apple-system, Segoe UI, Roboto, Arial;
          color:var(--text);
          background:#fff;
          direction: rtl;
        }
        .toolbar{
          position: sticky;
          top:0;
          z-index: 5;
          background: #ffffffee;
          border-bottom:1px solid var(--line);
          backdrop-filter: blur(10px);
          padding: 10px 12px;
          display:flex;
          gap:8px;
          align-items:center;
          justify-content:space-between;
        }
        .btn{
          border:1px solid var(--line);
          background:#fff;
          padding:8px 10px;
          border-radius:10px;
          cursor:pointer;
          font-weight:800;
          font-size:13px;
          white-space:nowrap;
        }
        .btn.primary{ background:#111827; color:#fff; border-color:#111827; }
        .wrap{ max-width: 1040px; margin: 0 auto; padding: 12px; }

        .page{
          border:1px solid var(--line);
          border-radius: 14px;
          padding: 14px;
          margin: 12px 0 18px;
        }
        .header{ display:flex; justify-content:space-between; gap:12px; align-items:flex-start; }
        .h1{ font-size:18px; font-weight:900; }
        .h2{ font-size:14px; font-weight:900; margin: 0 0 10px; }
        .meta{ color:var(--muted); font-size:12px; margin-top:6px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
        .dot{ width:6px; height:6px; border-radius:99px; background: var(--line); display:inline-block; }

        .badgeBox{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
        .badge{
          font-size:11px;
          border:1px solid var(--line);
          padding:6px 10px;
          border-radius:999px;
          background: var(--card);
          font-weight:900;
          color:#111827;
        }

        .kpis{
          display:grid;
          grid-template-columns: repeat(3, 1fr);
          gap:10px;
          margin: 12px 0 10px;
        }
        .kpi{
          border:1px solid var(--line);
          background: var(--card);
          border-radius: 12px;
          padding: 10px;
        }
        .kpiLabel{ font-size:12px; color:var(--muted); font-weight:900; }
        .kpiVal{ font-size:18px; font-weight:900; margin-top:6px; }
        .kpiSub{ margin-top:6px; font-size:12px; color:var(--muted); font-weight:800; line-height:1.7; }

        .section{ margin-top: 14px; }
        .subNote{
          border:1px dashed var(--line);
          border-radius: 12px;
          padding: 10px;
          background: #fff;
          color: var(--muted);
          font-size: 12px;
          font-weight: 800;
          line-height: 1.8;
          margin: 10px 0;
        }

        .tbl{
          width:100%;
          border-collapse: collapse;
          border:1px solid var(--line);
          border-radius: 12px;
          overflow:hidden;
          font-size:12px;
        }
        .tbl th, .tbl td{
          border-bottom:1px solid var(--line);
          padding: 8px 8px;
          vertical-align: top;
          text-align: right;
          line-height: 1.7;
        }
        .tbl thead th{
          background: var(--card);
          font-weight: 900;
          color:#111827;
        }
        .tbl tbody tr:nth-child(even) td{ background:#fcfcfd; }

        .grid2{
          display:grid;
          grid-template-columns: 1fr 1fr;
          gap:10px;
        }
        .card{
          border:1px solid var(--line);
          border-radius: 12px;
          padding: 10px;
          background:#fff;
        }
        .cardTitle{ font-weight:900; font-size:12px; color:var(--muted); }
        .cardBody{ margin-top:8px; font-size:12px; line-height:1.9; font-weight:800; }

        .chartsGrid{
          display:grid;
          grid-template-columns: 1fr 1fr;
          gap:10px;
        }
        .chartItem{
          border:1px solid var(--line);
          border-radius: 12px;
          padding: 10px;
          background:#fff;
        }
        .chartTitle{ font-size:12px; font-weight:900; color:var(--muted); margin-bottom:8px; }
        .chartImg{
          width:100%;
          height:auto;
          border:1px solid var(--line);
          border-radius: 10px;
          display:block;
        }

        .footerNote{
          margin-top: 14px;
          color: var(--muted);
          font-size: 11px;
          font-weight: 800;
          border-top:1px solid var(--line);
          padding-top: 10px;
        }

        @media (max-width: 900px){
          .kpis{ grid-template-columns: 1fr; }
          .chartsGrid{ grid-template-columns: 1fr; }
          .grid2{ grid-template-columns: 1fr; }
        }

        @media print{
          .toolbar{ display:none !important; }
          .wrap{ max-width: unset; padding: 0; }
          .page{ border:0; border-radius:0; margin:0; padding: 0; }
          @page{ size: A4; margin: 12mm; }
          .chartsGrid{ grid-template-columns: 1fr 1fr; }
          .kpis{ grid-template-columns: repeat(3, 1fr); }
        }
      `;
    }

    async function openReportWizard(autoPrint=false){
      if(!activeUser || activeUser.role !== "student"){
        toast("Ú¯Ø²Ø§Ø±Ø´ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² ÙØ¹Ø§Ù„ Ø§Ø³Øª.");
        return;
      }
      flushAll();
      if(!currentWeek || !state.weeks[currentWeek]){
        toast("Ø§ÙˆÙ„ ÛŒÚ© Ù‡ÙØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.");
        return;
      }

      const level = (prompt("Ø³Ø·Ø­ Ú¯Ø²Ø§Ø±Ø´:\n1) Ø®Ù„Ø§ØµÙ‡ (Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ)\n2) Ú©Ø§Ù…Ù„ (Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ±)\nØ¹Ø¯Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†:", "1") === "2") ? "full" : "summary";
      const mode = prompt("Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø±Ø§ÛŒ:\n1) Ù‡ÙØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡\n2) Ø¨Ø§Ø²Ù‡â€ŒØ§ÛŒ (Ù‡ÙØªÙ‡ ØªØ§ Ù‡ÙØªÙ‡)\n3) Ù‡Ù…Ù‡ Ù‡ÙØªÙ‡â€ŒÙ‡Ø§\nØ¹Ø¯Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†:", "1") || "1";

      let selectedWeeks = [];

      if(mode === "2"){
        const from = (prompt("Ø§Ø² Ù‡ÙØªÙ‡ (YYYY-W##):", currentWeek) || "").trim();
        const to   = (prompt("ØªØ§ Ù‡ÙØªÙ‡ (YYYY-W##):", currentWeek) || "").trim();
        if(!from || !to) return;

        const keysAsc = Object.keys(state.weeks||{}).sort((a,b)=>a.localeCompare(b));
        selectedWeeks = keysAsc.filter(k => k >= from && k <= to);
        if(!selectedWeeks.length){
          toast("Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø§Ø²Ù‡ Ù‡ÙØªÙ‡â€ŒØ§ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.");
          return;
        }
      }else if(mode === "3"){
        selectedWeeks = Object.keys(state.weeks||{}).sort((a,b)=>a.localeCompare(b));
        if(!selectedWeeks.length){
          toast("Ù‡ÙØªÙ‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.");
          return;
        }
      }else{
        selectedWeeks = [currentWeek];
      }

      const prevWeek = currentWeek;
      const prevNav = activeNav || "dashboard";

      await ensureChartsForCapture();

      let pagesHTML = "";
      for(const wk of selectedWeeks){
        selectWeek(wk);
        setNav("dashboard");
        updateCharts(true);
        await waitFrames(3);

        pagesHTML += buildWeekSectionHTML(wk, level);
      }

      // Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª
      try{
        selectWeek(prevWeek);
        setNav(prevNav);
      }catch{}

      const html = `
        <!doctype html>
        <html lang="fa" dir="rtl">
          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width,initial-scale=1" />
            <link rel="preconnect" href="https://fonts.googleapis.com">
            <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
            <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
            <title>Ú¯Ø²Ø§Ø±Ø´ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</title>
            <style>${reportBaseCSS()}</style>
          </head>
          <body>
            <div class="toolbar">
              <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                <button class="btn primary" onclick="window.print()">ğŸ–¨ï¸ Ù¾Ø±ÛŒÙ†Øª / Save as PDF</button>
                <button class="btn" onclick="downloadHTML()">â¬‡ï¸ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù‡Ù…ÛŒÙ† Ú¯Ø²Ø§Ø±Ø´ (HTML)</button>
              </div>
              <div style="color:#6b7280; font-weight:900; font-size:12px;">
                Ù†Ú©ØªÙ‡: Ø¨Ø±Ø§ÛŒ PDF Ø§Ø² Print â†’ Save as PDF Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
              </div>
            </div>

            <div class="wrap">
              ${pagesHTML}
            </div>

            <script>
              function downloadHTML(){
                const html = document.documentElement.outerHTML;
                const blob = new Blob([html], {type:"text/html;charset=utf-8"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "student-report.html";
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
              }
              ${autoPrint ? "setTimeout(()=>window.print(), 400);" : ""}
            </script>
          </body>
        </html>
      `;

      const w = window.open("", "_blank");
      if(!w){ toast("Ù¾Ù†Ø¬Ø±Ù‡ Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§Ø² Ù†Ø´Ø¯ (Popup blockerØŸ)"); return; }
      w.document.open();
      w.document.write(html);
      w.document.close();

      toast("Ú¯Ø²Ø§Ø±Ø´ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯ âœ…");
    }

    /* ===============================
       Ù‚Ø³Ù…Øª 25: ØªÙ… Ùˆ Ø³Ø§Ø¹Øª
    =============================== */
    function setTheme(theme){
      state.theme = theme;
      $("app").setAttribute("data-theme", theme);
      persist();
      updateCharts(true);
    }
    function toggleTheme(){
      setTheme(state.theme === "dark" ? "light" : "dark");
      toast(state.theme === "dark" ? "ØªÙ… ØªÛŒØ±Ù‡" : "ØªÙ… Ø±ÙˆØ´Ù†");
    }
    function startClock(){
      const tick = () => {
        const d = new Date();
        $("clockTime").textContent = d.toLocaleTimeString("fa-IR", {hour:"2-digit", minute:"2-digit", second:"2-digit"});
        $("clockDate").textContent = d.toLocaleDateString("fa-IR", {weekday:"long", year:"numeric", month:"long", day:"numeric"});
      };
      tick();
      setInterval(tick, 1000);
    }

    /* ===============================
       Ù‚Ø³Ù…Øª 26: Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§
    =============================== */
    function wireEvents(){
      $("themeBtn").onclick = toggleTheme;

      $("menuBtn").onclick = openDrawer;
      $("drawerCloseBtn").onclick = closeDrawer;
      $("drawerOverlay").onclick = closeDrawer;
      document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeDrawer(); });

      $("navDashboard").onclick = () => setNav("dashboard");
      $("navWeekly").onclick = () => { flushAll(); setNav("weekly"); };
      $("navDaily").onclick = () => { flushAll(); setNav("daily"); };
      $("navTags").onclick = () => { flushAll(); setNav("tags"); };
      $("navMessages").onclick = () => { flushAll(); setNav("messages"); };
      $("navCounselor").onclick = () => { flushAll(); setNav("counselor"); };

      $("weekPicker").addEventListener("change", () => {
        const wk = $("weekPicker").value;
        if(!wk) return;
        createNewWeek(wk);
      });
      $("newWeekBtn").onclick = () => {
        const wk = $("weekPicker").value || getDefaultWeek();
        createNewWeek(wk);
      };

      $("searchBox").addEventListener("input", () => renderWeeksList($("searchBox").value));

      $("exportBtn").onclick = exportJSON;
      $("importFile").addEventListener("change", (e) => {
        const f = e.target.files && e.target.files[0];
        if(f) importJSON(f);
        $("importFile").value = "";
      });

      $("resetBtn").onclick = () => {
        if(!confirm("Ù‡Ù…Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ")) return;
        localStorage.removeItem(STORAGE_KEY);
        state = normalizeAllStateInPlace({ theme: state.theme || "dark", weeks:{}, tagBank:[], weeklyTrendMode:"study", settings:{ topTagsN:8, goalStudyMin:0, goalTests:0 }, profile: state.profile || null });
        persist();
        renderTagBank();
        renderWeeksList("");
        createNewWeek(getDefaultWeek());
        setNav("dashboard");
        toast("Ø±ÛŒØ³Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯");
      };

      // âœ… Ù¾Ø±ÛŒÙ†Øª Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ
      $("printBtn").onclick = () => openReportWizard(true);

      ["weekTitle","weekTags","weekSummary","weekAchievements","weekBlockers","weekNext"].forEach(id=>{
        $(id).addEventListener("input", ()=>{
          setDirty(true);
          flushAll();
          renderWeeksList($("searchBox").value);
          updateEverything(true);
          setDirty(false);
        });
      });

      ["dayNote","dayFocus"].forEach(id=>{
        $(id).addEventListener("input", ()=>{
          setDirty(true);
          flushAll();
          updateEverything(true);
          setDirty(false);
        });
      });

      $("addWeeklyTask").onclick = () => {
        const w = state.weeks[currentWeek];
        const t = { id: safeUUID(), text:"", done:false, tag:"", hours:0, minutes:0, tests:0, notes:"", createdAt: nowISO(), updatedAt: nowISO() };
        normalizeTaskInPlace(t);
        w.weeklyTasks.unshift(t);
        w.updatedAt = nowISO();
        persist();
        renderWeeklyTasks();
        updateEverything(true);
        toast("ØªØ³Ú© Ù‡ÙØªÚ¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯");
      };

      $("deleteWeekBtn").onclick = () => {
        if(!currentWeek) return;
        if(!confirm("Ø§ÛŒÙ† Ù‡ÙØªÙ‡ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) return;
        delete state.weeks[currentWeek];
        persist();
        const keys = sortWeeksDesc(Object.keys(state.weeks||{}));
        if(keys[0]) selectWeek(keys[0]);
        else createNewWeek(getDefaultWeek());
        toast("Ø­Ø°Ù Ø´Ø¯");
      };

      $("addLessonBtn").onclick = () => {
        if(!currentWeek || !state.weeks[currentWeek]) return;

        const w = state.weeks[currentWeek];
        const d = w.days[currentDayKey];

        const title = ($("lessonTitle").value || "").trim();
        const tag = $("lessonTag").value || "";
        const hours = clampInt($("lessonHours").value, 0, 9999);
        const minutes = clampInt($("lessonMinutes").value, 0, 59);
        const tests = clampInt($("lessonTests").value, 0, 999999);
        const notes = ($("lessonNotes").value || "").trim();

        const isEmpty = !title && !tag && hours===0 && minutes===0 && tests===0 && !notes;
        if(isEmpty) return toast("Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù…ÙˆØ±Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†");

        const t = {
          id: safeUUID(),
          text: title || (tag ? `Ø¯Ø±Ø³/Ú©Ø§Ø±: ${tag}` : "Ø¯Ø±Ø³/Ú©Ø§Ø±"),
          done: false,
          tag,
          hours,
          minutes,
          tests,
          notes,
          createdAt: nowISO(),
          updatedAt: nowISO(),
        };
        normalizeTaskInPlace(t);

        d.tasks.unshift(t);
        if(tag) addTagsToBank([tag]);

        w.updatedAt = nowISO();
        persist();

        $("lessonTitle").value = "";
        $("lessonHours").value = "";
        $("lessonMinutes").value = "";
        $("lessonTests").value = "";
        $("lessonNotes").value = "";

        renderDailyTasks();
        updateEverything(true);
        toast("Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ âœ…");
      };

      $("tagBankAddBtn").onclick = () => {
        const tags = normalizeTags($("tagBankInput").value || "");
        if(tags.length===0) return toast("Ø¨Ø±Ú†Ø³Ø¨ ÙˆØ§Ø±Ø¯ Ú©Ù†");
        const changed = addTagsToBank(tags);
        $("tagBankInput").value = "";
        renderTagBank();
        refreshAllTagSelects();
        updateEverything(true);
        toast(changed ? "Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯" : "ØªÚ©Ø±Ø§Ø±ÛŒ Ø¨ÙˆØ¯");
      };
      $("tagBankClearBtn").onclick = () => {
        if(!confirm("Ù‡Ù…Ù‡ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ")) return;
        state.tagBank = [];
        for(const wk of Object.keys(state.weeks)){
          const w = state.weeks[wk];
          for(const t of w.weeklyTasks) t.tag="";
          for(const d of DAY_ORDER){
            for(const t of w.days[d.key].tasks) t.tag="";
          }
        }
        persist();
        renderTagBank();
        refreshAllTagSelects();
        updateEverything(true);
        toast("Ù¾Ø§Ú© Ø´Ø¯");
      };

      const applyDash = () => {
        state.settings.topTagsN = clampInt($("topTagsN").value, 3, 20);
        state.settings.goalStudyMin = clampInt($("goalStudyHours").value,0,9999)*60;
        state.settings.goalTests = clampInt($("goalTests").value,0,999999999);
        persist();
        updateEverything(true);
        updateCharts(true);
        toast("ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯ âœ…");
      };
      $("topTagsN").addEventListener("change", applyDash);
      $("goalStudyHours").addEventListener("input", applyDash);
      $("goalTests").addEventListener("input", applyDash);

      $("rebuildChartsBtn").onclick = () => { updateCharts(true); toast("Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ Ø±ÙØ±Ø´ Ø´Ø¯ âœ…"); };
      $("trendModeStudy").onclick = () => { state.weeklyTrendMode="study"; persist(); updateCharts(true); };
      $("trendModeTests").onclick = () => { state.weeklyTrendMode="tests"; persist(); updateCharts(true); };

      window.addEventListener("beforeunload", () => flushAll());
      window.addEventListener("resize", () => {
        clearTimeout(window.__rt);
        window.__rt = setTimeout(()=>{ updateCharts(true); }, 160);
      });

      // ========= Ù¾Ø±ÙˆÙØ§ÛŒÙ„/Ú©Ø¯ Ù…Ø´Ø§ÙˆØ±/Ø®Ø±ÙˆØ¬ =========
      $("logoutBtn").onclick = () => {
        if(!confirm("Ø§Ø² Ø­Ø³Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆÛŒØŸ")) return;
        clearSession();
        activeUser = null;
        openAuth();
        toast("Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒ");
      };

      $("mentorCodeSaveBtn").onclick = () => {
        if(!activeUser || activeUser.role!=="student") return;
        const code = ($("mentorCodeInput").value || "").trim().toUpperCase();
        const users = loadUsers();
        const me = users.find(x => normUsername(x.username) === normUsername(activeUser.username));
        if(!me) return;
        me.mentorCode = code;
        saveUsers(users);
        activeUser = me;
        applyRoleUI();
        toast(code ? "Ú©Ø¯ Ù…Ø´Ø§ÙˆØ± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…" : "Ú©Ø¯ Ù¾Ø§Ú© Ø§Ø³Øª");
        renderStudentMessages();
      };

      $("mentorCodeClearBtn").onclick = () => {
        if(!activeUser || activeUser.role!=="student") return;
        const users = loadUsers();
        const me = users.find(x => normUsername(x.username) === normUsername(activeUser.username));
        if(!me) return;
        me.mentorCode = "";
        saveUsers(users);
        activeUser = me;
        applyRoleUI();
        toast("Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù…Ø´Ø§ÙˆØ± Ù‚Ø·Ø¹ Ø´Ø¯ âœ•");
        renderStudentMessages();
      };

      $("copyCounselorCodeBtn").onclick = async () => {
        const v = $("counselorCodeInput").value || "";
        try{
          if(navigator.clipboard){ await navigator.clipboard.writeText(v); toast("Ú©Ù¾ÛŒ Ø´Ø¯ âœ…"); return; }
        }catch{}
        toast("Ú©Ù¾ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù…Ù…Ú©Ù† Ù†ÛŒØ³ØªØ› Ø¯Ø³ØªÛŒ Ú©Ù¾ÛŒ Ú©Ù†");
      };

      // ========= Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ =========
      $("msgSendBtn").onclick = () => {
        if(!activeUser || activeUser.role!=="student") return;
        const mentorCode = (activeUser.mentorCode || "").trim().toUpperCase();
        const text = ($("msgText").value || "").trim();
        if(!mentorCode) return toast("Ø§ÙˆÙ„ Ú©Ø¯ Ù…Ø´Ø§ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†");
        if(!text) return toast("Ù¾ÛŒØ§Ù… Ø®Ø§Ù„ÛŒ Ø§Ø³Øª");
        postMessage({ counselorCode: mentorCode, studentUsername: activeUser.username, fromRole:"student", fromUser: activeUser.username, text });
        $("msgText").value = "";
        renderStudentMessages();
        toast("Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ âœ…");
      };

      $("cPdfFile").addEventListener("change", (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f){ counselorPendingPdf=null; $("cPdfHint").textContent="ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡"; return; }
        if(f.type !== "application/pdf"){ toast("ÙÙ‚Ø· PDF Ù…Ø¬Ø§Ø² Ø§Ø³Øª"); e.target.value=""; return; }

        const reader = new FileReader();
        reader.onload = () => {
          counselorPendingPdf = { name: f.name, dataUrl: reader.result };
          $("cPdfHint").textContent = "Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„: " + f.name;
        };
        reader.readAsDataURL(f);
      });

      $("cSendBtn").onclick = () => {
        if(!activeUser || activeUser.role!=="counselor") return;
        if(!counselorSelectedStudent) return toast("ÛŒÚ© Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†");

        const code = (activeUser.counselorCode || "").trim().toUpperCase();
        const text = ($("cMsgText").value || "").trim();
        if(!text && !counselorPendingPdf) return toast("Ù¾ÛŒØ§Ù… ÛŒØ§ PDF Ù„Ø§Ø²Ù… Ø§Ø³Øª");

        const attachments = counselorPendingPdf ? [counselorPendingPdf] : [];
        postMessage({ counselorCode: code, studentUsername: counselorSelectedStudent, fromRole:"counselor", fromUser: activeUser.username, text, attachments });

        $("cMsgText").value = "";
        counselorPendingPdf = null;
        $("cPdfFile").value = "";
        $("cPdfHint").textContent = "ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡";

        renderCounselorStudents();
        toast("Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ âœ…");
      };

      // ========= AUTH ÙˆØ§Ù‚Ø¹ÛŒ =========
      const roleStudent = $("roleStudent");
      const roleCounselor = $("roleCounselor");
      const authModeLogin = $("authModeLogin");
      const authModeSignup = $("authModeSignup");

      let chosenRole = "student";
      let authMode = "login";

      function setAuthMode(m){
        authMode = m;
        authModeLogin.classList.toggle("active", m==="login");
        authModeSignup.classList.toggle("active", m==="signup");
        $("authPassword2Field").style.display = (m==="signup") ? "" : "none";
      }
      setAuthMode("login");

      authModeLogin.onclick = () => setAuthMode("login");
      authModeSignup.onclick = () => setAuthMode("signup");

      roleStudent.onclick = () => {
        chosenRole="student";
        roleStudent.classList.add("active");
        roleCounselor.classList.remove("active");
        $("authMentorCodeField").style.display = "";
      };
      roleCounselor.onclick = () => {
        chosenRole="counselor";
        roleCounselor.classList.add("active");
        roleStudent.classList.remove("active");
        $("authMentorCodeField").style.display = "none";
      };

      $("authContinueBtn").onclick = async () => {
        const name = ($("authName").value || "").trim();
        const username = ($("authUsername").value || "").trim();
        const pw = ($("authPassword").value || "");
        const pw2 = ($("authPassword2").value || "");
        const mentorCode = ($("authMentorCode").value || "").trim().toUpperCase();

        if(!username) return toast("Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†");
        if(!pw) return toast("Ø±Ù…Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†");

        const users = loadUsers();

        if(authMode === "signup"){
          if(pw !== pw2) return toast("Ø±Ù…Ø² Ùˆ ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² ÛŒÚ©ÛŒ Ù†ÛŒØ³Øª");
          if(findUser(username)) return toast("Ø§ÛŒÙ† Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡");

          const passHash = await hashPassword(pw);
          const u = {
            id: safeUUID(),
            username: normUsername(username),
            role: chosenRole,
            name,
            passHash,
            createdAt: nowISO(),
            mentorCode: chosenRole==="student" ? mentorCode : "",
            counselorCode: chosenRole==="counselor" ? genCounselorCode() : ""
          };
          users.push(u);
          saveUsers(users);

          STORAGE_KEY = userStateKey(u.username);

          // Ù…Ù‡Ø§Ø¬Ø±Øª Ø§Ø² Ù†Ø³Ø®Ù‡ Ù‚Ø¯ÛŒÙ…ÛŒ Ø§Ú¯Ø± Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø± Ø§Ø³Øª
          const hasNew = !!localStorage.getItem(STORAGE_KEY);
          const legacy = localStorage.getItem("student.analytics.drawer.v1");
          if(!hasNew && legacy){
            localStorage.setItem(STORAGE_KEY, legacy);
          }

          activeUser = u;
          saveSession(u.username);

          state = loadState();
          state.profile = { role: u.role, name: u.name || "", username: u.username };
          persist();

          applyRoleUI();
          closeAuth();
          start();
          toast("Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ âœ…");
          return;
        }

        // login
        const u = findUser(username);
        if(!u) return toast("Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ (Ø§ÙˆÙ„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†)");
        const passHash = await hashPassword(pw);
        if(passHash !== u.passHash) return toast("Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª");

        if(chosenRole !== u.role) return toast("Ù†Ù‚Ø´ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø¨Ø§ Ù†Ù‚Ø´ Ø­Ø³Ø§Ø¨ ÛŒÚ©ÛŒ Ù†ÛŒØ³Øª");

        STORAGE_KEY = userStateKey(u.username);
        activeUser = u;
        saveSession(u.username);

        state = loadState();
        state.profile = { role: u.role, name: u.name || "", username: u.username };
        persist();

        applyRoleUI();
        closeAuth();
        start();
        toast("ÙˆØ±ÙˆØ¯ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ âœ…");
      };
    }

    /* ===============================
       Ù‚Ø³Ù…Øª 27: Ø´Ø±ÙˆØ¹ (Ø¨Ø§ session)
    =============================== */
    async function boot(){
      const sess = loadSession();
      if(sess && sess.username){
        const u = findUser(sess.username);
        if(u){
          STORAGE_KEY = userStateKey(u.username);

          const hasNew = !!localStorage.getItem(STORAGE_KEY);
          const legacy = localStorage.getItem("student.analytics.drawer.v1");
          if(!hasNew && legacy){
            localStorage.setItem(STORAGE_KEY, legacy);
          }

          activeUser = u;
          state = loadState();
          state.profile = { role: u.role, name: u.name || "", username: normUsername(u.username) };
          persist();

          applyRoleUI();
          closeAuth();
          start();
          return;
        }
      }
      openAuth();
    }

    function start(){
      setTheme(state.theme || "dark");
      startClock();
      renderTagBank();

      if(!activeUser){
        openAuth();
        return;
      }

      applyRoleUI();

      if(activeUser.role === "counselor"){
        // Ù¾Ù†Ù„ Ù…Ø´Ø§ÙˆØ±
        setNav("counselor");
        renderCounselorStudents();
        return;
      }

      // Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
      const keys = sortWeeksDesc(Object.keys(state.weeks||{}));
      if(keys.length===0) createNewWeek(getDefaultWeek());
      else selectWeek(keys[0]);

      renderWeeksList("");
      setNav("dashboard");
      setDirty(false);

      populateTagSelect($("lessonTag"), "");
    }

    wireEvents();
    boot();
  </script>
</body>
</html>