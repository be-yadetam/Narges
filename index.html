<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªØ¹Ø§Ù…Ù„ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²/Ù…Ø´Ø§ÙˆØ± (ØªÚ©â€ŒÙØ§ÛŒÙ„)</title>

  <!-- ÙÙˆÙ†Øª -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --card:#0b1633;
      --stroke:rgba(255,255,255,.12);
      --muted:rgba(234,240,255,.72);
      --text:#eaf0ff;
      --chip:rgba(255,255,255,.08);
      --accent:#7c3aed;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius:18px;
    }
    #app[data-theme="light"]{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --card:#ffffff;
      --stroke:rgba(15,23,42,.12);
      --muted:rgba(15,23,42,.62);
      --text:#0b1220;
      --chip:rgba(15,23,42,.06);
      --accent:#7c3aed;
      --shadow: 0 10px 30px rgba(15,23,42,.10);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:"Vazirmatn", system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg);
      color:var(--text);
    }
    a{ color:inherit; text-decoration:none; }
    .hidden{ display:none !important; }

    .app{
      min-height:100%;
      display:grid;
      grid-template-columns: 320px 1fr;
    }

    /* Drawer overlay (mobile) */
    .drawerOverlay{
      display:none;
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      z-index:40;
    }
    .drawer{
      position:sticky;
      top:0;
      height:100vh;
      overflow:auto;
      padding:14px;
      border-left:1px solid var(--stroke);
      background:linear-gradient(180deg, var(--panel), rgba(0,0,0,0));
    }
    .drawerHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
      min-width:0;
    }
    .brand b{ font-size:14px; }
    .brand small{ color:var(--muted); font-size:12px; }

    .iconBtn{
      border:1px solid var(--stroke);
      background:var(--chip);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
    }
    .iconBtn:hover{ filter:brightness(1.05); }

    .nav{
      display:flex; flex-direction:column; gap:8px;
      margin:10px 0 12px;
    }
    .navBtn{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:var(--chip);
      cursor:pointer;
      user-select:none;
      font-weight:900;
    }
    .navBtn.active{
      outline:2px solid rgba(124,58,237,.35);
      background:rgba(124,58,237,.14);
      border-color:rgba(124,58,237,.35);
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid var(--stroke);
      background:var(--chip);
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }
    .muted{ color:var(--muted); }

    .pillRow{
      display:flex; gap:8px; flex-wrap:wrap;
      margin:10px 0;
    }

    .weeksList{
      margin-top:8px;
      display:flex; flex-direction:column; gap:8px;
    }
    .weekItem{
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:var(--chip);
      cursor:pointer;
      font-weight:900;
    }
    .weekItem.active{
      outline:2px solid rgba(6,182,212,.25);
      background:rgba(6,182,212,.10);
      border-color:rgba(6,182,212,.25);
    }

    .sep{
      height:1px;
      background:var(--stroke);
      margin:12px 0;
    }

    .field{
      display:flex; flex-direction:column; gap:6px;
      margin-bottom:10px;
    }
    label{ font-size:12px; color:var(--muted); font-weight:900; }
    input, textarea, select{
      width:100%;
      border:1px solid var(--stroke);
      background:var(--panel);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-family:inherit;
      outline:none;
    }
    textarea{ min-height:90px; resize:vertical; }

    .sideActions{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .btn{
      border:1px solid var(--stroke);
      background:var(--chip);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
    }
    .btn.primary{
      background:rgba(124,58,237,.18);
      border-color:rgba(124,58,237,.35);
    }
    .btn.danger{
      background:rgba(239,68,68,.14);
      border-color:rgba(239,68,68,.25);
    }

    /* main */
    .main{
      padding:14px 14px 24px;
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background:var(--panel);
      box-shadow: var(--shadow);
      position:sticky; top:10px;
      z-index:5;
    }
    .titleCol{ display:flex; flex-direction:column; gap:3px; min-width:0; }
    .titleCol b{ font-size:14px; }
    .titleCol small{ color:var(--muted); font-size:12px; }

    .topActions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .clock{
      display:flex; flex-direction:column;
      align-items:flex-end;
      gap:2px;
      min-width:130px;
    }
    .clock span{ font-weight:900; }
    .clock small{ color:var(--muted); font-size:12px; }

    .content{
      margin-top:14px;
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background:var(--panel);
      box-shadow: var(--shadow);
      padding:14px;
      min-height: calc(100vh - 120px);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
    }
    .card{
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: var(--card);
      padding:12px;
    }
    .cardHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .cardHead b{ font-size:13px; }
    .canvasWrap{ position:relative; height:260px; }
    canvas{ width:100% !important; height:100% !important; }

    /* tasks */
    .taskCard{
      border:1px solid var(--stroke);
      border-radius:16px;
      background:rgba(255,255,255,.03);
      padding:10px;
      margin-bottom:10px;
    }
    .taskCard.done{ opacity:.72; }
    .taskTop{ display:flex; flex-direction:column; gap:10px; }
    .taskRow{ display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .taskLeft{ display:flex; gap:10px; align-items:center; flex:1; min-width:0; }
    .taskTitle input{ width:100%; }
    .controlsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap:10px;
      align-items:end;
    }
    .actions{ display:flex; gap:8px; justify-content:flex-end; }
    .taskDetails{ display:none; margin-top:8px; }
    .taskCard.open .taskDetails{ display:block; }

    /* messages */
    .msgList{ display:flex; flex-direction:column; gap:10px; max-height:55vh; overflow:auto; padding:6px; }
    .msg{
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:10px 12px;
      background:rgba(255,255,255,.04);
      max-width: 720px;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .msg.me{ margin-right:auto; background:rgba(124,58,237,.14); border-color:rgba(124,58,237,.25); }
    .msg.them{ margin-left:auto; background:rgba(6,182,212,.12); border-color:rgba(6,182,212,.22); }
    .msgMeta{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; color:var(--muted); font-size:11px; font-weight:900; }
    .fileChip{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--stroke);
      background:var(--chip);
      padding:6px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:900;
    }

    /* Auth modal */
    .authOverlay{
      display:none;
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      z-index:60;
      align-items:center; justify-content:center;
      padding:14px;
    }
    body.auth-open .authOverlay{ display:flex; }
    .authBox{
      width:min(560px, 100%);
      border:1px solid var(--stroke);
      border-radius:20px;
      background:var(--panel);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .authHead{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .authHead b{ font-size:14px; }
    .tabRow{ display:flex; gap:8px; flex-wrap:wrap; margin:10px 0; }
    .tab{
      border:1px solid var(--stroke);
      background:var(--chip);
      color:var(--text);
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      cursor:pointer;
    }
    .tab.active{ background:rgba(124,58,237,.16); border-color:rgba(124,58,237,.35); }

    /* toast */
    #toast{
      position:fixed;
      bottom:18px;
      left:18px;
      z-index:80;
      opacity:0;
      transform:translateY(10px);
      transition:.22s ease;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.45);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      backdrop-filter: blur(8px);
      font-weight:900;
      max-width:min(520px, 90vw);
    }
    #toast.show{ opacity:1; transform:translateY(0); }

    /* responsive */
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .drawer{
        position:fixed;
        right:-360px;
        top:0;
        width:340px;
        max-width:90vw;
        z-index:50;
        transition:.25s ease;
        border-left:none;
        border-right:1px solid var(--stroke);
        background:var(--panel);
      }
      body.drawer-open .drawer{ right:0; }
      body.drawer-open .drawerOverlay{ display:block; }
      .grid2{ grid-template-columns: 1fr; }
      .grid3{ grid-template-columns: 1fr; }
      .controlsGrid{ grid-template-columns: 1fr 1fr 1fr auto; }
    }
  </style>
</head>

<body>
<div id="app" class="app" data-theme="dark">

  <!-- Drawer overlay -->
  <div id="drawerOverlay" class="drawerOverlay"></div>

  <!-- Sidebar / Drawer -->
  <aside class="drawer">
    <div class="drawerHeader">
      <div class="brand">
        <b>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªØ¹Ø§Ù…Ù„ÛŒ</b>
        <small>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²/Ù…Ø´Ø§ÙˆØ± (ØªÚ©â€ŒÙØ§ÛŒÙ„) âœ…</small>
      </div>
      <button id="drawerCloseBtn" class="iconBtn" title="Ø¨Ø³ØªÙ†">âœ•</button>
    </div>

    <div class="nav">
      <div id="navDashboard" class="navBtn navBtnX"><span>ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span><span class="badge">ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§</span></div>
      <div id="navWeekly" class="navBtn navBtnX"><span>ğŸ“ Ø¨Ø®Ø´ Ù‡ÙØªÚ¯ÛŒ</span><span class="badge">Ú¯Ø²Ø§Ø±Ø´ Ù‡ÙØªÙ‡</span></div>
      <div id="navDaily" class="navBtn navBtnX"><span>ğŸ“… Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡</span><span class="badge">Ø«Ø¨Øª Ø¯Ø±Ø³/Ú©Ø§Ø±</span></div>
      <div id="navTags" class="navBtn navBtnX"><span>ğŸ·ï¸ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§</span><span class="badge">Ø¨Ø§Ù†Ú© Ø¨Ø±Ú†Ø³Ø¨</span></div>
      <div id="navMessages" class="navBtn navBtnX"><span>ğŸ’¬ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</span><span class="badge">Ù…Ø´Ø§ÙˆØ± â†” Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</span></div>
      <div id="navCounselor" class="navBtn navBtnX" style="display:none;"><span>ğŸ§‘â€ğŸ« Ù¾Ù†Ù„ Ù…Ø´Ø§ÙˆØ±</span><span class="badge">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</span></div>
    </div>

    <div class="sep" id="studentSep"></div>

    <!-- Student sidebar pills -->
    <div id="weekPill" class="pillRow">
      <span id="currentWeekBadge" class="badge">Week --</span>
      <span id="saveBadge" class="badge">â€”</span>
    </div>

    <div id="searchPill" class="field">
      <label>Ø¬Ø³ØªØ¬Ùˆ</label>
      <input id="searchBox" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø±ÛŒØ§Ø¶ÛŒØŒ ÙÛŒØ²ÛŒÚ©ØŒ Ø¢Ø²Ù…ÙˆÙ†â€¦" />
    </div>

    <div id="weeksList" class="weeksList"></div>

    <div class="sep"></div>

    <!-- Profile -->
    <div class="card">
      <div class="cardHead">
        <b>ğŸ‘¤ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</b>
        <span id="profileRoleBadge" class="badge">â€”</span>
      </div>
      <div class="muted" style="font-size:12px; font-weight:900;">
        <div>Ú©Ø§Ø±Ø¨Ø±: <span id="profileUserBadge">â€”</span></div>
        <div>Ù†Ø§Ù…: <span id="profileNameBadge">â€”</span></div>
      </div>

      <div id="mentorCodeField" style="margin-top:12px;">
        <div class="field">
          <label>Ú©Ø¯ Ù…Ø´Ø§ÙˆØ± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
          <input id="mentorCodeInput" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: CNS-ABC123" />
        </div>
        <div class="sideActions">
          <button id="mentorCodeSaveBtn" class="btn primary">Ø°Ø®ÛŒØ±Ù‡</button>
          <button id="mentorCodeClearBtn" class="btn">âœ• Ø®Ø±ÙˆØ¬ Ø§Ø² Ù…Ø´Ø§ÙˆØ±Ù‡</button>
        </div>
      </div>

      <div id="counselorCodeField" class="hidden" style="margin-top:12px;">
        <div class="field">
          <label>Ú©Ø¯ Ù…Ø´Ø§ÙˆØ± Ø´Ù…Ø§</label>
          <input id="counselorCodeInput" type="text" disabled />
        </div>
        <div class="sideActions">
          <button id="copyCounselorCodeBtn" class="btn primary">Ú©Ù¾ÛŒ Ú©Ø¯</button>
        </div>
      </div>

      <div class="sep"></div>
      <div class="muted" style="font-size:12px; line-height:1.9;">
        Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±ÙˆÛŒ Ù‡Ù…ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (LocalStorage).
      </div>

      <div class="sep"></div>
      <button id="logoutBtn" class="btn" style="width:100%;">Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨</button>
    </div>

    <div id="studentStorageHint" class="muted" style="margin-top:10px; font-size:12px;">
      â€”
    </div>

    <div id="studentSideActions1" class="sep"></div>

    <div id="studentSideActions2" class="sideActions">
      <button id="exportBtn" class="btn">Ø®Ø±ÙˆØ¬ÛŒ JSON</button>
      <label class="btn" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
        ÙˆØ±ÙˆØ¯ÛŒ JSON
        <input id="importFile" type="file" accept="application/json" style="display:none;">
      </label>
      <button id="printBtn" class="btn">Ú†Ø§Ù¾</button>
      <button id="resetBtn" class="btn danger">Ø±ÛŒØ³Øª</button>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topbar">
      <div style="display:flex; align-items:center; gap:10px;">
        <button id="menuBtn" class="iconBtn">â˜°</button>
        <div class="titleCol">
          <b id="mainTitle">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</b>
          <small class="muted">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªØ¹Ø§Ù…Ù„ÛŒ ØªÚ©â€ŒÙØ§ÛŒÙ„</small>
        </div>
      </div>

      <div class="topActions">
        <button id="themeBtn" class="iconBtn">ğŸŒ“</button>
        <div class="clock">
          <span id="clockTime">--:--:--</span>
          <small id="clockDate">â€”</small>
        </div>
      </div>
    </div>

    <section class="content">
      <!-- Dashboard -->
      <div id="viewDashboard">
        <div class="grid3">
          <div class="card">
            <div class="cardHead"><b>Ø®Ù„Ø§ØµÙ‡ Ù‡ÙØªÙ‡</b><span id="kpiWeek" class="badge">â€”</span></div>
            <div id="kpiSummary" class="muted">ÛŒÚ© Ù‡ÙØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ØªØ§ ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø¨Ø´Ù‡.</div>
          </div>
          <div class="card">
            <div class="cardHead"><b>ğŸ“š Ù…Ø·Ø§Ù„Ø¹Ù‡</b></div>
            <div id="kpiStudy" class="badge">ğŸ“š Ù…Ø·Ø§Ù„Ø¹Ù‡: â€”</div>
          </div>
          <div class="card">
            <div class="cardHead"><b>ğŸ§ª ØªØ³Øª</b></div>
            <div id="kpiTests" class="badge">ğŸ§ª ØªØ³Øª: â€”</div>
          </div>
        </div>

        <div style="margin-top:12px;" class="grid3">
          <div class="card">
            <div class="cardHead"><b>ğŸ·ï¸ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§</b></div>
            <div id="kpiTags" class="badge">ğŸ·ï¸ Ø¨Ø±Ú†Ø³Ø¨: â€”</div>
          </div>
          <div class="card">
            <div class="cardHead"><b>ÙˆØ¶Ø¹ÛŒØª Ù‡ÙØªÙ‡</b></div>
            <div id="weeklyStatsBadge" class="badge">â€”</div>
          </div>
          <div class="card">
            <div class="cardHead"><b>Ù¾ÛŒØ´Ø±ÙØª Ù†Ø³Ø¨Øª Ø¨Ù‡ Ù‡Ø¯Ù</b></div>
            <div id="progressBadge" class="badge">â€”</div>
          </div>
        </div>

        <div style="margin-top:12px;" class="card">
          <div class="cardHead"><b>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</b><span class="badge">LIVE</span></div>
          <div class="grid3">
            <div class="field">
              <label>Top N Ø¨Ø±Ú†Ø³Ø¨</label>
              <input id="topTagsN" type="number" value="8" min="3" max="30" />
            </div>
            <div class="field">
              <label>Ù‡Ø¯Ù Ù…Ø·Ø§Ù„Ø¹Ù‡ (Ø³Ø§Ø¹Øª)</label>
              <input id="goalStudyHours" type="number" placeholder="Ù…Ø«Ù„Ø§Ù‹ 25" min="0" />
            </div>
            <div class="field">
              <label>Ù‡Ø¯Ù ØªØ³Øª</label>
              <input id="goalTests" type="number" placeholder="Ù…Ø«Ù„Ø§Ù‹ 300" min="0" />
            </div>
          </div>
          <div class="sideActions">
            <button id="rebuildChartsBtn" class="btn primary">Ø±ÙØ±Ø´ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§</button>
          </div>
          <div class="muted" style="margin-top:8px; font-size:12px;">Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„: Ù…Ù†Ùˆ Ú©Ø´ÙˆÛŒÛŒ Ø§Ø² Ø±Ø§Ø³Øª âœ…</div>
        </div>

        <!-- Charts -->
        <div style="margin-top:12px;" class="grid2">
          <div class="card">
            <div class="cardHead"><b>Ù‡Ø¯Ù Ù…Ø·Ø§Ù„Ø¹Ù‡</b><span id="goalStudyKpi" class="badge">â€”</span></div>
            <div class="canvasWrap"><canvas id="goalStudyDonut"></canvas></div>
          </div>
          <div class="card">
            <div class="cardHead"><b>Ù‡Ø¯Ù ØªØ³Øª</b><span id="goalTestsKpi" class="badge">â€”</span></div>
            <div class="canvasWrap"><canvas id="goalTestsDonut"></canvas></div>
          </div>
        </div>

        <div style="margin-top:12px;" class="grid2">
          <div class="card">
            <div class="cardHead"><b>ğŸ›ï¸ ØªØ±Ú©ÛŒØ¨ÛŒ: Ù…Ø·Ø§Ù„Ø¹Ù‡ + ØªØ³Øª</b><span id="comboKpi" class="badge">â€”</span></div>
            <div class="canvasWrap"><canvas id="comboDailyChart"></canvas></div>
          </div>
          <div class="card">
            <div class="cardHead"><b>ğŸ“ˆ Ø±ÙˆÙ†Ø¯ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡</b><span id="dailyStudyKpi" class="badge">â€”</span></div>
            <div class="canvasWrap"><canvas id="dailyStudyChart"></canvas></div>
          </div>
        </div>

        <div style="margin-top:12px;" class="grid2">
          <div class="card">
            <div class="cardHead"><b>ğŸ§ª Ø±ÙˆÙ†Ø¯ ØªØ³Øª Ø±ÙˆØ²Ø§Ù†Ù‡</b><span id="dailyTestsKpi" class="badge">â€”</span></div>
            <div class="canvasWrap"><canvas id="dailyTestsChart"></canvas></div>
          </div>
          <div class="card">
            <div class="cardHead"><b>ğŸ¥§ Ø³Ù‡Ù… Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§</b><span id="tagPieKpi" class="badge">â€”</span></div>
            <div class="canvasWrap"><canvas id="tagPieChart"></canvas></div>
          </div>
        </div>

        <div style="margin-top:12px;" class="grid2">
          <div class="card">
            <div class="cardHead"><b>ğŸ© Ø³Ù‡Ù… ØªØ³Øª Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§</b><span id="tagTestsDonutKpi" class="badge">â€”</span></div>
            <div class="canvasWrap"><canvas id="tagTestsDonut"></canvas></div>
          </div>
          <div class="card">
            <div class="cardHead"><b>ğŸ—“ï¸ Ø³Ù‡Ù… Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù‡Ø± Ø±ÙˆØ² Ø§Ø² Ù‡ÙØªÙ‡</b><span class="badge">Donut</span></div>
            <div class="canvasWrap"><canvas id="dayShareStudyDonut"></canvas></div>
          </div>
        </div>

        <div style="margin-top:12px;" class="grid2">
          <div class="card">
            <div class="cardHead"><b>ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø³/Ú©Ø§Ø± Ø¯Ø± Ù‡Ø± Ø±ÙˆØ²</b><span class="badge">Bar</span></div>
            <div class="canvasWrap"><canvas id="tasksPerDayBar"></canvas></div>
          </div>
          <div class="card">
            <div class="cardHead"><b>âœ… Ù†Ø±Ø® Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù† (Ùª) Ø¯Ø± Ù‡Ø± Ø±ÙˆØ²</b><span class="badge">Line</span></div>
            <div class="canvasWrap"><canvas id="doneRateLine"></canvas></div>
          </div>
        </div>

        <div style="margin-top:12px;" class="grid2">
          <div class="card">
            <div class="cardHead"><b>â±ï¸ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¨Ù‡ Ø§Ø²Ø§ÛŒ Ù‡Ø± Ø¯Ø±Ø³/Ú©Ø§Ø±</b><span class="badge">Line</span></div>
            <div class="canvasWrap"><canvas id="avgMinPerTaskLine"></canvas></div>
          </div>
          <div class="card">
            <div class="cardHead"><b>ğŸ“ˆ Ù…Ø·Ø§Ù„Ø¹Ù‡ ØªØ¬Ù…Ø¹ÛŒ</b><span class="badge">Area</span></div>
            <div class="canvasWrap"><canvas id="cumulativeStudyLine"></canvas></div>
          </div>
        </div>

        <div style="margin-top:12px;" class="grid2">
          <div class="card">
            <div class="cardHead"><b>ğŸ“ˆ ØªØ³Øª ØªØ¬Ù…Ø¹ÛŒ</b><span class="badge">Area</span></div>
            <div class="canvasWrap"><canvas id="cumulativeTestsLine"></canvas></div>
          </div>
          <div class="card">
            <div class="cardHead"><b>ğŸ¯ Ù¾Ø±Ø§Ú©Ù†Ø¯Ú¯ÛŒ: Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ vs ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øª</b><span class="badge">Scatter</span></div>
            <div class="canvasWrap"><canvas id="studyVsTestsScatter"></canvas></div>
          </div>
        </div>

        <div style="margin-top:12px;" class="grid2">
          <div class="card">
            <div class="cardHead"><b>ğŸ§  ØªÙ†ÙˆØ¹ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ Ø¯Ø± Ù‡Ø± Ø±ÙˆØ²</b><span class="badge">Line</span></div>
            <div class="canvasWrap"><canvas id="tagDiversityLine"></canvas></div>
          </div>
          <div class="card">
            <div class="cardHead"><b>ğŸ“¦ ØªÙˆØ²ÛŒØ¹ Ù…Ø¯Øª Ù‡Ø± Ø¯Ø±Ø³/Ú©Ø§Ø±</b><span class="badge">Histogram</span></div>
            <div class="canvasWrap"><canvas id="durationHistogramBar"></canvas></div>
          </div>
        </div>

        <div style="margin-top:12px;" class="grid2">
          <div class="card">
            <div class="cardHead"><b>âš¡ ØªØ³Øª Ø¨Ù‡ Ø§Ø²Ø§ÛŒ Ù‡Ø± Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ (Ù‡Ø± Ø±ÙˆØ²)</b><span class="badge">Bar</span></div>
            <div class="canvasWrap"><canvas id="testsPerHourBar"></canvas></div>
          </div>
          <div class="card">
            <div class="cardHead"><b>ğŸ·ï¸ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ Ø¯Ø± Ø·ÙˆÙ„ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡</b><span class="badge">Stacked</span></div>
            <div class="canvasWrap"><canvas id="stackedStudyByTag"></canvas></div>
          </div>
        </div>

        <div style="margin-top:12px;" class="grid2">
          <div class="card">
            <div class="cardHead"><b>ğŸ§ª ØªØ³Øª Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ Ø¯Ø± Ø·ÙˆÙ„ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡</b><span class="badge">Stacked</span></div>
            <div class="canvasWrap"><canvas id="stackedTestsByTag"></canvas></div>
          </div>
          <div class="card">
            <div class="cardHead"><b>ğŸ§­ Ø±Ø§Ø¯Ø§Ø± Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø±ÙˆØ²Ù‡Ø§</b><span class="badge">Radar</span></div>
            <div class="canvasWrap"><canvas id="radarStudyDays"></canvas></div>
          </div>
        </div>

        <div style="margin-top:12px;" class="grid2">
          <div class="card">
            <div class="cardHead"><b>ğŸ§­ Ø±Ø§Ø¯Ø§Ø± ØªØ³Øª Ø±ÙˆØ²Ù‡Ø§</b><span class="badge">Radar</span></div>
            <div class="canvasWrap"><canvas id="radarTestsDays"></canvas></div>
          </div>
          <div class="card">
            <div class="cardHead"><b>â€”</b><span class="badge">â€”</span></div>
            <div class="muted">Ø§ÛŒÙ† Ú©Ø§Ø±Øª Ø®Ø§Ù„ÛŒÙ‡ (Ø¨Ø±Ø§ÛŒ ØªÙˆØ³Ø¹Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø¹Ø¯ÛŒ).</div>
          </div>
        </div>
      </div>

      <!-- Weekly -->
      <div id="viewWeekly" style="display:none;">
        <div class="card">
          <div class="cardHead">
            <b>Ù‡ÙØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡</b>
            <div class="sideActions">
              <input id="weekPicker" type="week" style="max-width:220px;" />
              <button id="newWeekBtn" class="btn primary">+ Ø³Ø§Ø®Øª Ù‡ÙØªÙ‡</button>
            </div>
          </div>
          <div class="grid2">
            <div class="field"><label>Ø¹Ù†ÙˆØ§Ù† Ù‡ÙØªÙ‡</label><input id="weekTitle" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù‡ÙØªÙ‡ Ø¢Ø²Ù…ÙˆÙ† Ø¬Ø§Ù…Ø¹" /></div>
            <div class="field"><label>Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ÛŒ Ù‡ÙØªÙ‡ (Ø¨Ø§ Ú©Ø§Ù…Ø§)</label><input id="weekTags" type="text" placeholder="Ø±ÛŒØ§Ø¶ÛŒ, ÙÛŒØ²ÛŒÚ©, Ø¢Ø²Ù…ÙˆÙ†" /></div>
          </div>

          <div class="grid2">
            <div class="field"><label>Ø®Ù„Ø§ØµÙ‡ Ù‡ÙØªÙ‡</label><textarea id="weekSummary" placeholder="Ø®Ù„Ø§ØµÙ‡â€ŒØ§ÛŒ Ø§Ø² Ø¹Ù…Ù„Ú©Ø±Ø¯..."></textarea></div>
            <div class="field"><label>Ø¯Ø³ØªØ§ÙˆØ±Ø¯Ù‡Ø§</label><textarea id="weekAchievements" placeholder="Ú†Ù‡ Ú†ÛŒØ²Ù‡Ø§ÛŒÛŒ Ø®ÙˆØ¨ Ù¾ÛŒØ´ Ø±ÙØªØŸ"></textarea></div>
          </div>

          <div class="grid2">
            <div class="field"><label>Ù…ÙˆØ§Ù†Ø¹</label><textarea id="weekBlockers" placeholder="Ú†Ù‡ Ú†ÛŒØ²Ù‡Ø§ÛŒÛŒ Ù…Ø§Ù†Ø¹ Ø´Ø¯ØŸ"></textarea></div>
            <div class="field"><label>Ù‡ÙØªÙ‡ Ø¨Ø¹Ø¯</label><textarea id="weekNext" placeholder="Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÙ‡ Ø¨Ø¹Ø¯..."></textarea></div>
          </div>

          <div class="sep"></div>
          <div class="cardHead">
            <b>ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ Ù‡ÙØªÚ¯ÛŒ</b>
            <div class="sideActions">
              <button id="addWeeklyTask" class="btn primary">+ Ø§ÙØ²ÙˆØ¯Ù† ØªØ³Ú© Ù‡ÙØªÚ¯ÛŒ</button>
              <button id="deleteWeekBtn" class="btn danger">Ø­Ø°Ù Ù‡ÙØªÙ‡</button>
            </div>
          </div>
          <div id="weeklyTasks"></div>
        </div>
      </div>

      <!-- Daily -->
      <div id="viewDaily" style="display:none;">
        <div class="card">
          <div class="cardHead">
            <b>Ø«Ø¨Øª Ø¯Ø±Ø³/Ú©Ø§Ø±</b>
            <span id="dailyWeekBadge" class="badge">â€”</span>
          </div>

          <div id="dayTabs" class="pillRow"></div>
          <div class="pillRow">
            <span id="todayListBadge" class="badge">â€”</span>
            <span id="dayAutoKpi" class="badge">ğŸ“š â€” | ğŸ§ª â€” | ğŸ·ï¸ â€”</span>
          </div>

          <div class="grid2">
            <div class="card">
              <div class="cardHead"><b>Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø±Ø³/Ú©Ø§Ø± Ø§Ù…Ø±ÙˆØ²</b></div>
              <div class="field"><label>Ø¹Ù†ÙˆØ§Ù†</label><input id="lessonTitle" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø±ÛŒØ§Ø¶ÛŒ ÙØµÙ„ Û³" /></div>
              <div class="field"><label>Ø¨Ø±Ú†Ø³Ø¨</label><select id="lessonTag" data-role="tag-select"></select></div>
              <div class="grid3">
                <div class="field"><label>Ø³Ø§Ø¹Øª</label><input id="lessonHours" type="number" min="0" value="0" /></div>
                <div class="field"><label>Ø¯Ù‚ÛŒÙ‚Ù‡</label><input id="lessonMinutes" type="number" min="0" max="59" value="0" /></div>
                <div class="field"><label>ØªØ³Øª</label><input id="lessonTests" type="number" min="0" value="0" /></div>
              </div>
              <div class="field"><label>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</label><textarea id="lessonNotes" placeholder="Ø§Ø®ØªÛŒØ§Ø±ÛŒ..."></textarea></div>
              <button id="addLessonBtn" class="btn primary" style="width:100%;">+ Ø§ÙØ²ÙˆØ¯Ù†</button>
            </div>

            <div class="card">
              <div class="cardHead"><b>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø±ÙˆØ²</b></div>
              <div class="field"><label>ÙÙˆÚ©ÙˆØ³ Ø§Ù…Ø±ÙˆØ²</label><input id="dayFocus" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªØ³Øª Ø³Ø±Ø¹ØªÛŒ" /></div>
              <div class="field"><label>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</label><textarea id="dayNote" placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø±ÙˆØ²..."></textarea></div>
            </div>
          </div>

          <div class="sep"></div>
          <div class="cardHead"><b>Ù„ÛŒØ³Øª Ø§Ù…Ø±ÙˆØ²</b></div>
          <div id="dailyTasks"></div>
        </div>
      </div>

      <!-- Tags -->
      <div id="viewTags" style="display:none;">
        <div class="card">
          <div class="cardHead"><b>Ø¨Ø§Ù†Ú© Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§</b><span id="tagCount" class="badge">ØªØ¹Ø¯Ø§Ø¯: 0</span></div>
          <div class="grid2">
            <div class="field">
              <label>Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ (Ø¨Ø§ Ú©Ø§Ù…Ø§)</label>
              <input id="tagBankInput" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø±ÛŒØ§Ø¶ÛŒ, ÙÛŒØ²ÛŒÚ©, Ø¢Ø²Ù…ÙˆÙ†" />
            </div>
            <div class="sideActions" style="align-items:end;">
              <button id="tagBankAddBtn" class="btn primary">Ø§ÙØ²ÙˆØ¯Ù†</button>
              <button id="tagBankClearBtn" class="btn danger">Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ</button>
            </div>
          </div>
          <div class="sep"></div>
          <div id="tagChips" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
        </div>
      </div>

      <!-- Messages (student) -->
      <div id="viewMessages" style="display:none;">
        <div class="card">
          <div class="cardHead">
            <b>Ú¯ÙØªÚ¯Ùˆ</b>
            <span id="msgThreadBadge" class="badge">â€”</span>
          </div>
          <div id="msgHint" class="muted">â€”</div>
          <div class="sep"></div>
          <div id="msgList" class="msgList"></div>
          <div class="sep"></div>
          <div class="grid2">
            <div class="field">
              <label>Ù¾ÛŒØ§Ù…</label>
              <input id="msgText" type="text" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³..." />
            </div>
            <div style="display:flex; align-items:end;">
              <button id="msgSendBtn" class="btn primary" style="width:100%;">Ø§Ø±Ø³Ø§Ù„</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Counselor panel -->
      <div id="viewCounselor" style="display:none;">
        <div class="grid2">
          <div class="card">
            <div class="cardHead">
              <b>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</b>
              <span id="cCodeBadge" class="badge">Ú©Ø¯: â€”</span>
            </div>
            <div id="cStudentList" class="weeksList"></div>
          </div>

          <div class="card">
            <div class="cardHead">
              <b>Ú¯ÙØªÚ¯Ùˆ Ø¨Ø§</b>
              <span id="cSelectedStudent" class="badge">Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</span>
            </div>

            <div id="cMsgList" class="msgList"></div>

            <div class="sep"></div>
            <div class="field">
              <label>Ù¾ÛŒØ§Ù…</label>
              <input id="cMsgText" type="text" placeholder="Ù¾ÛŒØ§Ù… Ù…Ø´Ø§ÙˆØ±..." />
            </div>

            <div class="grid2">
              <div class="field">
                <label>Ù¾ÛŒÙˆØ³Øª PDF (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                <input id="cPdfFile" type="file" accept="application/pdf" />
                <div id="cPdfHint" class="muted" style="font-size:12px; font-weight:900;">ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</div>
              </div>
              <div style="display:flex; align-items:end;">
                <button id="cSendBtn" class="btn primary" style="width:100%;">Ø§Ø±Ø³Ø§Ù„</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>
  </main>

</div>

<!-- Auth overlay -->
<div class="authOverlay">
  <div class="authBox">
    <div class="authHead">
      <div>
        <b>ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</b>
        <div class="muted" style="font-size:12px; font-weight:900;">Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ: <span id="authHint">LocalStorage</span></div>
      </div>
      <div class="badge">ØªÚ©â€ŒÙØ§ÛŒÙ„</div>
    </div>

    <div class="tabRow">
      <button id="authModeLogin" class="tab active">ÙˆØ±ÙˆØ¯</button>
      <button id="authModeSignup" class="tab">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
    </div>

    <div class="tabRow">
      <button id="roleStudent" class="tab active">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</button>
      <button id="roleCounselor" class="tab">Ù…Ø´Ø§ÙˆØ±</button>
    </div>

    <div class="grid2">
      <div class="field"><label>Ù†Ø§Ù… (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label><input id="authName" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¹Ù„ÛŒ Ø±Ø¶Ø§ÛŒÛŒ" /></div>
      <div class="field"><label>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label><input id="authUsername" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: ali" /></div>
    </div>

    <div class="grid2">
      <div class="field"><label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label><input id="authPassword" type="password" placeholder="Ø±Ù…Ø²..." /></div>
      <div id="authPassword2Field" class="field" style="display:none;"><label>ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø²</label><input id="authPassword2" type="password" placeholder="ØªÚ©Ø±Ø§Ø±..." /></div>
    </div>

    <div id="authMentorCodeField" class="field">
      <label>Ú©Ø¯ Ù…Ø´Ø§ÙˆØ± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²)</label>
      <input id="authMentorCode" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: CNS-ABC123" />
    </div>

    <div id="authMsg" class="muted" style="font-size:12px; font-weight:900; margin:8px 0 10px;">â€”</div>

    <button id="authContinueBtn" class="btn primary" style="width:100%;">Ø§Ø¯Ø§Ù…Ù‡</button>
  </div>
</div>

<div id="toast"></div>

<script>
/* =========================================================
   Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²/Ù…Ø´Ø§ÙˆØ± (ØªÚ©â€ŒÙØ§ÛŒÙ„) â€” Ù†Ø³Ø®Ù‡ Ø³Ø§Ù„Ù… Ùˆ Ú©Ø§Ù…Ù„
========================================================= */

/* ===============================
   Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ Ùˆ Ø«Ø§Ø¨Øªâ€ŒÙ‡Ø§
=============================== */
let STORAGE_KEY = "student.analytics.drawer.v1"; // Ø¨Ø¹Ø¯ Ø§Ø² login Ø¨Ù‡ per-user ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒØ´ÙˆØ¯
const $ = (id) => document.getElementById(id);

const DAY_ORDER = [
  { key:"sat", name:"Ø´Ù†Ø¨Ù‡" },
  { key:"sun", name:"ÛŒÚ©Ø´Ù†Ø¨Ù‡" },
  { key:"mon", name:"Ø¯ÙˆØ´Ù†Ø¨Ù‡" },
  { key:"tue", name:"Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡" },
  { key:"wed", name:"Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡" },
  { key:"thu", name:"Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡" },
  { key:"fri", name:"Ø¬Ù…Ø¹Ù‡" },
];
const DAY_LABELS = DAY_ORDER.map(d => d.name);

const palette = ["#06b6d4","#7c3aed","#22c55e","#f59e0b","#ef4444","#3b82f6","#ec4899","#10b981","#a855f7","#14b8a6","#f97316","#84cc16"];

function toast(msg){
  const t = $("toast");
  if(!t) return;
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2200);
}
function nowISO(){ return new Date().toISOString(); }
function safeUUID(){
  try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch{}
  return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}
function clampInt(v, min, max){
  const n = parseInt(v ?? 0, 10);
  if (Number.isNaN(n)) return min;
  return Math.max(min, Math.min(max, n));
}
function formatHours(mins){
  const total = Math.max(0, mins|0);
  const h = Math.floor(total / 60);
  const m = total % 60;
  if (h === 0) return `${m} Ø¯Ù‚ÛŒÙ‚Ù‡`;
  if (m === 0) return `${h} Ø³Ø§Ø¹Øª`;
  return `${h}Ø³Ø§Ø¹Øª ${m}Ø¯Ù‚ÛŒÙ‚Ù‡`;
}
function normalizeTags(str){
  return (str || "").split(",").map(s => s.trim()).filter(Boolean).slice(0, 200);
}
function weekLabel(weekKey){ return String(weekKey||"").replace("-W", " / Ù‡ÙØªÙ‡ "); }
function sortWeeksDesc(keys){ return keys.sort((a,b) => b.localeCompare(a)); }
function isoWeekKey(date){
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  const ww = String(weekNo).padStart(2,"0");
  return `${d.getUTCFullYear()}-W${ww}`;
}
function getDefaultWeek(){ return isoWeekKey(new Date()); }
function isMobile(){ return window.matchMedia("(max-width: 980px)").matches; }

/* ===============================
   Drawer Ú©Ù†ØªØ±Ù„
=============================== */
function openDrawer(){ document.body.classList.add("drawer-open"); }
function closeDrawer(){ document.body.classList.remove("drawer-open"); }
function closeDrawerIfMobile(){ if(isMobile()) closeDrawer(); }

/* ===============================
   Escape Ù‡Ø§ (Ù†Ø³Ø®Ù‡ Ø³Ø§Ù„Ù…)
=============================== */
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ===============================
   AUTH + MULTI USER + CHAT
=============================== */
const APP_USERS_KEY   = "student.analytics.users.v1";
const APP_SESSION_KEY = "student.analytics.session.v1";
const APP_THREADS_KEY = "student.analytics.threads.v1";

function readJSON(key, fallback){
  try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }catch{ return fallback; }
}
function writeJSON(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
function normUsername(u){ return String(u||"").trim().toLowerCase(); }
function genCounselorCode(){ return "CNS-" + Math.random().toString(36).slice(2,8).toUpperCase(); }
function weakHash(str){
  let h = 5381;
  const s = String(str||"");
  for(let i=0;i<s.length;i++) h = ((h<<5)+h) ^ s.charCodeAt(i);
  return "wh_" + (h>>>0).toString(16);
}
async function hashPassword(pw){
  const s = String(pw||"");
  try{
    if(window.crypto && crypto.subtle){
      const enc = new TextEncoder().encode(s);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      const bytes = Array.from(new Uint8Array(buf));
      const b64 = btoa(String.fromCharCode(...bytes));
      return "sha256_" + b64;
    }
  }catch{}
  return weakHash(s);
}
function loadUsers(){ return readJSON(APP_USERS_KEY, []); }
function saveUsers(users){ writeJSON(APP_USERS_KEY, users); }
function findUser(username){
  const u = normUsername(username);
  return loadUsers().find(x => normUsername(x.username) === u) || null;
}
function saveSession(username){ writeJSON(APP_SESSION_KEY, { username: normUsername(username), at: nowISO() }); }
function loadSession(){ return readJSON(APP_SESSION_KEY, null); }
function clearSession(){ localStorage.removeItem(APP_SESSION_KEY); }
function userStateKey(username){ return "student.analytics.state.v2::" + normUsername(username); }

let threads = readJSON(APP_THREADS_KEY, {});
function saveThreads(){ writeJSON(APP_THREADS_KEY, threads); }

function threadKey(counselorCode, studentUsername){
  return "t::" + String(counselorCode||"").trim().toUpperCase() + "::" + normUsername(studentUsername);
}
function ensureThread(counselorCode, studentUsername){
  const k = threadKey(counselorCode, studentUsername);
  if(!threads[k]){
    threads[k] = { counselorCode: String(counselorCode||"").trim().toUpperCase(), studentUsername: normUsername(studentUsername), messages: [] };
    saveThreads();
  }
  return threads[k];
}

let activeUser = null; // {username, role, name, mentorCode?, counselorCode?}
let counselorSelectedStudent = null;
let counselorPendingPdf = null;

function openAuth(){ document.body.classList.add("auth-open"); }
function closeAuth(){ document.body.classList.remove("auth-open"); }

/* ===============================
   Ù…Ø¯Ù„ Ø¯Ø§Ø¯Ù‡ Ù¾Ø§ÛŒØ¯Ø§Ø±
=============================== */
function normalizeTaskInPlace(t){
  if(!t || typeof t !== "object") return null;
  if(!t.id) t.id = safeUUID();
  if(t.text == null) t.text = "";
  t.done = !!t.done;
  if(t.tag == null) t.tag = "";
  t.hours   = clampInt(t.hours ?? 0, 0, 9999);
  t.minutes = clampInt(t.minutes ?? 0, 0, 59);
  t.tests   = clampInt(t.tests ?? 0, 0, 999999);
  if(t.notes == null) t.notes = "";
  if(!t.createdAt) t.createdAt = nowISO();
  t.updatedAt = nowISO();
  return t;
}
function taskMinutes(t){ return clampInt(t.hours,0,9999)*60 + clampInt(t.minutes,0,59); }

function ensureWeekInPlace(state, weekKey){
  if(!state.weeks) state.weeks = {};
  if(!state.weeks[weekKey]){
    state.weeks[weekKey] = {
      week: weekKey, title: "", tags: [], summary: "", achievements: "", blockers: "", next: "",
      weeklyTasks: [], days: {}, createdAt: nowISO(), updatedAt: nowISO(),
    };
  }
  const w = state.weeks[weekKey];

  if(!Array.isArray(w.tags)) w.tags = [];
  if(!Array.isArray(w.weeklyTasks)) w.weeklyTasks = [];
  for(let i=0;i<w.weeklyTasks.length;i++){
    if(!w.weeklyTasks[i] || typeof w.weeklyTasks[i] !== "object"){ w.weeklyTasks[i] = { id: safeUUID() }; }
    normalizeTaskInPlace(w.weeklyTasks[i]);
  }

  if(!w.days || typeof w.days !== "object") w.days = {};
  for(const d of DAY_ORDER){
    if(!w.days[d.key]) w.days[d.key] = { note:"", focus:"", tasks:[] };
    const day = w.days[d.key];
    if(!Array.isArray(day.tasks)) day.tasks = [];
    for(let i=0;i<day.tasks.length;i++){
      if(!day.tasks[i] || typeof day.tasks[i] !== "object"){ day.tasks[i] = { id: safeUUID() }; }
      normalizeTaskInPlace(day.tasks[i]);
    }
    if(day.note == null) day.note = "";
    if(day.focus == null) day.focus = "";
  }

  return w;
}

function normalizeAllStateInPlace(s){
  if(!s || typeof s !== "object") s = {};
  if(!s.theme) s.theme = "dark";
  if(!Array.isArray(s.tagBank)) s.tagBank = [];
  if(!s.settings) s.settings = { topTagsN: 8, goalStudyMin: 0, goalTests: 0 };
  if(!("topTagsN" in s.settings)) s.settings.topTagsN = 8;
  if(!("goalStudyMin" in s.settings)) s.settings.goalStudyMin = 0;
  if(!("goalTests" in s.settings)) s.settings.goalTests = 0;
  if(!s.weeklyTrendMode) s.weeklyTrendMode = "study";
  if(!s.weeks) s.weeks = {};
  for(const wk of Object.keys(s.weeks)) ensureWeekInPlace(s, wk);
  if(!s.lastWeek) s.lastWeek = "";
  return s;
}

/* ===============================
   Ø°Ø®ÛŒØ±Ù‡/Ù„ÙˆØ¯ (Ù¾Ø±-Ú©Ø§Ø±Ø¨Ø±)
=============================== */
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return normalizeAllStateInPlace({ theme:"dark", weeks:{}, tagBank:[], weeklyTrendMode:"study", settings:{ topTagsN:8, goalStudyMin:0, goalTests:0 }, lastWeek:"" });
    return normalizeAllStateInPlace(JSON.parse(raw));
  }catch{
    return normalizeAllStateInPlace({ theme:"dark", weeks:{}, tagBank:[], weeklyTrendMode:"study", settings:{ topTagsN:8, goalStudyMin:0, goalTests:0 }, lastWeek:"" });
  }
}
function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function setDirty(on){
  const sb = $("saveBadge");
  if(!sb) return;
  sb.textContent = on ? "Ø°Ø®ÛŒØ±Ù‡..." : "Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯";
  sb.style.borderColor = on ? "rgba(245,158,11,.35)" : "";
}

let state = normalizeAllStateInPlace({ theme:"dark", weeks:{}, tagBank:[], weeklyTrendMode:"study", settings:{ topTagsN:8, goalStudyMin:0, goalTests:0 }, lastWeek:"" });
let currentWeek = "";
let currentDayKey = "sat";

/* ===============================
   Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§
=============================== */
function addTagsToBank(tags){
  const arr = Array.isArray(tags) ? tags : normalizeTags(tags);
  let changed = false;
  for(const t of arr){
    const v = (t||"").trim();
    if(!v) continue;
    if(!state.tagBank.some(x => x.toLowerCase() === v.toLowerCase())){
      state.tagBank.push(v);
      changed = true;
    }
  }
  if(changed) persist();
  return changed;
}
function populateTagSelect(selectEl, current){
  const v = current || "";
  selectEl.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "ğŸ·ï¸ Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø±Ú†Ø³Ø¨...";
  selectEl.appendChild(opt0);
  for(const tag of state.tagBank){
    const o = document.createElement("option");
    o.value = tag;
    o.textContent = "ğŸ·ï¸ " + tag;
    selectEl.appendChild(o);
  }
  selectEl.value = v;
}
function refreshAllTagSelects(){
  document.querySelectorAll("select[data-role='tag-select']").forEach(sel => {
    const cur = sel.value;
    populateTagSelect(sel, cur);
  });
}

/* ===============================
   Ù…Ø­Ø§Ø³Ø¨Ø§Øª
=============================== */
function computeDayTotals(w, dayKey){
  const d = w.days[dayKey];
  let studyMin = 0, tests = 0;
  const tagsSet = new Set();
  let tasksCount = 0, doneCount = 0;
  for(const t of d.tasks){
    tasksCount++;
    if(t.done) doneCount++;
    studyMin += taskMinutes(t);
    tests += clampInt(t.tests,0,999999);
    if(t.tag) tagsSet.add(String(t.tag).toLowerCase());
  }
  return { studyMin, tests, tags: tagsSet.size, tasksCount, doneCount };
}
function computeWeekTotals(w){
  let studyMin = 0, tests = 0;
  const tags = new Set();
  let tasksCount = 0, doneCount = 0;
  for(const d of DAY_ORDER){
    const dt = computeDayTotals(w, d.key);
    studyMin += dt.studyMin; tests += dt.tests;
    tasksCount += dt.tasksCount; doneCount += dt.doneCount;
    for(const t of w.days[d.key].tasks){ if(t.tag) tags.add(String(t.tag).toLowerCase()); }
  }
  for(const t of w.weeklyTasks){
    tasksCount++;
    if(t.done) doneCount++;
    studyMin += taskMinutes(t);
    tests += clampInt(t.tests,0,999999);
    if(t.tag) tags.add(String(t.tag).toLowerCase());
  }
  return { studyMin, tests, tags: tags.size, tasksCount, doneCount };
}
function computeTagAggregatesForWeek(w){
  const byTagStudy = new Map();
  const byTagTests = new Map();
  const add = (tag, mins, tests)=>{
    const t = (tag||"").trim() || "Ø¨Ø¯ÙˆÙ† Ø¨Ø±Ú†Ø³Ø¨";
    byTagStudy.set(t, (byTagStudy.get(t)||0) + (mins||0));
    byTagTests.set(t, (byTagTests.get(t)||0) + (tests||0));
  };

  for(const d of DAY_ORDER){
    const day=w.days[d.key];
    for(const t of day.tasks) add(t.tag, taskMinutes(t), clampInt(t.tests,0,999999));
  }
  for(const t of w.weeklyTasks) add(t.tag, taskMinutes(t), clampInt(t.tests,0,999999));

  const entriesStudy = Array.from(byTagStudy.entries()).sort((a,b)=>b[1]-a[1]);
  const entriesTests = Array.from(byTagTests.entries()).sort((a,b)=>b[1]-a[1]);
  const totalStudy = entriesStudy.reduce((a,[,v])=>a+v,0);
  const totalTests = entriesTests.reduce((a,[,v])=>a+v,0);
  return { entriesStudy, entriesTests, totalStudy, totalTests };
}

/* ===============================
   Flush Ù‚Ø·Ø¹ÛŒ
=============================== */
function flushAll(){
  if(!currentWeek || !state.weeks[currentWeek]) return;
  const w = state.weeks[currentWeek];
  const day = w.days[currentDayKey];

  if($("dayNote")) day.note = $("dayNote").value || "";
  if($("dayFocus")) day.focus = $("dayFocus").value || "";

  if($("weekTitle")) w.title = $("weekTitle").value || "";
  if($("weekTags")) w.tags = normalizeTags($("weekTags").value || "");
  if($("weekSummary")) w.summary = $("weekSummary").value || "";
  if($("weekAchievements")) w.achievements = $("weekAchievements").value || "";
  if($("weekBlockers")) w.blockers = $("weekBlockers").value || "";
  if($("weekNext")) w.next = $("weekNext").value || "";
  w.updatedAt = nowISO();

  addTagsToBank(w.tags);
  persist();
  setDirty(false);
}

/* ===============================
   Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ù‡ÙØªÙ‡â€ŒÙ‡Ø§
=============================== */
function renderWeeksList(filterText=""){
  const list = $("weeksList");
  if(!list) return;

  const keys = sortWeeksDesc(Object.keys(state.weeks||{}));
  list.innerHTML = "";

  const q = (filterText||"").trim().toLowerCase();
  const filtered = keys.filter(k=>{
    if(!q) return true;
    const w = state.weeks[k];
    const hay = [
      k, w.title, (w.tags||[]).join(","), w.summary, w.achievements, w.blockers, w.next,
      (w.weeklyTasks||[]).map(t=>`${t.text} ${t.tag} ${t.notes}`).join(" "),
      ...DAY_ORDER.map(d=>w.days[d.key].tasks.map(t=>`${t.text} ${t.tag} ${t.notes}`).join(" ")),
    ].join(" ").toLowerCase();
    return hay.includes(q);
  });

  if(filtered.length===0){
    list.innerHTML = `<div class="muted" style="padding:10px; font-weight:900;">${q ? "Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯." : "Ù‡Ù†ÙˆØ² Ú¯Ø²Ø§Ø±Ø´ÛŒ Ù†Ø¯Ø§Ø±ÛŒ. Ø±ÙˆÛŒ + Ø¨Ø²Ù†."}</div>`;
    return;
  }

  for(const k of filtered){
    const w = state.weeks[k];
    const totals = computeWeekTotals(w);
    const el = document.createElement("div");
    el.className = "weekItem" + (k===currentWeek ? " active" : "");
    el.onclick = () => selectWeek(k);
    const title = (w.title||"").trim() || "Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†";
    el.innerHTML = `
      <div style="min-width:0;">
        <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(title)}</div>
        <div class="muted" style="font-size:12px;">${escapeHtml(weekLabel(k))}</div>
      </div>
      <div style="display:flex; flex-direction:column; gap:4px; align-items:flex-end;">
        <span class="badge">ğŸ“š ${escapeHtml(formatHours(totals.studyMin))}</span>
        <span class="badge">ğŸ§ª ${totals.tests}</span>
      </div>
    `;
    list.appendChild(el);
  }
}

/* ===============================
   Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡
=============================== */
function renderDayTabs(){
  const tabs = $("dayTabs");
  if(!tabs) return;
  tabs.innerHTML = "";
  for(const d of DAY_ORDER){
    const b = document.createElement("button");
    b.type = "button";
    b.className = "btn" + (d.key===currentDayKey ? " primary" : "");
    b.textContent = d.name;
    b.onclick = () => {
      flushAll();
      currentDayKey = d.key;
      renderDayTabs();
      loadDayToUI(d.key);
      toast("Ø±ÙˆØ² ØªØºÛŒÛŒØ± Ú©Ø±Ø¯ Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…");
      closeDrawerIfMobile();
    };
    tabs.appendChild(b);
  }
}
function loadDayToUI(dayKey){
  if(!currentWeek || !state.weeks[currentWeek]) return;
  const w = state.weeks[currentWeek];
  const day = w.days[dayKey];

  $("dayNote").value = day.note || "";
  $("dayFocus").value = day.focus || "";
  renderDailyTasks();
  updateDayAutoKpi();
}

/* ===============================
   Ø³Ø§Ø®Øª TaskCard
=============================== */
function makeField(labelText, inputEl){
  const wrap = document.createElement("div");
  wrap.className = "field";
  const lab = document.createElement("label");
  lab.textContent = labelText;
  wrap.appendChild(lab);
  wrap.appendChild(inputEl);
  return wrap;
}
function createTaskCard(task, onAnyChange, onDelete){
  const card = document.createElement("div");
  card.className = "taskCard" + (task.done ? " done" : "");
  const top = document.createElement("div");
  top.className = "taskTop";

  const row1 = document.createElement("div");
  row1.className = "taskRow";

  const left = document.createElement("div");
  left.className = "taskLeft";

  const cb = document.createElement("input");
  cb.type="checkbox";
  cb.checked = !!task.done;
  cb.onchange = () => {
    task.done = cb.checked;
    task.updatedAt = nowISO();
    card.classList.toggle("done", task.done);
    onAnyChange();
  };

  const titleBox = document.createElement("div");
  titleBox.className = "taskTitle";
  const ti = document.createElement("input");
  ti.type="text";
  ti.value = task.text || "";
  ti.placeholder = "Ø¹Ù†ÙˆØ§Ù† Ø¯Ø±Ø³/Ú©Ø§Ø±â€¦";
  ti.oninput = () => {
    task.text = ti.value;
    task.updatedAt = nowISO();
    onAnyChange();
  };
  titleBox.appendChild(ti);

  left.appendChild(cb);
  left.appendChild(titleBox);
  row1.appendChild(left);

  const controls = document.createElement("div");
  controls.className = "controlsGrid";

  const tagSelect = document.createElement("select");
  tagSelect.dataset.role="tag-select";
  populateTagSelect(tagSelect, task.tag);
  tagSelect.onchange = () => {
    task.tag = tagSelect.value;
    task.updatedAt = nowISO();
    onAnyChange();
  };

  const hIn = document.createElement("input");
  hIn.type="number"; hIn.min="0"; hIn.step="1";
  hIn.value = String(task.hours ?? 0);
  hIn.oninput = () => {
    task.hours = clampInt(hIn.value,0,9999);
    task.updatedAt = nowISO();
    onAnyChange();
  };

  const mIn = document.createElement("input");
  mIn.type="number"; mIn.min="0"; mIn.max="59"; mIn.step="1";
  mIn.value = String(task.minutes ?? 0);
  mIn.oninput = () => {
    task.minutes = clampInt(mIn.value,0,59);
    task.updatedAt = nowISO();
    onAnyChange();
  };

  const tIn = document.createElement("input");
  tIn.type="number"; tIn.min="0"; tIn.step="1";
  tIn.value = String(task.tests ?? 0);
  tIn.oninput = () => {
    task.tests = clampInt(tIn.value,0,999999);
    task.updatedAt = nowISO();
    onAnyChange();
  };

  const actions = document.createElement("div");
  actions.className="actions";

  const toggle = document.createElement("button");
  toggle.type="button";
  toggle.className="iconBtn";
  toggle.title="ÛŒØ§Ø¯Ø¯Ø§Ø´Øª";
  toggle.textContent="ğŸ“";
  toggle.onclick = () => {
    card.classList.toggle("open");
    onAnyChange();
  };

  const del = document.createElement("button");
  del.type="button";
  del.className="iconBtn";
  del.title="Ø­Ø°Ù";
  del.textContent="âœ–ï¸";
  del.onclick = () => {
    if(!confirm("Ø§ÛŒÙ† Ø¢ÛŒØªÙ… Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) return;
    onDelete();
    card.remove();
    onAnyChange();
  };

  actions.appendChild(toggle);
  actions.appendChild(del);

  controls.appendChild(makeField("Ø¨Ø±Ú†Ø³Ø¨", tagSelect));
  controls.appendChild(makeField("Ø³Ø§Ø¹Øª", hIn));
  controls.appendChild(makeField("Ø¯Ù‚ÛŒÙ‚Ù‡", mIn));
  controls.appendChild(makeField("ØªØ³Øª", tIn));
  controls.appendChild(actions);

  const details = document.createElement("div");
  details.className="taskDetails";
  const ta = document.createElement("textarea");
  ta.placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øª/ØªÙˆØ¶ÛŒØ­Ø§Øªâ€¦";
  ta.value = task.notes || "";
  ta.oninput = () => {
    task.notes = ta.value;
    task.updatedAt = nowISO();
    onAnyChange();
  };
  details.appendChild(ta);

  top.appendChild(row1);
  top.appendChild(controls);
  card.appendChild(top);
  card.appendChild(details);

  return card;
}

/* ===============================
   Ø±Ù†Ø¯Ø± ØªØ³Ú©â€ŒÙ‡Ø§
=============================== */
function renderWeeklyTasks(){
  const wrap = $("weeklyTasks");
  if(!wrap) return;

  wrap.innerHTML = "";
  if(!currentWeek || !state.weeks[currentWeek]){
    wrap.innerHTML = `<div class="muted" style="font-weight:900;">ÛŒÚ© Ù‡ÙØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.</div>`;
    return;
  }
  const w = state.weeks[currentWeek];

  if(w.weeklyTasks.length===0){
    wrap.innerHTML = `<div class="muted" style="font-weight:900;">ØªØ³Ú© Ù‡ÙØªÚ¯ÛŒ Ù†Ø¯Ø§Ø±ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒÙ‡).</div>`;
    refreshAllTagSelects();
    return;
  }

  for(const t of w.weeklyTasks){
    const card = createTaskCard(
      t,
      () => {
        setDirty(true);
        w.updatedAt = nowISO();
        persist();
        updateEverything(true);
        renderWeeksList($("searchBox")?.value || "");
        setDirty(false);
      },
      () => {
        w.weeklyTasks = w.weeklyTasks.filter(x => x.id !== t.id);
        w.updatedAt = nowISO();
        persist();
      }
    );
    wrap.appendChild(card);
  }
  refreshAllTagSelects();
}
function renderDailyTasks(){
  const wrap = $("dailyTasks");
  if(!wrap) return;

  wrap.innerHTML = "";
  if(!currentWeek || !state.weeks[currentWeek]){
    wrap.innerHTML = `<div class="muted" style="font-weight:900;">ÛŒÚ© Ù‡ÙØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.</div>`;
    $("todayListBadge").textContent = "â€”";
    refreshAllTagSelects();
    return;
  }
  const w = state.weeks[currentWeek];
  const d = w.days[currentDayKey];
  const dt = computeDayTotals(w, currentDayKey);

  $("todayListBadge").textContent = `ğŸ“š ${formatHours(dt.studyMin)} â€¢ ğŸ§ª ${dt.tests}`;

  if(d.tasks.length===0){
    wrap.innerHTML = `<div class="muted" style="font-weight:900;">Ù‡Ù†ÙˆØ² Ú†ÛŒØ²ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯ÛŒ. Ø§Ø² Ø¨Ø®Ø´ Â«Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø±Ø³/Ú©Ø§Ø± Ø§Ù…Ø±ÙˆØ²Â» Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù† âœ…</div>`;
    refreshAllTagSelects();
    return;
  }

  for(const t of d.tasks){
    const card = createTaskCard(
      t,
      () => {
        setDirty(true);
        w.updatedAt = nowISO();
        persist();
        updateEverything(true);
        renderWeeksList($("searchBox")?.value || "");
        setDirty(false);
      },
      () => {
        d.tasks = d.tasks.filter(x => x.id !== t.id);
        w.updatedAt = nowISO();
        persist();
      }
    );
    wrap.appendChild(card);
  }
  refreshAllTagSelects();
}

/* ===============================
   Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ UI
=============================== */
function renderTagBank(){
  const chips = $("tagChips");
  if(!chips) return;

  $("tagCount").textContent = `ØªØ¹Ø¯Ø§Ø¯: ${state.tagBank.length}`;
  chips.innerHTML = "";

  if(state.tagBank.length===0){
    chips.innerHTML = `<div class="muted" style="font-weight:900;">Ù‡Ù†ÙˆØ² Ø¨Ø±Ú†Ø³Ø¨ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯ÛŒ.</div>`;
    return;
  }

  for(const t of state.tagBank){
    const chip = document.createElement("span");
    chip.className="badge";
    chip.style.display="inline-flex";
    chip.style.alignItems="center";
    chip.style.gap="8px";
    chip.innerHTML = `ğŸ·ï¸ ${escapeHtml(t)} <span style="opacity:.9; cursor:pointer;">Ã—</span>`;
    chip.querySelector("span").onclick = () => {
      if(!confirm("Ø§ÛŒÙ† Ø¨Ø±Ú†Ø³Ø¨ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) return;
      const low = t.toLowerCase();
      state.tagBank = state.tagBank.filter(x => x.toLowerCase() !== low);
      for(const wk of Object.keys(state.weeks)){
        const w = state.weeks[wk];
        for(const tt of w.weeklyTasks){ if((tt.tag||"").toLowerCase()===low) tt.tag=""; }
        for(const d of DAY_ORDER){
          for(const ts of w.days[d.key].tasks){ if((ts.tag||"").toLowerCase()===low) ts.tag=""; }
        }
      }
      persist();
      renderTagBank();
      refreshAllTagSelects();
      updateEverything(true);
      toast("Ø¨Ø±Ú†Ø³Ø¨ Ø­Ø°Ù Ø´Ø¯");
    };
    chips.appendChild(chip);
  }
}

/* ===============================
   KPI Ù‡Ø§
=============================== */
function updateDayAutoKpi(){
  if(!currentWeek || !state.weeks[currentWeek]){
    $("dayAutoKpi").textContent = "ğŸ“š â€” | ğŸ§ª â€” | ğŸ·ï¸ â€”";
    return;
  }
  const w = state.weeks[currentWeek];
  const dt = computeDayTotals(w, currentDayKey);
  $("dayAutoKpi").textContent = `ğŸ“š ${formatHours(dt.studyMin)} | ğŸ§ª ${dt.tests} | ğŸ·ï¸ ${dt.tags}`;
}
function updateKpis(){
  if(!currentWeek || !state.weeks[currentWeek]){
    $("kpiWeek").textContent = "â€”";
    $("kpiSummary").textContent = "ÛŒÚ© Ù‡ÙØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ØªØ§ ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø¨Ø´Ù‡.";
    $("kpiStudy").textContent = "ğŸ“š Ù…Ø·Ø§Ù„Ø¹Ù‡: â€”";
    $("kpiTests").textContent = "ğŸ§ª ØªØ³Øª: â€”";
    $("kpiTags").textContent = "ğŸ·ï¸ Ø¨Ø±Ú†Ø³Ø¨: â€”";
    $("weeklyStatsBadge").textContent = "â€”";
    $("progressBadge").textContent = "â€”";
    $("dailyWeekBadge").textContent = "â€”";
    $("currentWeekBadge").textContent = "Week --";
    return;
  }
  const w = state.weeks[currentWeek];
  const totals = computeWeekTotals(w);

  $("kpiWeek").textContent = weekLabel(w.week);
  $("kpiSummary").textContent = (w.summary||"").trim() ? w.summary.trim() : "Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù‡ÙØªÙ‡ Ø®Ù„Ø§ØµÙ‡â€ŒØ§ÛŒ Ù†Ù†ÙˆØ´ØªÛŒ.";
  $("kpiStudy").textContent = `ğŸ“š Ù…Ø·Ø§Ù„Ø¹Ù‡: ${formatHours(totals.studyMin)}`;
  $("kpiTests").textContent = `ğŸ§ª ØªØ³Øª: ${totals.tests}`;
  $("kpiTags").textContent = `ğŸ·ï¸ Ø¨Ø±Ú†Ø³Ø¨: ${totals.tags}`;
  $("weeklyStatsBadge").textContent = `ğŸ“š ${formatHours(totals.studyMin)} â€¢ ğŸ§ª ${totals.tests} â€¢ ğŸ·ï¸ ${totals.tags}`;
  $("dailyWeekBadge").textContent = weekLabel(currentWeek);
  $("currentWeekBadge").textContent = "Week " + currentWeek;

  const gs = clampInt(state.settings.goalStudyMin,0,9999999);
  const gt = clampInt(state.settings.goalTests,0,999999999);
  if(gs || gt){
    const ps = gs ? Math.min(100, Math.round((totals.studyMin/gs)*100)) : 0;
    const pt = gt ? Math.min(100, Math.round((totals.tests/gt)*100)) : 0;
    $("progressBadge").textContent = `Ù…Ø·Ø§Ù„Ø¹Ù‡: ${gs?ps:"â€”"}% â€¢ ØªØ³Øª: ${gt?pt:"â€”"}%`;
  }else{
    $("progressBadge").textContent = "Ù‡Ø¯Ù ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡";
  }
}
function updateEverything(updateChartsAlso=false){
  updateKpis();
  updateDayAutoKpi();
  if(updateChartsAlso) updateCharts(false);
}

/* ===============================
   Ù‡ÙØªÙ‡â€ŒÙ‡Ø§: Ø§Ù†ØªØ®Ø§Ø¨/Ø³Ø§Ø®Øª/Ø­Ø°Ù
=============================== */
function selectWeek(weekKey){
  if(!weekKey) return;
  if(!state.weeks[weekKey]) ensureWeekInPlace(state, weekKey);

  flushAll();
  currentWeek = weekKey;
  state.lastWeek = weekKey;

  persist();

  // sync week picker
  if($("weekPicker")) $("weekPicker").value = weekKey;

  // load weekly fields
  loadWeekToUI();

  // daily
  renderDayTabs();
  loadDayToUI(currentDayKey);

  // sidebar list
  renderWeeksList($("searchBox")?.value || "");

  updateEverything(true);
  toast("Ù‡ÙØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯ âœ…");
  closeDrawerIfMobile();
}
function loadWeekToUI(){
  if(!currentWeek || !state.weeks[currentWeek]) return;
  const w = state.weeks[currentWeek];

  $("weekTitle").value = w.title || "";
  $("weekTags").value = (w.tags||[]).join(", ");
  $("weekSummary").value = w.summary || "";
  $("weekAchievements").value = w.achievements || "";
  $("weekBlockers").value = w.blockers || "";
  $("weekNext").value = w.next || "";

  renderWeeklyTasks();
  refreshAllTagSelects();
}
function createWeek(weekKey){
  if(!weekKey) weekKey = getDefaultWeek();
  if(!state.weeks[weekKey]) ensureWeekInPlace(state, weekKey);
  persist();
  selectWeek(weekKey);
}
function deleteCurrentWeek(){
  if(!currentWeek) return;
  if(!confirm("Ø§ÛŒÙ† Ù‡ÙØªÙ‡ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) return;
  delete state.weeks[currentWeek];
  persist();

  const keys = sortWeeksDesc(Object.keys(state.weeks||{}));
  currentWeek = keys[0] || "";
  state.lastWeek = currentWeek || "";

  persist();
  renderWeeksList($("searchBox")?.value || "");
  if(currentWeek) selectWeek(currentWeek);
  else{
    updateEverything(true);
    $("weeklyTasks").innerHTML = "";
    $("dailyTasks").innerHTML = "";
    toast("Ù‡ÙØªÙ‡ Ø­Ø°Ù Ø´Ø¯");
  }
}

/* ===============================
   Auth UI + Role UI
=============================== */
let authMode = "login"; // login | signup
let authRole = "student"; // student | counselor

function setAuthMode(mode){
  authMode = mode;
  $("authModeLogin").classList.toggle("active", mode==="login");
  $("authModeSignup").classList.toggle("active", mode==="signup");
  $("authPassword2Field").style.display = (mode==="signup") ? "" : "none";
  $("authMsg").textContent = (mode==="login") ? "Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ØŒ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ø±Ù…Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†." : "Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ Ú©Ø§Ù…Ù„ Ú©Ù†.";
}
function setAuthRole(role){
  authRole = role;
  $("roleStudent").classList.toggle("active", role==="student");
  $("roleCounselor").classList.toggle("active", role==="counselor");
  $("authMentorCodeField").style.display = (role==="student") ? "" : "none";
}
function applyRoleUI(){
  const role = activeUser?.role || "";
  const isCounselor = role === "counselor";

  $("navCounselor").style.display = isCounselor ? "" : "none";

  // Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒâ€ŒÙ‡Ø§
  $("navDashboard").style.display = isCounselor ? "none" : "";
  $("navWeekly").style.display = isCounselor ? "none" : "";
  $("navDaily").style.display = isCounselor ? "none" : "";
  $("navTags").style.display = isCounselor ? "none" : "";
  $("navMessages").style.display = isCounselor ? "none" : "";

  // Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØµÙˆØµ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
  $("weekPill").style.display = isCounselor ? "none" : "";
  $("searchPill").style.display = isCounselor ? "none" : "";
  $("weeksList").style.display = isCounselor ? "none" : "";
  $("studentSep").style.display = isCounselor ? "none" : "";
  $("studentSideActions1").style.display = isCounselor ? "none" : "";
  $("studentSideActions2").style.display = isCounselor ? "none" : "";
  $("studentStorageHint").style.display = isCounselor ? "none" : "";

  // Ø¨Ø§Ø¬â€ŒÙ‡Ø§
  $("currentWeekBadge").style.display = isCounselor ? "none" : "";
  $("saveBadge").style.display = isCounselor ? "none" : "";

  // ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
  $("mentorCodeField").classList.toggle("hidden", isCounselor);
  $("counselorCodeField").classList.toggle("hidden", !isCounselor);

  $("profileRoleBadge").textContent = isCounselor ? "Ù…Ø´Ø§ÙˆØ±" : "Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²";
  $("profileUserBadge").textContent = activeUser ? ("@" + activeUser.username) : "â€”";
  $("profileNameBadge").textContent = activeUser?.name ? activeUser.name : "â€”";

  if(isCounselor){
    $("counselorCodeInput").value = activeUser?.counselorCode || "â€”";
    $("cCodeBadge").textContent = "Ú©Ø¯: " + (activeUser?.counselorCode || "â€”");
  }else{
    $("mentorCodeInput").value = activeUser?.mentorCode || "";
  }

  // Views
  if(isCounselor){
    showView("counselor");
  }else{
    showView("dashboard");
  }
}

/* ===============================
   Views
=============================== */
function setNavActive(id){
  document.querySelectorAll(".navBtnX").forEach(el => el.classList.remove("active"));
  $(id)?.classList.add("active");
}
function showView(name){
  const map = {
    dashboard: "viewDashboard",
    weekly: "viewWeekly",
    daily: "viewDaily",
    tags: "viewTags",
    messages: "viewMessages",
    counselor: "viewCounselor",
  };
  for(const k of Object.keys(map)){
    const el = $(map[k]);
    if(el) el.style.display = (k===name) ? "" : "none";
  }

  if(name==="dashboard"){ $("mainTitle").textContent = "ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯"; setNavActive("navDashboard"); updateEverything(true); }
  if(name==="weekly"){ $("mainTitle").textContent = "ğŸ“ Ø¨Ø®Ø´ Ù‡ÙØªÚ¯ÛŒ"; setNavActive("navWeekly"); }
  if(name==="daily"){ $("mainTitle").textContent = "ğŸ“… Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡"; setNavActive("navDaily"); }
  if(name==="tags"){ $("mainTitle").textContent = "ğŸ·ï¸ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§"; setNavActive("navTags"); renderTagBank(); }
  if(name==="messages"){ $("mainTitle").textContent = "ğŸ’¬ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§"; setNavActive("navMessages"); renderStudentMessages(); }
  if(name==="counselor"){ $("mainTitle").textContent = "ğŸ§‘â€ğŸ« Ù¾Ù†Ù„ Ù…Ø´Ø§ÙˆØ±"; setNavActive("navCounselor"); renderCounselorStudents(); }
  closeDrawerIfMobile();
}

/* ===============================
   Chat
=============================== */
function postMessage({counselorCode, studentUsername, fromRole, fromUser, text, attachments=[]}){
  const th = ensureThread(counselorCode, studentUsername);
  th.messages.push({
    id: safeUUID(),
    fromRole,
    fromUser,
    text: String(text||"").trim(),
    attachments,
    createdAt: nowISO()
  });
  saveThreads();
}

function renderStudentMessages(){
  const list = $("msgList");
  if(!list) return;
  list.innerHTML = "";

  if(!activeUser || activeUser.role!=="student"){
    $("msgThreadBadge").textContent = "â€”";
    $("msgHint").textContent = "ÙÙ‚Ø· Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø±Ø§ Ø¨Ø¨ÛŒÙ†Ø¯.";
    return;
  }

  const mentorCode = (activeUser?.mentorCode || "").trim().toUpperCase();
  if(!mentorCode){
    $("msgThreadBadge").textContent = "Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙˆØ±";
    $("msgHint").textContent = "Ú©Ø¯ Ù…Ø´Ø§ÙˆØ± Ø±Ø§ Ø§Ø² Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± ÙˆØ§Ø±Ø¯ Ú©Ù† ØªØ§ Ú¯ÙØªÚ¯Ùˆ ÙØ¹Ø§Ù„ Ø´ÙˆØ¯.";
    list.innerHTML = `<div class="muted" style="font-weight:900;">Ù‡Ù†ÙˆØ² Ú¯ÙØªÚ¯Ùˆ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª.</div>`;
    return;
  }

  $("msgThreadBadge").textContent = "Ú©Ø¯: " + mentorCode;
  $("msgHint").textContent = "Ú¯ÙØªÚ¯Ùˆ ÙØ¹Ø§Ù„ Ø§Ø³Øª.";

  const th = ensureThread(mentorCode, activeUser.username);
  if(th.messages.length === 0){
    list.innerHTML = `<div class="muted" style="font-weight:900;">Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ù…ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.</div>`;
    return;
  }

  for(const m of th.messages){
    const who = (m.fromRole === "student") ? "me" : "them";
    const div = document.createElement("div");
    div.className = "msg " + who;

    let filesHtml = "";
    if(Array.isArray(m.attachments) && m.attachments.length){
      filesHtml = `<div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">` +
        m.attachments.map(a=>{
          const nm = escapeHtml(a.name || "file.pdf");
          const href = a.dataUrl ? a.dataUrl : "#";
          return `<a class="fileChip" href="${href}" target="_blank" rel="noopener">ğŸ“ ${nm}</a>`;
        }).join("") +
        `</div>`;
    }

    div.innerHTML = `
      <div>${escapeHtml(m.text || "")}</div>
      ${filesHtml}
      <div class="msgMeta">
        <span>${escapeHtml(m.fromRole === "student" ? "Ø´Ù…Ø§" : "Ù…Ø´Ø§ÙˆØ±")}</span>
        <span>${escapeHtml(new Date(m.createdAt).toLocaleString("fa-IR"))}</span>
      </div>
    `;
    list.appendChild(div);
  }
  list.scrollTop = list.scrollHeight;
}

function renderCounselorChat(){
  const list = $("cMsgList");
  if(!list) return;
  list.innerHTML = "";

  const code = (activeUser?.counselorCode || "").trim().toUpperCase();
  if(!counselorSelectedStudent){
    $("cSelectedStudent").textContent = "Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡";
    list.innerHTML = `<div class="muted" style="font-weight:900;">ÛŒÚ© Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.</div>`;
    return;
  }

  $("cSelectedStudent").textContent = "@" + counselorSelectedStudent;
  const th = ensureThread(code, counselorSelectedStudent);

  if(th.messages.length===0){
    list.innerHTML = `<div class="muted" style="font-weight:900;">Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ù…ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>`;
    return;
  }

  for(const m of th.messages){
    const who = (m.fromRole === "counselor") ? "me" : "them";
    const div = document.createElement("div");
    div.className = "msg " + who;

    let filesHtml = "";
    if(Array.isArray(m.attachments) && m.attachments.length){
      filesHtml = `<div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">` +
        m.attachments.map(a=>{
          const nm = escapeHtml(a.name || "file.pdf");
          const href = a.dataUrl ? a.dataUrl : "#";
          return `<a class="fileChip" href="${href}" target="_blank" rel="noopener">ğŸ“ ${nm}</a>`;
        }).join("") +
        `</div>`;
    }

    div.innerHTML = `
      <div>${escapeHtml(m.text || "")}</div>
      ${filesHtml}
      <div class="msgMeta">
        <span>${escapeHtml(m.fromRole === "counselor" ? "Ø´Ù…Ø§ (Ù…Ø´Ø§ÙˆØ±)" : "Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²")}</span>
        <span>${escapeHtml(new Date(m.createdAt).toLocaleString("fa-IR"))}</span>
      </div>
    `;
    list.appendChild(div);
  }
  list.scrollTop = list.scrollHeight;
}

function renderCounselorStudents(){
  const wrap = $("cStudentList");
  if(!wrap) return;

  wrap.innerHTML = "";
  counselorSelectedStudent = counselorSelectedStudent ? normUsername(counselorSelectedStudent) : null;

  if(!activeUser || activeUser.role!=="counselor"){
    wrap.innerHTML = `<div class="muted" style="font-weight:900;">ÙÙ‚Ø· Ù…Ø´Ø§ÙˆØ± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø±Ø§ Ø¨Ø¨ÛŒÙ†Ø¯.</div>`;
    $("cMsgList").innerHTML = `<div class="muted" style="font-weight:900;">â€”</div>`;
    return;
  }

  const code = (activeUser?.counselorCode || "").trim().toUpperCase();
  $("cCodeBadge").textContent = "Ú©Ø¯: " + (code || "â€”");

  const users = loadUsers();
  const myStudents = users.filter(u => (u.role==="student") && String(u.mentorCode||"").trim().toUpperCase() === code);

  if(myStudents.length===0){
    wrap.innerHTML = `<div class="muted" style="font-weight:900;">Ù‡Ù†ÙˆØ² Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ Ø¨Ø§ Ú©Ø¯ Ø´Ù…Ø§ ÙˆØµÙ„ Ù†Ø´Ø¯Ù‡.</div>`;
    $("cMsgList").innerHTML = `<div class="muted" style="font-weight:900;">ÛŒÚ© Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.</div>`;
    $("cSelectedStudent").textContent = "Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡";
    return;
  }

  for(const st of myStudents){
    const uName = normUsername(st.username);
    const el = document.createElement("div");
    el.className = "weekItem" + (counselorSelectedStudent===uName ? " active" : "");
    const displayName = (st.name||"").trim() || ("@" + uName);
    el.innerHTML = `
      <div style="min-width:0;">
        <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(displayName)}</div>
        <div class="muted" style="font-size:12px;">@${escapeHtml(uName)}</div>
      </div>
      <span class="badge">ğŸ’¬</span>
    `;
    el.onclick = () => {
      counselorSelectedStudent = uName;
      renderCounselorStudents();
      renderCounselorChat();
    };
    wrap.appendChild(el);
  }

  if(!counselorSelectedStudent){
    counselorSelectedStudent = normUsername(myStudents[0].username);
  }
  renderCounselorChat();
}

/* ===============================
   Charts
=============================== */
const charts = {};

function destroyChart(id){
  if(charts[id]){
    try{ charts[id].destroy(); }catch{}
    delete charts[id];
  }
}
function getCtx(id){
  const c = $(id);
  if(!c) return null;
  return c.getContext("2d");
}
function pickColor(i){ return palette[i % palette.length]; }

function baseOptions(){
  return {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: true, position: "bottom" },
      tooltip: { rtl: true }
    },
    scales: {
      x: { ticks: { color: "#9ca3af" }, grid: { color: "rgba(255,255,255,.06)" } },
      y: { ticks: { color: "#9ca3af" }, grid: { color: "rgba(255,255,255,.06)" } },
    }
  };
}

function buildWeekSeries(){
  if(!currentWeek || !state.weeks[currentWeek]) return null;
  const w = state.weeks[currentWeek];

  const studyMins = [];
  const tests = [];
  const tasksCount = [];
  const doneRate = [];
  const tagDiversity = [];

  const durations = []; // mins per task
  const scatter = []; // {x: studyHours, y: tests}

  for(const d of DAY_ORDER){
    const dt = computeDayTotals(w, d.key);
    studyMins.push(dt.studyMin);
    tests.push(dt.tests);
    tasksCount.push(dt.tasksCount);
    doneRate.push(dt.tasksCount ? Math.round((dt.doneCount/dt.tasksCount)*100) : 0);
    tagDiversity.push(dt.tags);

    // durations
    for(const t of w.days[d.key].tasks){
      durations.push(taskMinutes(t));
    }
    scatter.push({ x: +(dt.studyMin/60).toFixed(2), y: dt.tests });
  }

  const cumulativeStudy = [];
  const cumulativeTests = [];
  let accS=0, accT=0;
  for(let i=0;i<DAY_ORDER.length;i++){
    accS += studyMins[i]; accT += tests[i];
    cumulativeStudy.push(accS);
    cumulativeTests.push(accT);
  }

  const totalTasks = tasksCount.reduce((a,b)=>a+b,0);
  const avgMinPerTask = studyMins.map((m, i) => tasksCount[i] ? Math.round(m / tasksCount[i]) : 0);
  const testsPerHour = studyMins.map((m,i) => m ? +(tests[i] / (m/60)).toFixed(2) : 0);

  return {
    w,
    studyMins, tests, tasksCount, doneRate, tagDiversity,
    cumulativeStudy, cumulativeTests,
    avgMinPerTask,
    durations,
    scatter,
    testsPerHour,
    totalTasks
  };
}

function histogramBuckets(values, step=15){
  // step minutes
  if(!values.length) return { labels: [], counts: [] };
  const max = Math.max(...values);
  const bucketCount = Math.max(1, Math.ceil(max/step));
  const counts = Array(bucketCount).fill(0);
  for(const v of values){
    const idx = Math.min(bucketCount-1, Math.floor(v/step));
    counts[idx]++;
  }
  const labels = counts.map((_,i)=>{
    const a = i*step;
    const b = (i+1)*step;
    return `${a}-${b}`;
  });
  return { labels, counts };
}

function stackedByTag(w, metric){ // metric: "study"|"tests"
  const tagsSet = new Map(); // tag -> index
  const norm = (s)=> (String(s||"").trim() || "Ø¨Ø¯ÙˆÙ† Ø¨Ø±Ú†Ø³Ø¨");
  for(const d of DAY_ORDER){
    for(const t of w.days[d.key].tasks){
      const tg = norm(t.tag);
      if(!tagsSet.has(tg)) tagsSet.set(tg, tagsSet.size);
    }
  }
  for(const t of w.weeklyTasks){
    const tg = norm(t.tag);
    if(!tagsSet.has(tg)) tagsSet.set(tg, tagsSet.size);
  }
  const tags = Array.from(tagsSet.keys());

  const dataByTag = tags.map(()=> Array(DAY_ORDER.length).fill(0));
  for(let di=0; di<DAY_ORDER.length; di++){
    const dk = DAY_ORDER[di].key;
    for(const t of w.days[dk].tasks){
      const tg = norm(t.tag);
      const ti = tagsSet.get(tg);
      if(metric==="study") dataByTag[ti][di] += taskMinutes(t);
      else dataByTag[ti][di] += clampInt(t.tests,0,999999);
    }
  }

  const datasets = tags.map((tag, i)=>({
    label: tag,
    data: dataByTag[i].map(v => metric==="study" ? Math.round(v/60*10)/10 : v),
    backgroundColor: pickColor(i),
    borderColor: pickColor(i),
    borderWidth: 1
  }));

  return { tags, datasets };
}

function updateCharts(forceRebuild=false){
  // Ø§Ú¯Ø± Chart.js Ù‡Ù†ÙˆØ² Ù†ÛŒØ§Ù…Ø¯Ù‡ØŒ Ø®Ø·Ø§ Ù†Ø¯Ù‡
  if(typeof Chart === "undefined"){ return; }

  const series = buildWeekSeries();

  // KPI Ù‡Ø§ÛŒ Ù‡Ø¯Ù
  const gs = clampInt(state.settings.goalStudyMin,0,9999999);
  const gt = clampInt(state.settings.goalTests,0,999999999);
  if(series){
    const totals = computeWeekTotals(series.w);
    $("goalStudyKpi").textContent = gs ? `${Math.min(100, Math.round((totals.studyMin/gs)*100))}%` : "Ù‡Ø¯Ù ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡";
    $("goalTestsKpi").textContent = gt ? `${Math.min(100, Math.round((totals.tests/gt)*100))}%` : "Ù‡Ø¯Ù ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡";
    $("comboKpi").textContent = `ğŸ“š ${formatHours(totals.studyMin)} â€¢ ğŸ§ª ${totals.tests}`;
    $("dailyStudyKpi").textContent = `Ø¬Ù…Ø¹: ${formatHours(totals.studyMin)}`;
    $("dailyTestsKpi").textContent = `Ø¬Ù…Ø¹: ${totals.tests}`;
    $("tagPieKpi").textContent = `Top ${state.settings.topTagsN||8}`;
    $("tagTestsDonutKpi").textContent = `Top ${state.settings.topTagsN||8}`;
  }else{
    $("goalStudyKpi").textContent = "â€”";
    $("goalTestsKpi").textContent = "â€”";
    $("comboKpi").textContent = "â€”";
    $("dailyStudyKpi").textContent = "â€”";
    $("dailyTestsKpi").textContent = "â€”";
    $("tagPieKpi").textContent = "â€”";
    $("tagTestsDonutKpi").textContent = "â€”";
  }

  // helper to rebuild or update
  function makeOrUpdate(id, type, data, options){
    const ctx = getCtx(id);
    if(!ctx) return;
    if(forceRebuild) destroyChart(id);
    if(!charts[id]){
      charts[id] = new Chart(ctx, { type, data, options });
    }else{
      charts[id].data = data;
      charts[id].options = options;
      charts[id].update();
    }
  }

  // if no week selected -> show empty friendly charts
  const empty = {
    labels: DAY_LABELS,
    studyHours: DAY_LABELS.map(()=>0),
    tests: DAY_LABELS.map(()=>0),
  };

  const labels = series ? DAY_LABELS : empty.labels;

  // Goal donuts
  {
    const totals = series ? computeWeekTotals(series.w) : { studyMin:0, tests:0 };
    const done = totals.studyMin;
    const remain = Math.max(0, gs - done);
    makeOrUpdate("goalStudyDonut","doughnut",{
      labels:["Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡ (Ø¯Ù‚ÛŒÙ‚Ù‡)","Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ (Ø¯Ù‚ÛŒÙ‚Ù‡)"],
      datasets:[{ data:[done, remain], backgroundColor:[pickColor(1), "rgba(255,255,255,.12)"] }]
    },{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ position:"bottom" } }
    });
  }
  {
    const totals = series ? computeWeekTotals(series.w) : { studyMin:0, tests:0 };
    const done = totals.tests;
    const remain = Math.max(0, gt - done);
    makeOrUpdate("goalTestsDonut","doughnut",{
      labels:["Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡","Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡"],
      datasets:[{ data:[done, remain], backgroundColor:[pickColor(0), "rgba(255,255,255,.12)"] }]
    },{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ position:"bottom" } }
    });
  }

  // combo: bar (study hours) + line (tests)
  {
    const studyH = series ? series.studyMins.map(m=>+(m/60).toFixed(2)) : empty.studyHours;
    const tests = series ? series.tests : empty.tests;

    makeOrUpdate("comboDailyChart","bar",{
      labels,
      datasets:[
        { label:"Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡", type:"bar", data: studyH, backgroundColor: pickColor(2) },
        { label:"ØªØ³Øª", type:"line", data: tests, borderColor: pickColor(0), backgroundColor: pickColor(0), tension:.3, yAxisID:"y1" }
      ]
    },{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ position:"bottom" } },
      scales:{
        y:{ beginAtZero:true },
        y1:{ beginAtZero:true, position:"right", grid:{ drawOnChartArea:false } }
      }
    });
  }

  // daily study
  {
    const studyH = series ? series.studyMins.map(m=>+(m/60).toFixed(2)) : empty.studyHours;
    makeOrUpdate("dailyStudyChart","line",{
      labels,
      datasets:[{ label:"Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡", data: studyH, borderColor: pickColor(3), backgroundColor: pickColor(3), tension:.3 }]
    }, { ...baseOptions(), scales:{ ...baseOptions().scales, y:{ beginAtZero:true } }});
  }

  // daily tests
  {
    const tests = series ? series.tests : empty.tests;
    makeOrUpdate("dailyTestsChart","line",{
      labels,
      datasets:[{ label:"ØªØ³Øª", data: tests, borderColor: pickColor(0), backgroundColor: pickColor(0), tension:.3 }]
    }, { ...baseOptions(), scales:{ ...baseOptions().scales, y:{ beginAtZero:true } }});
  }

  // Tag pie (study)
  {
    const topN = clampInt(state.settings.topTagsN, 3, 30);
    let tagLabels = ["â€”"];
    let tagData = [1];

    if(series){
      const ag = computeTagAggregatesForWeek(series.w);
      const top = ag.entriesStudy.slice(0, topN);
      tagLabels = top.map(x=>x[0]);
      tagData = top.map(x=>x[1]); // mins
      if(tagLabels.length===0){ tagLabels=["â€”"]; tagData=[1]; }
    }
    makeOrUpdate("tagPieChart","pie",{
      labels: tagLabels,
      datasets:[{
        data: tagData,
        backgroundColor: tagLabels.map((_,i)=>pickColor(i))
      }]
    },{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ position:"bottom" } }
    });
  }

  // Tag tests donut
  {
    const topN = clampInt(state.settings.topTagsN, 3, 30);
    let tagLabels = ["â€”"];
    let tagData = [1];

    if(series){
      const ag = computeTagAggregatesForWeek(series.w);
      const top = ag.entriesTests.slice(0, topN);
      tagLabels = top.map(x=>x[0]);
      tagData = top.map(x=>x[1]);
      if(tagLabels.length===0){ tagLabels=["â€”"]; tagData=[1]; }
    }
    makeOrUpdate("tagTestsDonut","doughnut",{
      labels: tagLabels,
      datasets:[{
        data: tagData,
        backgroundColor: tagLabels.map((_,i)=>pickColor(i))
      }]
    },{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ position:"bottom" } }
    });
  }

  // day share study donut
  {
    const studyM = series ? series.studyMins : DAY_LABELS.map(()=>0);
    makeOrUpdate("dayShareStudyDonut","doughnut",{
      labels,
      datasets:[{ data: studyM, backgroundColor: labels.map((_,i)=>pickColor(i)) }]
    },{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ position:"bottom" } }
    });
  }

  // tasks per day bar
  {
    const vals = series ? series.tasksCount : DAY_LABELS.map(()=>0);
    makeOrUpdate("tasksPerDayBar","bar",{
      labels,
      datasets:[{ label:"ØªØ¹Ø¯Ø§Ø¯ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§", data: vals, backgroundColor: pickColor(6) }]
    }, { ...baseOptions(), scales:{ ...baseOptions().scales, y:{ beginAtZero:true } }});
  }

  // done rate line
  {
    const vals = series ? series.doneRate : DAY_LABELS.map(()=>0);
    makeOrUpdate("doneRateLine","line",{
      labels,
      datasets:[{ label:"Ø¯Ø±ØµØ¯ Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù†", data: vals, borderColor: pickColor(2), backgroundColor: pickColor(2), tension:.3 }]
    }, { ...baseOptions(), scales:{ ...baseOptions().scales, y:{ beginAtZero:true, max:100 } }});
  }

  // avg minutes per task
  {
    const vals = series ? series.avgMinPerTask : DAY_LABELS.map(()=>0);
    makeOrUpdate("avgMinPerTaskLine","line",{
      labels,
      datasets:[{ label:"Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ù‚ÛŒÙ‚Ù‡", data: vals, borderColor: pickColor(7), backgroundColor: pickColor(7), tension:.3 }]
    }, { ...baseOptions(), scales:{ ...baseOptions().scales, y:{ beginAtZero:true } }});
  }

  // cumulative study area (line with fill)
  {
    const vals = series ? series.cumulativeStudy.map(m=>+(m/60).toFixed(2)) : DAY_LABELS.map(()=>0);
    makeOrUpdate("cumulativeStudyLine","line",{
      labels,
      datasets:[{ label:"ØªØ¬Ù…Ø¹ÛŒ Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡", data: vals, borderColor: pickColor(3), backgroundColor: pickColor(3), tension:.25, fill:true }]
    }, { ...baseOptions(), scales:{ ...baseOptions().scales, y:{ beginAtZero:true } }});
  }

  // cumulative tests area
  {
    const vals = series ? series.cumulativeTests : DAY_LABELS.map(()=>0);
    makeOrUpdate("cumulativeTestsLine","line",{
      labels,
      datasets:[{ label:"ØªØ¬Ù…Ø¹ÛŒ ØªØ³Øª", data: vals, borderColor: pickColor(0), backgroundColor: pickColor(0), tension:.25, fill:true }]
    }, { ...baseOptions(), scales:{ ...baseOptions().scales, y:{ beginAtZero:true } }});
  }

  // scatter study vs tests
  {
    const pts = series ? series.scatter : DAY_LABELS.map(()=>({x:0,y:0}));
    makeOrUpdate("studyVsTestsScatter","scatter",{
      datasets:[{
        label:"Ø±ÙˆØ²Ù‡Ø§",
        data: pts,
        backgroundColor: pickColor(9),
        borderColor: pickColor(9)
      }]
    },{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ position:"bottom" } },
      scales:{
        x:{ beginAtZero:true, title:{ display:true, text:"Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡" } },
        y:{ beginAtZero:true, title:{ display:true, text:"ØªØ³Øª" } }
      }
    });
  }

  // tag diversity line
  {
    const vals = series ? series.tagDiversity : DAY_LABELS.map(()=>0);
    makeOrUpdate("tagDiversityLine","line",{
      labels,
      datasets:[{ label:"ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø±Ú†Ø³Ø¨ ÛŒÚ©ØªØ§", data: vals, borderColor: pickColor(10), backgroundColor: pickColor(10), tension:.3 }]
    }, { ...baseOptions(), scales:{ ...baseOptions().scales, y:{ beginAtZero:true } }});
  }

  // duration histogram (bar)
  {
    const vals = series ? series.durations : [];
    const h = histogramBuckets(vals, 15);
    makeOrUpdate("durationHistogramBar","bar",{
      labels: h.labels.length ? h.labels : ["â€”"],
      datasets:[{ label:"ØªØ¹Ø¯Ø§Ø¯ Ø¢ÛŒØªÙ…", data: h.counts.length ? h.counts : [0], backgroundColor: pickColor(11) }]
    }, { ...baseOptions(), scales:{ ...baseOptions().scales, y:{ beginAtZero:true } }});
  }

  // tests per hour bar
  {
    const vals = series ? series.testsPerHour : DAY_LABELS.map(()=>0);
    makeOrUpdate("testsPerHourBar","bar",{
      labels,
      datasets:[{ label:"ØªØ³Øª/Ø³Ø§Ø¹Øª", data: vals, backgroundColor: pickColor(0) }]
    }, { ...baseOptions(), scales:{ ...baseOptions().scales, y:{ beginAtZero:true } }});
  }

  // stacked study by tag
  {
    if(series){
      const s = stackedByTag(series.w, "study");
      makeOrUpdate("stackedStudyByTag","bar",{
        labels,
        datasets: s.datasets
      },{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{ position:"bottom" } },
        scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } }
      });
    }else{
      makeOrUpdate("stackedStudyByTag","bar",{
        labels,
        datasets:[{ label:"â€”", data: labels.map(()=>0), backgroundColor:"rgba(255,255,255,.12)" }]
      },{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{ position:"bottom" } },
        scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } }
      });
    }
  }

  // stacked tests by tag
  {
    if(series){
      const s = stackedByTag(series.w, "tests");
      makeOrUpdate("stackedTestsByTag","bar",{
        labels,
        datasets: s.datasets
      },{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{ position:"bottom" } },
        scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } }
      });
    }else{
      makeOrUpdate("stackedTestsByTag","bar",{
        labels,
        datasets:[{ label:"â€”", data: labels.map(()=>0), backgroundColor:"rgba(255,255,255,.12)" }]
      },{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{ position:"bottom" } },
        scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } }
      });
    }
  }

  // radar study days
  {
    const vals = series ? series.studyMins.map(m=>+(m/60).toFixed(2)) : labels.map(()=>0);
    makeOrUpdate("radarStudyDays","radar",{
      labels,
      datasets:[{ label:"Ø³Ø§Ø¹Øª Ù…Ø·Ø§Ù„Ø¹Ù‡", data: vals, borderColor: pickColor(3), backgroundColor: "rgba(124,58,237,.18)" }]
    },{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ position:"bottom" } },
      scales:{ r:{ beginAtZero:true } }
    });
  }

  // radar tests days
  {
    const vals = series ? series.tests : labels.map(()=>0);
    makeOrUpdate("radarTestsDays","radar",{
      labels,
      datasets:[{ label:"ØªØ³Øª", data: vals, borderColor: pickColor(0), backgroundColor: "rgba(6,182,212,.18)" }]
    },{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ position:"bottom" } },
      scales:{ r:{ beginAtZero:true } }
    });
  }
}

/* ===============================
   Ú†Ø§Ù¾/Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø²Ø§Ø±Ø´
=============================== */
function buildPrintReportHTML({downloadMode=false}){
  if(!activeUser || activeUser.role!=="student") return "";
  if(!currentWeek || !state.weeks[currentWeek]) return "";

  const w = state.weeks[currentWeek];
  const totals = computeWeekTotals(w);

  // try to capture a few charts
  const chartIds = [
    "comboDailyChart",
    "dailyStudyChart",
    "dailyTestsChart",
    "tagPieChart",
    "tagTestsDonut"
  ];
  const imgs = [];
  for(const id of chartIds){
    const c = $(id);
    if(c && c.toDataURL){
      try{ imgs.push({ id, data: c.toDataURL("image/png") }); }catch{}
    }
  }

  const dayRows = DAY_ORDER.map(d=>{
    const dt = computeDayTotals(w, d.key);
    return `
      <tr>
        <td>${escapeHtml(d.name)}</td>
        <td>${escapeHtml(formatHours(dt.studyMin))}</td>
        <td>${dt.tests}</td>
        <td>${dt.tasksCount}</td>
        <td>${dt.tasksCount ? Math.round((dt.doneCount/dt.tasksCount)*100) : 0}%</td>
      </tr>
    `;
  }).join("");

  const weeklyTasks = (w.weeklyTasks||[]).map(t=>`
    <li>
      <b>${escapeHtml(t.text||"")}</b>
      ${t.tag ? ` <span style="opacity:.8">(${escapeHtml(t.tag)})</span>` : ""}
      â€” Ù…Ø·Ø§Ù„Ø¹Ù‡: ${escapeHtml(formatHours(taskMinutes(t)))} â€” ØªØ³Øª: ${clampInt(t.tests,0,999999)} â€” ${t.done ? "âœ…" : "â¬œï¸"}
      ${t.notes ? `<div style="opacity:.85; margin-top:4px;">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª: ${escapeHtml(t.notes)}</div>` : ""}
    </li>
  `).join("");

  const html = `<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ú¯Ø²Ø§Ø±Ø´ ${escapeHtml(currentWeek)}</title>
<style>
  body{ font-family: Vazirmatn, system-ui, Arial; margin:16px; }
  h1{ margin:0 0 8px; font-size:18px; }
  .muted{ opacity:.75; }
  .kpi{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0; }
  .chip{ border:1px solid #ddd; border-radius:999px; padding:6px 10px; font-weight:900; }
  table{ width:100%; border-collapse:collapse; margin-top:10px; }
  th,td{ border:1px solid #ddd; padding:8px; text-align:right; font-size:13px; }
  th{ background:#f6f6f6; }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  img{ width:100%; border:1px solid #eee; border-radius:10px; }
  @media print{ .noPrint{ display:none; } }
</style>
</head>
<body>
  <div class="noPrint" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
    <button onclick="window.print()">Ú†Ø§Ù¾</button>
    ${downloadMode ? "" : "<span class='muted'>Ø§Ú¯Ø± Ù¾Ù†Ø¬Ø±Ù‡ Ú†Ø§Ù¾ Ø¨Ø§Ø² Ù†Ø´Ø¯ØŒ Pop-up Ø±Ø§ Ø§Ø¬Ø§Ø²Ù‡ Ø¨Ø¯Ù‡.</span>"}
  </div>

  <h1>Ú¯Ø²Ø§Ø±Ø´ Ù‡ÙØªÙ‡: ${escapeHtml(weekLabel(currentWeek))}</h1>
  <div class="muted">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²: @${escapeHtml(activeUser.username)} â€” ØªØ§Ø±ÛŒØ® ØªÙˆÙ„ÛŒØ¯: ${escapeHtml(new Date().toLocaleString("fa-IR"))}</div>

  <div class="kpi">
    <div class="chip">ğŸ“š ${escapeHtml(formatHours(totals.studyMin))}</div>
    <div class="chip">ğŸ§ª ${totals.tests}</div>
    <div class="chip">ğŸ·ï¸ ${totals.tags}</div>
    <div class="chip">âœ… ${totals.tasksCount ? Math.round((totals.doneCount/totals.tasksCount)*100) : 0}%</div>
  </div>

  <h3>Ø®Ù„Ø§ØµÙ‡/ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ù‡ÙØªÙ‡</h3>
  <div>${escapeHtml((w.summary||"").trim() || "â€”")}</div>

  <h3 style="margin-top:14px;">Ø¬Ø¯ÙˆÙ„ Ø±ÙˆØ²Ù‡Ø§</h3>
  <table>
    <thead>
      <tr>
        <th>Ø±ÙˆØ²</th>
        <th>Ù…Ø·Ø§Ù„Ø¹Ù‡</th>
        <th>ØªØ³Øª</th>
        <th>ØªØ¹Ø¯Ø§Ø¯ Ø¢ÛŒØªÙ…</th>
        <th>Ù†Ø±Ø® Ø§Ù†Ø¬Ø§Ù…</th>
      </tr>
    </thead>
    <tbody>${dayRows}</tbody>
  </table>

  <h3 style="margin-top:14px;">ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ Ù‡ÙØªÚ¯ÛŒ</h3>
  <ul>
    ${weeklyTasks || "<li>â€”</li>"}
  </ul>

  <h3 style="margin-top:14px;">Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§</h3>
  <div class="grid">
    ${imgs.map(x=>`<div><img alt="${escapeHtml(x.id)}" src="${x.data}"/></div>`).join("") || "<div class='muted'>Ù†Ù…ÙˆØ¯Ø§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÛŒØ³Øª.</div>"}
  </div>

</body>
</html>`;
  return html;
}

function openPrintReport(){
  try{
    flushAll();
    updateCharts(false);
    setTimeout(()=>{
      const html = buildPrintReportHTML({downloadMode:false});
      if(!html) return toast("Ø¨Ø±Ø§ÛŒ Ú†Ø§Ù¾: Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø´Ùˆ Ùˆ ÛŒÚ© Ù‡ÙØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†");
      const win = window.open("", "_blank");
      if(!win) return toast("Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø¨Ù„Ø§Ú© Ø´Ø¯Ù‡Ø› Ø§Ø¬Ø§Ø²Ù‡ Ø¨Ø¯Ù‡ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø²Ù†");
      win.document.open();
      win.document.write(html);
      win.document.close();
    }, 200);
  }catch{
    toast("Ù…Ø´Ú©Ù„ Ø¯Ø± Ø³Ø§Ø®Øª Ú¯Ø²Ø§Ø±Ø´ Ú†Ø§Ù¾");
  }
}
function downloadPrintReportHTML(){
  try{
    flushAll();
    updateCharts(false);
    setTimeout(()=>{
      const html = buildPrintReportHTML({downloadMode:true});
      if(!html) return toast("Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ HTML: Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø´Ùˆ Ùˆ ÛŒÚ© Ù‡ÙØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†");
      const blob = new Blob([html], {type:"text/html;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const wk = currentWeek || "week";
      a.href = url;
      a.download = `print-report-${wk}.html`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Ú¯Ø²Ø§Ø±Ø´ HTML Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯ âœ…");
    }, 200);
  }catch{
    toast("Ù…Ø´Ú©Ù„ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´");
  }
}

/* ===============================
   Ø®Ø±ÙˆØ¬ÛŒ/ÙˆØ±ÙˆØ¯ÛŒ JSON
=============================== */
function exportJSON(){
  try{
    flushAll();
    const payload = { version: 1, exportedAt: nowISO(), user: activeUser?.username || "", role: activeUser?.role || "", state };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `export-${activeUser?.username || "user"}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast("Ø®Ø±ÙˆØ¬ÛŒ JSON Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯ âœ…");
  }catch{
    toast("Ù…Ø´Ú©Ù„ Ø¯Ø± Ø®Ø±ÙˆØ¬ÛŒ JSON");
  }
}
function importJSONFile(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(String(reader.result||"{}"));
      if(!obj || typeof obj !== "object") throw new Error("bad");
      if(!obj.state) throw new Error("no state");
      state = normalizeAllStateInPlace(obj.state);
      persist();
      renderWeeksList("");
      renderTagBank();
      refreshAllTagSelects();
      const wk = state.lastWeek || sortWeeksDesc(Object.keys(state.weeks||{}))[0] || "";
      currentWeek = wk || "";
      if(currentWeek) selectWeek(currentWeek);
      updateEverything(true);
      toast("ÙˆØ±ÙˆØ¯ÛŒ JSON Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯ âœ…");
    }catch{
      toast("ÙØ§ÛŒÙ„ JSON Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª");
    }
  };
  reader.readAsText(file);
}

/* ===============================
   Ø°Ø®ÛŒØ±Ù‡/Ø±ÛŒØ³Øª
=============================== */
function hardReset(){
  if(!confirm("Ù‡Ù…Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ù…ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ")) return;
  localStorage.removeItem(STORAGE_KEY);
  state = normalizeAllStateInPlace({ theme:"dark", weeks:{}, tagBank:[], weeklyTrendMode:"study", settings:{ topTagsN:8, goalStudyMin:0, goalTests:0 }, lastWeek:"" });
  currentWeek = "";
  currentDayKey = "sat";
  renderWeeksList("");
  renderTagBank();
  refreshAllTagSelects();
  updateEverything(true);
  toast("Ø±ÛŒØ³Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯");
}

/* ===============================
   Theme
=============================== */
function applyTheme(){
  const app = $("app");
  if(!app) return;
  app.dataset.theme = state.theme || "dark";
}
function toggleTheme(){
  state.theme = (state.theme === "dark") ? "light" : "dark";
  persist();
  applyTheme();
  toast("ØªÙ… ØªØºÛŒÛŒØ± Ú©Ø±Ø¯");
}

/* ===============================
   Ø³Ø§Ø¹Øª
=============================== */
function tickClock(){
  const d = new Date();
  $("clockTime").textContent = d.toLocaleTimeString("fa-IR");
  $("clockDate").textContent = d.toLocaleDateString("fa-IR", { year:"numeric", month:"long", day:"numeric" });
}

/* ===============================
   Ø«Ø¨Øª Ø¯Ø±Ø³/Ú©Ø§Ø±
=============================== */
function addLessonToday(){
  if(!currentWeek || !state.weeks[currentWeek]) return toast("Ø§ÙˆÙ„ ÛŒÚ© Ù‡ÙØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†");
  const w = state.weeks[currentWeek];
  const d = w.days[currentDayKey];

  const title = ($("lessonTitle").value || "").trim();
  if(!title) return toast("Ø¹Ù†ÙˆØ§Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†");

  const t = {
    id: safeUUID(),
    text: title,
    done: false,
    tag: $("lessonTag").value || "",
    hours: clampInt($("lessonHours").value,0,9999),
    minutes: clampInt($("lessonMinutes").value,0,59),
    tests: clampInt($("lessonTests").value,0,999999),
    notes: $("lessonNotes").value || "",
    createdAt: nowISO(),
    updatedAt: nowISO(),
  };
  normalizeTaskInPlace(t);
  d.tasks.push(t);

  w.updatedAt = nowISO();
  addTagsToBank([t.tag]);
  persist();

  $("lessonTitle").value = "";
  $("lessonHours").value = "0";
  $("lessonMinutes").value = "0";
  $("lessonTests").value = "0";
  $("lessonNotes").value = "";

  renderDailyTasks();
  updateEverything(true);
  renderWeeksList($("searchBox")?.value || "");
  toast("Ø«Ø¨Øª Ø´Ø¯ âœ…");
}

/* ===============================
   Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ UI
=============================== */
function bindUI(){
  // drawer
  $("menuBtn").onclick = openDrawer;
  $("drawerCloseBtn").onclick = closeDrawer;
  $("drawerOverlay").onclick = closeDrawer;

  // theme
  $("themeBtn").onclick = () => toggleTheme();

  // nav
  $("navDashboard").onclick = () => showView("dashboard");
  $("navWeekly").onclick = () => showView("weekly");
  $("navDaily").onclick = () => showView("daily");
  $("navTags").onclick = () => showView("tags");
  $("navMessages").onclick = () => showView("messages");
  $("navCounselor").onclick = () => showView("counselor");

  // search
  $("searchBox").oninput = () => renderWeeksList($("searchBox").value || "");

  // week picker + new week
  $("weekPicker").onchange = () => {
    const wk = $("weekPicker").value || "";
    if(!wk) return;
    createWeek(wk);
  };
  $("newWeekBtn").onclick = () => {
    const wk = $("weekPicker").value || getDefaultWeek();
    createWeek(wk);
  };
  $("deleteWeekBtn").onclick = () => deleteCurrentWeek();

  // weekly task add
  $("addWeeklyTask").onclick = () => {
    if(!currentWeek || !state.weeks[currentWeek]) return toast("Ø§ÙˆÙ„ ÛŒÚ© Ù‡ÙØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†");
    const w = state.weeks[currentWeek];
    w.weeklyTasks.push(normalizeTaskInPlace({ id:safeUUID(), text:"", done:false, tag:"", hours:0, minutes:0, tests:0, notes:"" }));
    w.updatedAt = nowISO();
    persist();
    renderWeeklyTasks();
    updateEverything(true);
    renderWeeksList($("searchBox")?.value || "");
    toast("ØªØ³Ú© Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯");
  };

  // weekly fields autosave
  const weekFields = ["weekTitle","weekTags","weekSummary","weekAchievements","weekBlockers","weekNext"];
  weekFields.forEach(id=>{
    $(id).oninput = () => {
      if(!currentWeek) return;
      setDirty(true);
      flushAll();
      updateEverything(true);
      renderWeeksList($("searchBox")?.value || "");
    };
  });

  // daily fields autosave
  $("dayFocus").oninput = () => { setDirty(true); flushAll(); updateEverything(true); };
  $("dayNote").oninput  = () => { setDirty(true); flushAll(); updateEverything(true); };

  // add lesson
  $("addLessonBtn").onclick = () => addLessonToday();

  // tag bank
  $("tagBankAddBtn").onclick = () => {
    const txt = $("tagBankInput").value || "";
    const tags = normalizeTags(txt);
    if(!tags.length) return toast("Ú†ÛŒØ²ÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡");
    addTagsToBank(tags);
    $("tagBankInput").value = "";
    persist();
    renderTagBank();
    refreshAllTagSelects();
    toast("Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ âœ…");
  };
  $("tagBankClearBtn").onclick = () => {
    if(!confirm("Ú©Ù„ Ø¨Ø§Ù†Ú© Ø¨Ø±Ú†Ø³Ø¨ Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ")) return;
    state.tagBank = [];
    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ Ø¯Ø± ØªØ³Ú©â€ŒÙ‡Ø§
    for(const wk of Object.keys(state.weeks||{})){
      const w = state.weeks[wk];
      for(const t of w.weeklyTasks) t.tag = "";
      for(const d of DAY_ORDER){
        for(const t of w.days[d.key].tasks) t.tag = "";
      }
    }
    persist();
    renderTagBank();
    refreshAllTagSelects();
    updateEverything(true);
    toast("Ù¾Ø§Ú© Ø´Ø¯");
  };

  // settings
  $("topTagsN").oninput = () => {
    state.settings.topTagsN = clampInt($("topTagsN").value,3,30);
    persist(); updateCharts(false);
  };
  $("goalStudyHours").oninput = () => {
    const h = clampInt($("goalStudyHours").value,0,999999);
    state.settings.goalStudyMin = h * 60;
    persist(); updateEverything(true);
  };
  $("goalTests").oninput = () => {
    state.settings.goalTests = clampInt($("goalTests").value,0,999999999);
    persist(); updateEverything(true);
  };
  $("rebuildChartsBtn").onclick = () => updateCharts(true);

  // export/import/print/reset
  $("exportBtn").onclick = () => exportJSON();
  $("importFile").onchange = (e) => {
    const f = e.target.files && e.target.files[0];
    if(f) importJSONFile(f);
    e.target.value = "";
  };
  $("printBtn").onclick = () => openPrintReport();
  $("resetBtn").onclick = () => hardReset();

  // mentor code save/clear (student)
  $("mentorCodeSaveBtn").onclick = () => {
    if(!activeUser || activeUser.role!=="student") return;
    const code = ($("mentorCodeInput").value || "").trim().toUpperCase();
    activeUser.mentorCode = code;
    const users = loadUsers();
    const idx = users.findIndex(u => normUsername(u.username) === normUsername(activeUser.username));
    if(idx>=0){ users[idx].mentorCode = code; saveUsers(users); }
    toast("Ú©Ø¯ Ù…Ø´Ø§ÙˆØ± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…");
  };
  $("mentorCodeClearBtn").onclick = () => {
    if(!activeUser || activeUser.role!=="student") return;
    if(!confirm("Ø§Ø² Ø§ÛŒÙ† Ù…Ø´Ø§ÙˆØ±Ù‡ Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆÛŒØŸ")) return;
    activeUser.mentorCode = "";
    $("mentorCodeInput").value = "";
    const users = loadUsers();
    const idx = users.findIndex(u => normUsername(u.username) === normUsername(activeUser.username));
    if(idx>=0){ users[idx].mentorCode = ""; saveUsers(users); }
    toast("Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒ");
    renderStudentMessages();
  };

  // copy counselor code
  $("copyCounselorCodeBtn").onclick = async () => {
    const code = $("counselorCodeInput").value || "";
    try{
      await navigator.clipboard.writeText(code);
      toast("Ú©Ù¾ÛŒ Ø´Ø¯ âœ…");
    }catch{
      toast("Ú©Ù¾ÛŒ Ù†Ø´Ø¯ (Ø§Ø¬Ø§Ø²Ù‡ Ø¨Ø¯Ù‡)");
    }
  };

  // messages student send
  $("msgSendBtn").onclick = () => {
    if(!activeUser || activeUser.role!=="student") return;
    const mentorCode = (activeUser.mentorCode||"").trim().toUpperCase();
    if(!mentorCode) return toast("Ú©Ø¯ Ù…Ø´Ø§ÙˆØ± Ù†Ø¯Ø§Ø±ÛŒØ¯");
    const text = ($("msgText").value || "").trim();
    if(!text) return toast("Ù¾ÛŒØ§Ù… Ø®Ø§Ù„ÛŒ Ø§Ø³Øª");
    postMessage({
      counselorCode: mentorCode,
      studentUsername: activeUser.username,
      fromRole: "student",
      fromUser: activeUser.username,
      text,
      attachments:[]
    });
    $("msgText").value = "";
    renderStudentMessages();
  };
  $("msgText").addEventListener("keydown",(e)=>{
    if(e.key==="Enter"){ e.preventDefault(); $("msgSendBtn").click(); }
  });

  // counselor pdf attachment
  $("cPdfFile").onchange = async (e) => {
    const f = e.target.files && e.target.files[0];
    counselorPendingPdf = null;
    if(!f){ $("cPdfHint").textContent = "ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡"; return; }
    if(f.type !== "application/pdf"){ $("cPdfHint").textContent = "ÙÙ‚Ø· PDF"; e.target.value=""; return; }

    if(f.size > 6 * 1024 * 1024){ // 6MB
      $("cPdfHint").textContent = "ÙØ§ÛŒÙ„ Ø¨Ø²Ø±Ú¯ Ø§Ø³Øª (Ø­Ø¯Ø§Ú©Ø«Ø± 6MB)";
      e.target.value="";
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      counselorPendingPdf = { name: f.name, dataUrl: String(reader.result || "") };
      $("cPdfHint").textContent = "âœ… " + f.name;
    };
    reader.readAsDataURL(f);
  };

  // counselor send
  $("cSendBtn").onclick = () => {
    if(!activeUser || activeUser.role!=="counselor") return;
    const code = (activeUser.counselorCode||"").trim().toUpperCase();
    if(!counselorSelectedStudent) return toast("Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡");

    const text = ($("cMsgText").value || "").trim();
    if(!text && !counselorPendingPdf) return toast("Ù¾ÛŒØ§Ù… ÛŒØ§ Ù¾ÛŒÙˆØ³Øª Ù„Ø§Ø²Ù… Ø§Ø³Øª");

    postMessage({
      counselorCode: code,
      studentUsername: counselorSelectedStudent,
      fromRole: "counselor",
      fromUser: activeUser.username,
      text: text || "(Ù¾ÛŒÙˆØ³Øª)",
      attachments: counselorPendingPdf ? [counselorPendingPdf] : []
    });

    $("cMsgText").value = "";
    counselorPendingPdf = null;
    $("cPdfFile").value = "";
    $("cPdfHint").textContent = "ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡";

    renderCounselorChat();
  };
  $("cMsgText").addEventListener("keydown",(e)=>{
    if(e.key==="Enter"){ e.preventDefault(); $("cSendBtn").click(); }
  });

  // logout
  $("logoutBtn").onclick = () => {
    flushAll();
    activeUser = null;
    clearSession();
    openAuth();
    toast("Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒ");
  };
}

/* ===============================
   Auth flow
=============================== */
async function doAuthContinue(){
  const username = normUsername($("authUsername").value || "");
  const name = ($("authName").value || "").trim();
  const pw = $("authPassword").value || "";
  const pw2 = $("authPassword2").value || "";

  if(!username) return ($("authMsg").textContent = "Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù„Ø§Ø²Ù… Ø§Ø³Øª.");
  if(pw.length < 3) return ($("authMsg").textContent = "Ø±Ù…Ø² Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û³ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯.");

  if(authMode==="signup"){
    if(pw !== pw2) return ($("authMsg").textContent = "Ø±Ù…Ø² Ùˆ ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² ÛŒÚ©ÛŒ Ù†ÛŒØ³Øª.");
    const exists = findUser(username);
    if(exists) return ($("authMsg").textContent = "Ø§ÛŒÙ† Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡.");

    const passHash = await hashPassword(pw);
    const user = { username, name, role: authRole, passHash };

    if(authRole==="counselor"){
      user.counselorCode = genCounselorCode();
    }else{
      user.mentorCode = (String($("authMentorCode").value||"").trim().toUpperCase());
    }

    const users = loadUsers();
    users.push(user);
    saveUsers(users);
    saveSession(username);

    // set active
    activeUser = { username, name, role: user.role, mentorCode: user.mentorCode || "", counselorCode: user.counselorCode || "" };
    afterLogin();

    $("authMsg").textContent = "Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ âœ…";
    toast("Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚ âœ…");
    return;
  }

  // login
  const u = findUser(username);
  if(!u) return ($("authMsg").textContent = "Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.");
  const passHash = await hashPassword(pw);
  if(passHash !== u.passHash) return ($("authMsg").textContent = "Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.");

  saveSession(username);
  activeUser = { username: u.username, name: u.name||"", role: u.role, mentorCode: u.mentorCode||"", counselorCode: u.counselorCode||"" };
  afterLogin();
  toast("ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ âœ…");
}

function afterLogin(){
  // bind per-user storage
  STORAGE_KEY = userStateKey(activeUser.username);
  state = loadState();
  applyTheme();

  // sync settings fields
  $("topTagsN").value = String(clampInt(state.settings.topTagsN,3,30));
  $("goalStudyHours").value = String(Math.floor(clampInt(state.settings.goalStudyMin,0,9999999) / 60));
  $("goalTests").value = String(clampInt(state.settings.goalTests,0,999999999));

  // ensure default selects
  refreshAllTagSelects();

  // load last week or create default
  const keys = sortWeeksDesc(Object.keys(state.weeks||{}));
  const wk = state.lastWeek || keys[0] || "";
  if(wk){
    currentWeek = wk;
    ensureWeekInPlace(state, wk);
  }else{
    // start with default week
    currentWeek = getDefaultWeek();
    ensureWeekInPlace(state, currentWeek);
    state.lastWeek = currentWeek;
    persist();
  }

  // set week picker and select
  $("weekPicker").value = currentWeek;
  selectWeek(currentWeek);

  renderWeeksList("");
  renderTagBank();

  // hint
  $("studentStorageHint").textContent = `Ú©Ù„ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ: ${STORAGE_KEY}`;

  applyRoleUI();
  closeAuth();
}

/* ===============================
   Boot
=============================== */
function boot(){
  bindUI();
  setAuthMode("login");
  setAuthRole("student");

  // auth ui buttons
  $("authModeLogin").onclick = () => setAuthMode("login");
  $("authModeSignup").onclick = () => setAuthMode("signup");
  $("roleStudent").onclick = () => setAuthRole("student");
  $("roleCounselor").onclick = () => setAuthRole("counselor");
  $("authContinueBtn").onclick = () => doAuthContinue();

  // enter in auth
  ["authUsername","authPassword","authPassword2","authMentorCode","authName"].forEach(id=>{
    $(id).addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){ e.preventDefault(); $("authContinueBtn").click(); }
    });
  });

  // clock
  tickClock();
  setInterval(tickClock, 1000);

  // session auto-login
  const sess = loadSession();
  if(sess && sess.username){
    const u = findUser(sess.username);
    if(u){
      activeUser = { username: u.username, name: u.name||"", role: u.role, mentorCode: u.mentorCode||"", counselorCode: u.counselorCode||"" };
      afterLogin();
      return;
    }
  }
  openAuth();
}

boot();
</script>

</body>
</html>